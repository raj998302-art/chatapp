<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ChatApp</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#00a884">
<script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.1/dist/iife/sdk.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--g:#00a884;--g2:#025c4b;--bg:#111b21;--p:#202c33;--p2:#2a3942;--p3:#3b4a54;--t:#e9edef;--t2:#8696a0;--t3:#667781;--bd:#2a3942;--bo:#005c4b;--bi:#202c33;--bl:#53bdeb;--r:#f15c6d;--hv:#2a3942}
body{font-family:'Roboto',sans-serif;background:var(--bg);color:var(--t);height:100dvh;overflow:hidden}
.screen{position:fixed;inset:0;display:flex;flex-direction:column;background:var(--bg)}
.hidden{display:none!important}

/* WELCOME */
#welcome{background:var(--g);align-items:center;justify-content:center;gap:20px;padding:40px 24px}
.wlogo{width:110px;height:110px;background:rgba(255,255,255,0.15);border-radius:50%;display:flex;align-items:center;justify-content:center}
.wlogo svg{width:68px;height:68px;fill:#fff}
.wtitle{font-size:30px;font-weight:300;color:#fff;letter-spacing:0.5px}
.wsub{font-size:14px;color:rgba(255,255,255,0.85);text-align:center;max-width:280px;line-height:1.6}
.wbtn{background:#fff;color:var(--g);border:none;border-radius:28px;padding:14px 48px;font-size:16px;font-weight:600;cursor:pointer;font-family:'Roboto',sans-serif;margin-top:8px}
.wterms{color:rgba(255,255,255,0.6);font-size:12px;text-align:center;max-width:280px;line-height:1.6}

/* OTP */
.otp-hd{background:var(--g);width:100%;padding:20px 16px 56px;text-align:center;flex-shrink:0}
.otp-hd h2{color:#fff;font-size:20px;font-weight:500;margin-bottom:6px}
.otp-hd p{color:rgba(255,255,255,0.85);font-size:13px;line-height:1.5}
.otp-card{background:var(--p);border-radius:16px;margin:-36px 16px 0;padding:26px 20px;box-shadow:0 4px 20px rgba(0,0,0,0.4)}
.otp-cc{font-size:17px;color:var(--g);font-weight:500;white-space:nowrap}
.otp-row{display:flex;align-items:center;gap:10px;border-bottom:2px solid var(--g);padding-bottom:7px;margin-bottom:18px}
.otp-inp{flex:1;background:none;border:none;color:var(--t);font-size:18px;outline:none;font-family:'Roboto',sans-serif}
.otp-inp::placeholder{color:var(--t3)}
.otp-btn{width:100%;background:var(--g);color:#fff;border:none;border-radius:28px;padding:13px;font-size:15px;font-weight:600;cursor:pointer;font-family:'Roboto',sans-serif}
.otp-btn:disabled{opacity:0.6;cursor:not-allowed}
.otp-info{font-size:13px;color:var(--t2);text-align:center;line-height:1.6;margin-bottom:18px}
.demo-box{background:rgba(0,168,132,0.12);border:1px solid var(--g);border-radius:10px;padding:14px;margin:0 0 14px;text-align:center}
.demo-code{font-size:34px;font-weight:700;color:var(--g);letter-spacing:8px}
.demo-note{font-size:11px;color:var(--t2);margin-top:4px}
.otp-boxes{display:flex;gap:8px;justify-content:center;margin:16px 0}
.ob{width:44px;height:54px;border-radius:8px;border:2px solid var(--bd);background:var(--p2);text-align:center;font-size:24px;font-weight:700;color:var(--t);outline:none;font-family:'Roboto',sans-serif;transition:border-color 0.2s}
.ob:focus{border-color:var(--g)}
.resend-row{text-align:center;font-size:13px;color:var(--t2);margin-top:8px}
.resend-btn{color:var(--g);background:none;border:none;cursor:pointer;font-size:13px;font-family:'Roboto',sans-serif}
.name-av{width:86px;height:86px;border-radius:50%;background:var(--p2);display:flex;align-items:center;justify-content:center;font-size:34px;cursor:pointer;overflow:hidden;position:relative;margin:0 auto 14px}
.name-av img{width:100%;height:100%;object-fit:cover}
.name-av-edit{position:absolute;bottom:0;right:0;width:24px;height:24px;background:var(--g);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;border:2px solid var(--p)}

/* APP */
#app{flex-direction:row!important}
.sb{width:100%;display:flex;flex-direction:column;background:var(--bg);position:relative}
@media(max-width:768px){.sb.hide{transform:translateX(-100%);position:absolute;z-index:10;inset:0;transition:transform 0.25s}}
.cp{display:none;flex:1;flex-direction:column}
@media(min-width:769px){.cp{display:flex}}
@media(max-width:768px){.cp.show{display:flex;position:fixed;inset:0;z-index:10}}

/* SIDEBAR HEADER */
.shd{background:var(--p);height:58px;display:flex;align-items:center;justify-content:space-between;padding:0 14px;flex-shrink:0}
.shd-l{display:flex;align-items:center;gap:10px;cursor:pointer}
.stitle{font-size:20px;font-weight:600}
.hbts{display:flex}
.hbt{width:40px;height:40px;border-radius:50%;border:none;background:none;color:var(--t2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;flex-shrink:0}
.hbt:hover{background:var(--hv)}
.hbt svg{width:22px;height:22px;fill:currentColor}

/* SEARCH BAR */
.ssrch{padding:6px 12px;border-bottom:1px solid var(--bd);flex-shrink:0}
.ssrch-in{background:var(--p);border-radius:10px;display:flex;align-items:center;padding:8px 12px;gap:8px}
.ssrch-in svg{width:18px;height:18px;fill:var(--t3);flex-shrink:0}
.ssrch-in input{background:none;border:none;color:var(--t);font-size:14px;outline:none;width:100%;font-family:'Roboto',sans-serif}
.ssrch-in input::placeholder{color:var(--t3)}

/* PILLS */
.pills{display:flex;gap:8px;padding:7px 12px;overflow-x:auto;scrollbar-width:none;border-bottom:1px solid var(--bd);flex-shrink:0}
.pills::-webkit-scrollbar{display:none}
.pill{padding:6px 14px;border-radius:20px;background:var(--p2);color:var(--t2);font-size:13px;cursor:pointer;white-space:nowrap;border:none;font-family:'Roboto',sans-serif;flex-shrink:0;transition:all 0.2s}
.pill.on{background:var(--g2);color:var(--g)}

/* CHAT LIST */
.clist{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--p3) transparent}
.ci{display:flex;align-items:center;padding:10px 14px;gap:13px;cursor:pointer;min-height:70px;border-bottom:1px solid rgba(255,255,255,0.03);transition:background 0.1s}
.ci:hover,.ci.on{background:var(--hv)}
.cav{width:52px;height:52px;border-radius:50%;background:var(--p2);display:flex;align-items:center;justify-content:center;font-size:21px;flex-shrink:0;overflow:hidden;position:relative}
.cav img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.od{position:absolute;bottom:2px;right:2px;width:13px;height:13px;border-radius:50%;background:var(--g);border:2px solid var(--bg)}
.cbody{flex:1;min-width:0}
.ctop{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.cname{font-size:16px;color:var(--t);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;padding-right:6px}
.ctime{font-size:12px;color:var(--t3);white-space:nowrap}
.cbot{display:flex;align-items:center;gap:5px}
.clast{font-size:14px;color:var(--t2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
.cbadge{background:var(--g);color:#fff;border-radius:50%;min-width:20px;height:20px;font-size:11px;font-weight:600;display:flex;align-items:center;justify-content:center;flex-shrink:0;padding:0 4px}
.lkico{font-size:13px;color:var(--t3)}
.lk-hd{display:flex;align-items:center;gap:10px;padding:10px 16px;background:var(--p);cursor:pointer;font-size:14px;color:var(--t2);border-bottom:1px solid var(--bd)}

/* BOTTOM NAV */
.bnav{display:flex;background:var(--p);border-top:1px solid var(--bd);flex-shrink:0}
.bni{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px 0 8px;cursor:pointer;color:var(--t2);gap:4px;transition:color 0.2s;position:relative}
.bni.on{color:var(--g)}
.bni svg{width:24px;height:24px;fill:currentColor}
.bni-lbl{font-size:11px;font-weight:500}

/* FAB */
.fab{position:absolute;bottom:76px;right:16px;width:56px;height:56px;border-radius:50%;background:var(--g);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,168,132,0.45);z-index:5;transition:transform 0.15s}
.fab:active{transform:scale(0.92)}
.fab svg{width:26px;height:26px;fill:#fff}
.fab-menu{position:absolute;bottom:142px;right:16px;display:flex;flex-direction:column;gap:14px;z-index:5;pointer-events:none;opacity:0;transition:opacity 0.2s,transform 0.2s;transform:translateY(16px)}
.fab-menu.open{pointer-events:all;opacity:1;transform:translateY(0)}
.fmi{display:flex;align-items:center;gap:12px;justify-content:flex-end}
.fml{background:var(--p);color:var(--t);font-size:13px;padding:6px 12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.3);white-space:nowrap}
.fmb{width:44px;height:44px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 2px 8px rgba(0,0,0,0.3);flex-shrink:0}

/* TAB SCREENS */
.tab-s{flex:1;overflow-y:auto;scrollbar-width:thin}
.sec-t{padding:10px 16px 5px;font-size:13px;color:var(--t2);font-weight:500}

/* STATUS */
.my-s{display:flex;align-items:center;gap:14px;padding:12px 14px;cursor:pointer;border-bottom:1px solid var(--bd);transition:background 0.1s}
.my-s:hover{background:var(--hv)}
.sav-wrap{position:relative;flex-shrink:0}
.sav{width:52px;height:52px;border-radius:50%;background:var(--p2);display:flex;align-items:center;justify-content:center;overflow:hidden}
.sav img{width:100%;height:100%;object-fit:cover}
.s-plus{position:absolute;bottom:0;right:0;width:20px;height:20px;border-radius:50%;background:var(--g);display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff;font-weight:700;border:2px solid var(--bg)}
.sring{border-radius:50%;padding:2px;display:inline-block}
.sring.new{background:linear-gradient(45deg,var(--g),#00e5b0)}
.sring.seen{background:var(--p3)}
.scard{display:flex;align-items:center;gap:14px;padding:11px 14px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.03);transition:background 0.1s}
.scard:hover{background:var(--hv)}

/* CHANNELS */
.chcard{display:flex;align-items:center;gap:14px;padding:11px 14px;border-bottom:1px solid rgba(255,255,255,0.03);transition:background 0.1s;cursor:pointer}
.chcard:hover{background:var(--hv)}
.chav{width:48px;height:48px;border-radius:50%;background:var(--p2);display:flex;align-items:center;justify-content:center;font-size:20px;overflow:hidden;flex-shrink:0}
.chav img{width:100%;height:100%;object-fit:cover}
.vbdg{color:var(--bl);font-size:14px}
.folbtn{background:none;border:1px solid var(--g);color:var(--g);border-radius:20px;padding:6px 16px;font-size:13px;cursor:pointer;font-family:'Roboto',sans-serif;white-space:nowrap;flex-shrink:0;transition:all 0.2s}
.folbtn.on{background:var(--g);color:#fff}

/* COMMUNITIES */
.nc-item{display:flex;align-items:center;gap:14px;padding:14px;cursor:pointer;border-bottom:1px solid var(--bd);transition:background 0.1s}
.nc-item:hover{background:var(--hv)}
.nc-ico{width:52px;height:52px;border-radius:50%;background:var(--p2);display:flex;align-items:center;justify-content:center;font-size:26px;position:relative;flex-shrink:0}
.nc-plus{position:absolute;bottom:0;right:0;width:18px;height:18px;border-radius:50%;background:var(--g);color:#fff;font-size:12px;display:flex;align-items:center;justify-content:center;border:2px solid var(--bg)}
.comm-item{display:flex;align-items:flex-start;gap:14px;padding:14px;cursor:pointer;border-bottom:1px solid var(--bd);transition:background 0.1s}
.comm-item:hover{background:var(--hv)}
.comm-av{width:52px;height:52px;border-radius:12px;background:var(--p2);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;overflow:hidden}
.comm-av img{width:100%;height:100%;object-fit:cover}

/* CALLS */
.call-item{display:flex;align-items:center;padding:12px 14px;gap:13px;border-bottom:1px solid rgba(255,255,255,0.03);transition:background 0.1s;cursor:pointer}
.call-item:hover{background:var(--hv)}

/* SELECT CONTACT SCREEN */
#sc-screen{flex-direction:column!important}
.sc-hd{background:var(--p);padding:14px 16px 12px;flex-shrink:0}
.sc-hd-top{display:flex;align-items:center;gap:14px;margin-bottom:12px}
.sc-back{background:none;border:none;color:var(--t);font-size:22px;cursor:pointer;line-height:1}
.sc-s{background:var(--p2);border-radius:10px;display:flex;align-items:center;padding:8px 12px;gap:8px}
.sc-s svg{width:18px;height:18px;fill:var(--t3)}
.sc-s input{background:none;border:none;color:var(--t);font-size:14px;outline:none;flex:1;font-family:'Roboto',sans-serif}
.sc-s input::placeholder{color:var(--t3)}
.sc-actions{border-bottom:1px solid var(--bd)}
.sc-act{display:flex;align-items:center;gap:16px;padding:14px 16px;cursor:pointer;transition:background 0.1s}
.sc-act:hover{background:var(--hv)}
.sc-act-ico{width:52px;height:52px;border-radius:50%;background:var(--g);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.c-label{padding:10px 16px 5px;font-size:13px;color:var(--t2);font-weight:500;position:sticky;top:0;background:var(--bg);z-index:1}
.sc-list{flex:1;overflow-y:auto;scrollbar-width:thin}
.sc-c{display:flex;align-items:center;gap:14px;padding:12px 16px;cursor:pointer;transition:background 0.1s;border-bottom:1px solid rgba(255,255,255,0.03)}
.sc-c:hover,.sc-c.sel{background:var(--hv)}
.sc-chk{width:22px;height:22px;border-radius:50%;border:2px solid var(--t2);display:flex;align-items:center;justify-content:center;margin-left:auto;flex-shrink:0;transition:all 0.2s;font-size:13px}
.sc-chk.on{background:var(--g);border-color:var(--g);color:#fff}
.sc-chips{position:fixed;bottom:16px;left:16px;right:16px;background:var(--p);border-radius:12px;padding:8px;box-shadow:0 4px 16px rgba(0,0,0,0.4);max-height:90px;overflow-y:auto;display:none}
.sc-chips.show{display:flex;flex-wrap:wrap;gap:6px}
.sc-next{position:fixed;bottom:20px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--g);border:none;color:#fff;font-size:26px;cursor:pointer;display:none;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,168,132,0.5);z-index:10}
.sc-next.show{display:flex}

/* GROUP NAME SCREEN */
#grp-screen{flex-direction:column!important}

/* CHAT PANEL HEADER */
.cp-hd{background:var(--p);height:58px;display:flex;align-items:center;padding:0 8px 0 0;gap:8px;border-bottom:1px solid var(--bd);flex-shrink:0}
.cp-back{width:40px;height:40px;display:flex;align-items:center;justify-content:center;border:none;background:none;color:var(--t2);cursor:pointer;font-size:22px;flex-shrink:0}
.cp-av{width:40px;height:40px;border-radius:50%;background:var(--p2);overflow:hidden;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center}
.cp-av img{width:100%;height:100%;object-fit:cover}
.cp-info{flex:1;cursor:pointer;min-width:0}
.cp-nm{font-size:16px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cp-st{font-size:13px;color:var(--t2)}
.cp-acts{display:flex;gap:2px}

/* MESSAGES AREA */
.msgs{flex:1;overflow-y:auto;padding:8px 3%;scrollbar-width:thin;background:var(--bg);background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Crect width='300' height='300' fill='%230b141a'/%3E%3Cpath d='M40 80a30 30 0 100 60 30 30 0 000-60zm0 52a22 22 0 110-44 22 22 0 010 44z' fill='%23162028' fill-opacity='0.5'/%3E%3C/svg%3E")}
.dsep{text-align:center;margin:10px 0}
.dsep span{background:var(--p);color:var(--t2);font-size:12px;padding:5px 12px;border-radius:8px}
.mw{display:flex;margin-bottom:2px}
.mw.out{justify-content:flex-end}
.mw.in{justify-content:flex-start}
.mw.in .mgav{width:28px;flex-shrink:0}
.mw.out .mgav{display:none}
.mb{max-width:72%;position:relative}
.bi{padding:6px 10px 18px;border-radius:8px;word-break:break-word;font-size:14.5px;line-height:1.5;box-shadow:0 1px 2px rgba(0,0,0,0.2)}
.out .bi{background:var(--bo);border-radius:8px 0 8px 8px}
.in .bi{background:var(--bi);border-radius:0 8px 8px 8px}
.del-m{font-style:italic;color:var(--t3);font-size:13px}
.mt{position:absolute;bottom:4px;right:8px;font-size:11px;color:rgba(255,255,255,0.5);display:flex;align-items:center;gap:3px;white-space:nowrap}
.tck{font-size:13px}.tck.r{color:var(--bl)}
.fwdbdg{font-size:11px;color:var(--t3);margin-bottom:4px}
.rqb{background:rgba(0,0,0,0.25);border-left:4px solid var(--g);padding:6px 8px;border-radius:3px;margin-bottom:6px}
.rqa{color:var(--g);font-size:12px;font-weight:500;margin-bottom:2px}
.rqt{color:var(--t2);font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:220px}
.m-img{max-width:260px;border-radius:6px;cursor:pointer;display:block;margin-bottom:2px}
.m-vid{max-width:260px;border-radius:6px;margin-bottom:2px;display:block}
.m-aud{width:220px;margin-bottom:2px}
.m-doc{display:flex;align-items:center;gap:10px;background:rgba(0,0,0,0.2);padding:10px 12px;border-radius:8px;cursor:pointer;margin-bottom:2px}
.gsn{font-size:12px;font-weight:500;margin-bottom:3px}
.rrw{display:flex;flex-wrap:wrap;gap:3px;margin-top:3px}
.rchip{background:var(--p2);border:1px solid var(--bd);border-radius:20px;padding:2px 8px;font-size:13px;cursor:pointer}
.ti{padding:4px 16px;display:none}
.tb{display:flex;align-items:center;gap:4px;background:var(--bi);padding:10px 14px;border-radius:0 8px 8px 8px;width:fit-content}
.td{width:8px;height:8px;border-radius:50%;background:var(--t2);animation:tda 1.2s infinite}
.td:nth-child(2){animation-delay:.15s}.td:nth-child(3){animation-delay:.3s}
@keyframes tda{0%,80%,100%{transform:scale(0.8);opacity:0.5}40%{transform:scale(1.2);opacity:1}}

/* INPUT AREA */
.rstrip{background:var(--p2);padding:10px 14px;display:flex;align-items:center;gap:10px;border-left:4px solid var(--g);display:none}
.rstrip .ri{flex:1}
.rstrip .ra{color:var(--g);font-size:12px;font-weight:600;margin-bottom:2px}
.rstrip .rt{font-size:13px;color:var(--t2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px}
.iarea{background:var(--p);padding:7px 10px;display:flex;align-items:flex-end;gap:8px;flex-shrink:0;position:relative}
.recs{background:var(--p2);border-radius:24px;padding:8px 16px;flex:1;display:none;align-items:center;gap:10px}
.recs.on{display:flex}
.recdot{width:12px;height:12px;border-radius:50%;background:var(--r);animation:pls 1s infinite}
@keyframes pls{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
.rect{color:var(--t);font-size:14px;font-weight:500}
.recx{color:var(--t2);font-size:20px;cursor:pointer}
.iico{color:var(--t2);cursor:pointer;padding:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.iico svg{width:24px;height:24px;fill:currentColor}
.msgbox{flex:1;background:var(--p2);border-radius:24px;padding:8px 14px;display:flex;align-items:flex-end}
#mi{background:none;border:none;color:var(--t);font-size:15px;outline:none;resize:none;max-height:130px;font-family:'Roboto',sans-serif;width:100%;line-height:1.4}
#mi::placeholder{color:var(--t3)}
.sndbtn{width:48px;height:48px;border-radius:50%;background:var(--g);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.sndbtn svg{width:22px;height:22px;fill:#fff}
.vcbtn{width:48px;height:48px;border-radius:50%;background:var(--g);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.vcbtn.rec{background:var(--r);animation:pls 1s infinite}
.vcbtn svg{width:22px;height:22px;fill:#fff}
.ep{position:absolute;bottom:66px;left:0;background:var(--p);border-radius:12px;padding:10px;width:min(310px,95vw);max-height:240px;overflow-y:auto;display:none;box-shadow:0 4px 20px rgba(0,0,0,0.5);scrollbar-width:thin}
.ep.on{display:block}
.eg{display:grid;grid-template-columns:repeat(8,1fr);gap:4px}
.ei{font-size:21px;cursor:pointer;text-align:center;padding:4px;border-radius:6px;transition:background 0.1s;line-height:1.3}
.ei:hover{background:var(--hv)}
.am{position:absolute;bottom:66px;left:0;background:var(--p);border-radius:16px;padding:14px;display:none;gap:4px;flex-wrap:wrap;width:200px;box-shadow:0 4px 20px rgba(0,0,0,0.5)}
.am.on{display:flex}
.ao{display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;padding:8px;border-radius:10px;width:76px;transition:background 0.1s}
.ao:hover{background:var(--hv)}
.ao-ic{width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px}
.ao-l{font-size:11px;color:var(--t2);text-align:center}

/* DROPDOWN MENUS */
.ddm{position:fixed;background:var(--p);border-radius:10px;padding:6px 0;min-width:200px;z-index:500;display:none;box-shadow:0 4px 24px rgba(0,0,0,0.5)}
.ddm.on{display:block}
.ddi{padding:13px 18px;font-size:15px;cursor:pointer;color:var(--t);transition:background 0.1s;display:flex;align-items:center;gap:12px}
.ddi:hover{background:var(--hv)}
.ddi.d{color:var(--r)}

/* CONTEXT MENU */
.ctx{position:fixed;background:var(--p);border-radius:10px;padding:6px 0;min-width:180px;z-index:1000;display:none;box-shadow:0 4px 24px rgba(0,0,0,0.6)}
.ctx.on{display:block}
.ci-r{display:flex;padding:10px 12px;gap:6px;font-size:25px}
.ci-r span{cursor:pointer;padding:2px;border-radius:6px;transition:transform 0.15s}
.ci-r span:hover{transform:scale(1.3)}
.cxi{padding:12px 18px;font-size:14px;cursor:pointer;display:flex;align-items:center;gap:10px;color:var(--t);transition:background 0.1s}
.cxi:hover{background:var(--hv)}
.cxi.d{color:var(--r)}

/* MODALS */
.mbg{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:200;display:none;align-items:flex-end;justify-content:center}
.mbg.on{display:flex}
@media(min-width:481px){.mbg{align-items:center}}
.modal{background:var(--p);border-radius:16px 16px 0 0;width:100%;max-width:460px;max-height:92vh;overflow-y:auto;padding:20px;position:relative}
@media(min-width:481px){.modal{border-radius:16px}}
.mh{width:36px;height:4px;background:var(--p3);border-radius:2px;margin:0 auto 14px;display:block}
.modal h2{font-size:18px;font-weight:500;margin-bottom:16px}
.mcl{position:absolute;top:14px;right:16px;background:none;border:none;color:var(--t2);font-size:24px;cursor:pointer}
.fg{margin-bottom:14px}
.fl{font-size:12px;color:var(--g);font-weight:500;margin-bottom:5px;display:block}
.fi{width:100%;background:transparent;border:none;border-bottom:2px solid var(--bd);padding:8px 0;color:var(--t);font-size:15px;outline:none;font-family:'Roboto',sans-serif;transition:border-color 0.2s}
.fi:focus{border-bottom-color:var(--g)}
.mbtn{width:100%;background:var(--g);color:#fff;border:none;border-radius:10px;padding:13px;font-size:15px;font-weight:500;cursor:pointer;font-family:'Roboto',sans-serif;margin-top:6px;transition:background 0.2s}
.mbtn:hover{background:#00b894}
.merr{color:var(--r);font-size:12px;text-align:center;padding:4px 0;display:none}
.sres{max-height:240px;overflow-y:auto}
.sri{display:flex;align-items:center;gap:12px;padding:10px 12px;cursor:pointer;border-radius:10px;transition:background 0.1s}
.sri:hover{background:var(--hv)}
.mchips{display:flex;flex-wrap:wrap;gap:6px;padding:8px;background:var(--p2);border-radius:10px;min-height:36px;margin-bottom:8px}
.mchip{display:flex;align-items:center;gap:5px;background:var(--p3);border-radius:20px;padding:4px 10px;font-size:13px}
.mcx{cursor:pointer;color:var(--t2)}
.pav{width:84px;height:84px;border-radius:50%;background:var(--p2);overflow:hidden;display:flex;align-items:center;justify-content:center;margin:0 auto 14px;cursor:pointer;position:relative}
.pav img{width:100%;height:100%;object-fit:cover}
.pav-ov{position:absolute;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;font-size:20px;color:#fff}
.pav:hover .pav-ov{display:flex}
.isec{border-bottom:1px solid var(--bd);padding:10px 0}
.ilbl{font-size:12px;color:var(--g);font-weight:500;margin-bottom:3px}
.ival{font-size:15px;color:var(--t);display:flex;align-items:center;justify-content:space-between}
.ieb{background:none;border:none;color:var(--g);cursor:pointer;font-size:16px}

/* STATUS VIEWER */
.svo{position:fixed;inset:0;background:#000;z-index:800;display:none;flex-direction:column}
.svo.on{display:flex}
.svpg{display:flex;gap:3px;padding:12px 10px 0}
.svseg{flex:1;height:3px;background:rgba(255,255,255,0.3);border-radius:2px;overflow:hidden}
.svfill{height:100%;background:#fff;width:0;transition:width linear}
.svhd{display:flex;align-items:center;gap:10px;padding:10px 12px;position:absolute;top:28px;left:0;right:0;z-index:2}
.svcl{margin-left:auto;background:none;border:none;color:#fff;font-size:26px;cursor:pointer}
.svcont{flex:1;display:flex;align-items:center;justify-content:center;padding:20px;text-align:center}
.svcont img,.svcont video{max-width:100%;max-height:80vh;object-fit:contain;border-radius:4px}
.svtxt{font-size:26px;font-weight:500;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,0.4);padding:20px;white-space:pre-wrap;word-break:break-word}
.svnl{position:absolute;left:0;top:0;width:40%;height:100%;cursor:pointer;z-index:3}
.svnr{position:absolute;right:0;top:0;width:40%;height:100%;cursor:pointer;z-index:3}
.svrep{padding:10px 14px;display:flex;gap:10px}
.svri{flex:1;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);border-radius:24px;padding:10px 16px;color:#fff;font-size:14px;outline:none;font-family:'Roboto',sans-serif}
.svri::placeholder{color:rgba(255,255,255,0.6)}

/* STATUS CREATE */
.sco{position:fixed;inset:0;background:var(--bg);z-index:900;display:none;flex-direction:column}
.sco.on{display:flex}
.sch{background:var(--p);height:58px;display:flex;align-items:center;padding:0 14px;gap:14px;border-bottom:1px solid var(--bd)}
.sch h2{font-size:18px;font-weight:500;flex:1}
.postbtn{background:var(--g);border:none;color:#fff;border-radius:20px;padding:8px 20px;font-size:14px;cursor:pointer;font-family:'Roboto',sans-serif}
.sctabs{display:flex;border-bottom:1px solid var(--bd)}
.sctab{flex:1;padding:12px;text-align:center;font-size:14px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;color:var(--t2)}
.sctab.on{color:var(--g);border-bottom-color:var(--g)}
.scprev{flex:1;display:flex;align-items:center;justify-content:center;padding:20px}
.sctxt{font-size:24px;font-weight:500;padding:32px;text-align:center;word-break:break-word;width:100%;min-height:180px;display:flex;align-items:center;justify-content:center;border-radius:12px;color:#fff}
.cbr{display:flex;gap:8px;padding:12px 14px;overflow-x:auto;scrollbar-width:none;border-top:1px solid var(--bd)}
.cbr::-webkit-scrollbar{display:none}
.csw{width:32px;height:32px;border-radius:50%;cursor:pointer;border:3px solid transparent;flex-shrink:0;transition:border-color 0.2s}
.csw.on{border-color:#fff}
.scin{padding:10px 14px;display:flex;align-items:center;gap:12px;background:var(--p);border-top:1px solid var(--bd)}
.scin textarea,.scin input{flex:1;background:var(--p2);border:none;border-radius:24px;padding:10px 16px;color:var(--t);font-size:15px;outline:none;font-family:'Roboto',sans-serif;resize:none}

/* CALL OVERLAY */
.calo{position:fixed;inset:0;background:linear-gradient(135deg,#1a2a2a,#0d1f1f);z-index:900;display:none;flex-direction:column;align-items:center;justify-content:center;gap:14px}
.calo.on{display:flex}
.cal-av{width:110px;height:110px;border-radius:50%;background:var(--p2);overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:48px}
.cal-av img{width:100%;height:100%;object-fit:cover}
.cal-n{font-size:26px;font-weight:400}
.cal-s{color:var(--t2);font-size:15px}
.cal-acts{display:flex;gap:20px;margin-top:24px}
.ca{display:flex;flex-direction:column;align-items:center;gap:8px}
.ca button{width:64px;height:64px;border-radius:50%;border:none;cursor:pointer;font-size:26px;display:flex;align-items:center;justify-content:center;transition:transform 0.15s}
.ca button:active{transform:scale(0.9)}
.ca .cl{font-size:12px;color:var(--t2)}
.cab-e{background:var(--r)}
.cab-a{background:#00b894}
.cab-m,.cab-sp{background:var(--p2)}
.inc-row{display:flex;gap:40px;margin-top:10px}
#rvid{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none}
#lvid{position:absolute;bottom:110px;right:16px;width:100px;height:140px;border-radius:12px;object-fit:cover;display:none;z-index:10}

/* NOTIF */
.notif{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:var(--p);border-radius:12px;padding:10px 14px;z-index:9999;display:none;align-items:center;gap:10px;min-width:280px;max-width:340px;box-shadow:0 4px 20px rgba(0,0,0,0.5);cursor:pointer;animation:nsin .3s ease}
@keyframes nsin{from{transform:translateX(-50%) translateY(-60px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
.notif.on{display:flex}

/* LIGHTBOX */
.lb{position:fixed;inset:0;background:rgba(0,0,0,0.97);z-index:1000;display:none;align-items:center;justify-content:center}
.lb.on{display:flex}
.lbc img,.lbc video{max-width:98vw;max-height:88vh;object-fit:contain;border-radius:6px}

/* UTIL */
.avph{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:500;color:#fff}
</style>
</head>
<body>

<!-- WELCOME -->
<div class="screen" id="welcome">
  <div class="wlogo"><svg viewBox="0 0 55 55"><path d="M27.5 8C16.73 8 8 16.73 8 27.5c0 3.56.97 6.9 2.65 9.76L8.13 47l9.93-2.5A19.38 19.38 0 0027.5 47c10.77 0 19.5-8.73 19.5-19.5S38.27 8 27.5 8zm0 35.62a16.03 16.03 0 01-8.19-2.26l-.58-.35-6.07 1.53 1.56-5.87-.38-.6A16.12 16.12 0 0111.38 27.5c0-8.89 7.23-16.12 16.12-16.12 8.89 0 16.12 7.23 16.12 16.12S36.39 43.62 27.5 43.62z"/><path d="M22.04 18.62c-.43-1.07-.88-1.1-1.3-1.12-.34-.02-.72-.02-1.1-.02-.38 0-1 .14-1.53.7-.52.56-2 1.96-2 4.77s2.04 5.54 2.32 5.92c.29.38 3.93 6.3 9.7 8.58 4.8 1.89 5.77 1.52 6.82 1.42 1.04-.1 3.36-1.37 3.84-2.7.48-1.32.48-2.45.33-2.68-.14-.24-.52-.38-1.1-.67-.58-.29-3.42-1.69-3.95-1.88-.52-.19-.9-.29-1.28.29-.38.57-1.47 1.88-1.8 2.27-.33.38-.67.43-1.24.14-.58-.29-2.43-.9-4.63-2.86-1.72-1.52-2.87-3.4-3.2-3.98-.34-.57-.04-.88.25-1.17.26-.26.58-.67.86-1.01.29-.33.38-.57.57-.95.19-.38.1-.72-.05-1.01-.14-.29-1.25-3.15-1.75-4.32z"/></svg></div>
  <div class="wtitle">ChatApp</div>
  <div class="wsub">Fast, simple and secure messaging. Connect with anyone, anywhere.</div>
  <button class="wbtn" onclick="goTo('otp-phone')">Agree and continue</button>
  <div class="wterms">By tapping "Agree and continue" you agree to our Terms of Service and Privacy Policy</div>
</div>

<!-- OTP PHONE -->
<div class="screen hidden" id="otp-phone">
  <div class="otp-hd"><h2>Enter your phone number</h2><p>ChatApp will send an OTP to verify your number</p></div>
  <div style="padding:0 16px;margin-top:-36px">
  <div class="otp-card">
    <div style="font-size:28px;text-align:center;margin-bottom:10px">üåç</div>
    <div class="otp-row">
      <span class="otp-cc">+91</span>
      <input class="otp-inp" id="ph-inp" type="tel" placeholder="Phone number" maxlength="15" oninput="onPhInp()">
    </div>
    <p class="otp-info">ChatApp will send you a 6-digit verification code. Message rates may apply.</p>
    <div class="merr" id="ph-err"></div>
    <button class="otp-btn" id="ph-btn" onclick="sendOTP()" disabled>NEXT</button>
  </div>
  </div>
</div>

<!-- OTP VERIFY -->
<div class="screen hidden" id="otp-verify">
  <div class="otp-hd"><h2>Verify your number</h2><p id="otp-sub">Enter the 6-digit code</p></div>
  <div style="padding:0 16px;margin-top:-36px">
  <div class="otp-card">
    <div class="demo-box" id="demo-box">
      <div class="demo-code" id="demo-code">------</div>
      <div class="demo-note">üì± Demo mode ‚Äî Your OTP code (in production this would be sent via SMS)</div>
    </div>
    <div class="otp-boxes">
      <input class="ob" id="ob0" maxlength="1" type="tel" oninput="obInp(0,this)" onkeydown="obKey(0,event)">
      <input class="ob" id="ob1" maxlength="1" type="tel" oninput="obInp(1,this)" onkeydown="obKey(1,event)">
      <input class="ob" id="ob2" maxlength="1" type="tel" oninput="obInp(2,this)" onkeydown="obKey(2,event)">
      <input class="ob" id="ob3" maxlength="1" type="tel" oninput="obInp(3,this)" onkeydown="obKey(3,event)">
      <input class="ob" id="ob4" maxlength="1" type="tel" oninput="obInp(4,this)" onkeydown="obKey(4,event)">
      <input class="ob" id="ob5" maxlength="1" type="tel" oninput="obInp(5,this)" onkeydown="obKey(5,event)">
    </div>
    <div class="resend-row">Didn't receive code? <button class="resend-btn" onclick="goTo('otp-phone')">Resend SMS</button></div>
    <div class="merr" id="otp-err"></div>
    <button class="otp-btn" style="margin-top:14px" onclick="verifyOTP()">VERIFY</button>
  </div>
  </div>
</div>

<!-- PROFILE SETUP -->
<div class="screen hidden" id="otp-name">
  <div class="otp-hd"><h2>Profile info</h2><p>Please provide your name and profile photo</p></div>
  <div style="padding:0 16px;margin-top:-36px">
  <div class="otp-card">
    <div class="name-av" id="reg-av" onclick="document.getElementById('reg-av-inp').click()">
      üë§<div class="name-av-edit">üì∑</div>
    </div>
    <input type="file" id="reg-av-inp" accept="image/*" style="display:none" onchange="prevRegAv(event)">
    <div class="otp-row" style="margin-bottom:12px">
      <input class="otp-inp" id="name-inp" placeholder="Your name (required)" maxlength="30">
    </div>
    <div class="otp-row" style="border-color:var(--bd)">
      <input class="otp-inp" id="about-inp" placeholder="About (optional)">
    </div>
    <p style="font-size:12px;color:var(--t2);margin:12px 0 16px;line-height:1.6">This name will be visible to your contacts in ChatApp.</p>
    <div class="merr" id="name-err"></div>
    <button class="otp-btn" onclick="finishSetup()">NEXT</button>
  </div>
  </div>
</div>

<!-- MAIN APP -->
<div class="screen hidden" id="app" style="flex-direction:row!important">
  <!-- SIDEBAR -->
  <div class="sb" id="sidebar">
    <div class="shd">
      <div class="shd-l" onclick="openProfile()">
        <div class="cav" id="myav" style="width:38px;height:38px;flex-shrink:0"></div>
        <span class="stitle">ChatApp</span>
      </div>
      <div class="hbts">
        <button class="hbt" onclick="openSC()" title="Status update">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="1.8"/><circle cx="12" cy="12" r="4" fill="none" stroke="currentColor" stroke-width="1.8"/></svg>
        </button>
        <button class="hbt" onclick="openSelContact('newchat')" title="New chat">
          <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M12 8v4m0 4h.01" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
        </button>
        <button class="hbt" onclick="openDDM('mmenu',event)">
          <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="5" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="19" r="1.5"/></svg>
        </button>
      </div>
    </div>
    <div class="ssrch">
      <div class="ssrch-in">
        <svg viewBox="0 0 24 24"><path d="M21 21l-4.35-4.35M17 11A6 6 0 115 11a6 6 0 0112 0z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
        <input id="srch-inp" placeholder="Search or start new chat" oninput="onSrch(this.value)">
      </div>
    </div>
    <div class="pills" id="pills-bar">
      <button class="pill on" onclick="setFilter('all',this)">All</button>
      <button class="pill" onclick="setFilter('unread',this)">Unread</button>
      <button class="pill" onclick="setFilter('fav',this)">Favorites</button>
      <button class="pill" onclick="setFilter('grp',this)">Groups</button>
    </div>
    <div id="tab-chats" class="tab-s clist"></div>
    <div id="tab-updates" class="tab-s hidden"></div>
    <div id="tab-communities" class="tab-s hidden"></div>
    <div id="tab-calls" class="tab-s hidden"></div>
    <!-- FAB MENU -->
    <div class="fab-menu" id="fab-menu">
      <div class="fmi"><span class="fml">New community</span><button class="fmb" style="background:var(--p2)" onclick="closeFAB();openModal('new-comm-modal')">üèòÔ∏è</button></div>
      <div class="fmi"><span class="fml">New group</span><button class="fmb" style="background:var(--p2)" onclick="closeFAB();openSelContact('newgroup')">üë•</button></div>
      <div class="fmi"><span class="fml">New contact</span><button class="fmb" style="background:var(--p2)" onclick="closeFAB();openModal('new-contact-modal')">üë§</button></div>
      <div class="fmi"><span class="fml">New chat</span><button class="fmb" style="background:var(--g)" onclick="closeFAB();openSelContact('newchat')">üí¨</button></div>
    </div>
    <button class="fab" id="fab" onclick="toggleFAB()">
      <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round"/><line x1="12" y1="8" x2="12" y2="16" stroke="#fff" stroke-width="2.2" stroke-linecap="round"/><line x1="8" y1="12" x2="16" y2="12" stroke="#fff" stroke-width="2.2" stroke-linecap="round"/></svg>
    </button>
    <div class="bnav">
      <div class="bni on" id="bn-chats" onclick="switchTab('chats')">
        <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        <span class="bni-lbl">Chats</span>
      </div>
      <div class="bni" id="bn-updates" onclick="switchTab('updates')">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="4"/></svg>
        <span class="bni-lbl">Updates</span>
      </div>
      <div class="bni" id="bn-communities" onclick="switchTab('communities')">
        <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
        <span class="bni-lbl">Communities</span>
      </div>
      <div class="bni" id="bn-calls" onclick="switchTab('calls')">
        <svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 11.5 19.79 19.79 0 01.01 2.88 2 2 0 012 .71h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L6.09 8.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
        <span class="bni-lbl">Calls</span>
      </div>
    </div>
  </div>
  <!-- CHAT PANEL -->
  <div class="cp" id="chat-panel">
    <div id="cp-empty" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--t3);text-align:center;padding:20px">
      <svg width="80" height="80" viewBox="0 0 55 55" style="opacity:0.1;margin-bottom:16px"><path fill="#00a884" d="M27.5 8C16.73 8 8 16.73 8 27.5c0 3.56.97 6.9 2.65 9.76L8.13 47l9.93-2.5A19.38 19.38 0 0027.5 47c10.77 0 19.5-8.73 19.5-19.5S38.27 8 27.5 8z"/></svg>
      <h2 style="font-size:22px;font-weight:300;margin-bottom:10px">ChatApp</h2>
      <p style="font-size:14px;line-height:1.6;max-width:300px">Send and receive messages without keeping your phone online. Use ChatApp on up to 4 linked devices.</p>
      <div style="display:flex;align-items:center;gap:6px;font-size:13px;margin-top:16px">üîí End-to-end encrypted</div>
    </div>
  </div>
</div>

<!-- SELECT CONTACT SCREEN -->
<div class="screen hidden" id="sc-screen" style="flex-direction:column!important">
  <div class="sc-hd">
    <div class="sc-hd-top">
      <button class="sc-back" onclick="closeSelContact()">‚Üê</button>
      <div style="flex:1"><div style="font-size:19px;font-weight:500;color:var(--t)" id="sc-title">Select contact</div><div style="font-size:13px;color:var(--t2)" id="sc-count">0 contacts</div></div>
      <button class="hbt" onclick="loadDeviceContacts()" title="Sync phone contacts">üì±</button>
      <button class="hbt" onclick="openDDM('sc-ddm',event)"><svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="5" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="19" r="1.5"/></svg></button>
    </div>
    <div class="sc-s">
      <svg viewBox="0 0 24 24"><path d="M21 21l-4.35-4.35M17 11A6 6 0 115 11a6 6 0 0112 0z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
      <input id="sc-s-inp" placeholder="Search name or phone number" oninput="filterSC(this.value)">
    </div>
  </div>
  <div class="sc-actions" id="sc-actions">
    <div class="sc-act" onclick="openSelContact('newgroup')"><div class="sc-act-ico">üë•</div><div><div style="font-size:16px;color:var(--t);margin-bottom:2px">New group</div><div style="font-size:13px;color:var(--t2)">Create a group chat</div></div></div>
    <div class="sc-act" onclick="openModal('new-contact-modal')"><div class="sc-act-ico">üë§</div><div><div style="font-size:16px;color:var(--t);margin-bottom:2px">New contact</div><div style="font-size:13px;color:var(--t2)">Add a contact by phone</div></div></div>
    <div class="sc-act" onclick="openModal('new-comm-modal')"><div class="sc-act-ico">üèòÔ∏è</div><div><div style="font-size:16px;color:var(--t);margin-bottom:2px">New community</div><div style="font-size:13px;color:var(--t2)">Create or join a community</div></div></div>
  </div>
  <div class="sc-list">
    <div class="c-label">Contacts on ChatApp</div>
    <div id="sc-contacts"></div>
    <div class="c-label" id="sc-ph-lbl" style="display:none">Search by phone number</div>
    <div id="sc-ph-res"></div>
  </div>
  <div class="sc-chips" id="sel-chips"></div>
  <button class="sc-next" id="sc-next-btn" onclick="proceedSC()">‚Üí</button>
</div>

<!-- GROUP NAME SCREEN -->
<div class="screen hidden" id="grp-screen" style="flex-direction:column!important">
  <div class="sc-hd">
    <div class="sc-hd-top">
      <button class="sc-back" onclick="openSelContact('newgroup')">‚Üê</button>
      <div><div style="font-size:19px;font-weight:500;color:var(--t)">New group</div><div style="font-size:13px;color:var(--t2)">Add group subject</div></div>
    </div>
  </div>
  <div style="padding:24px 16px;flex:1;overflow-y:auto">
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:24px">
      <div class="pav" style="width:68px;height:68px;flex-shrink:0" onclick="document.getElementById('grp-av-inp').click()">
        <span id="grp-av-ph" style="font-size:28px">üë•</span>
        <div class="pav-ov">üì∑</div>
      </div>
      <input type="file" id="grp-av-inp" accept="image/*" style="display:none" onchange="prevGrpAv(event)">
      <div style="flex:1;border-bottom:2px solid var(--g);padding-bottom:6px">
        <input style="background:none;border:none;color:var(--t);font-size:18px;outline:none;width:100%;font-family:'Roboto',sans-serif" id="grp-name-inp" placeholder="Group name" maxlength="50">
      </div>
    </div>
    <div style="font-size:13px;color:var(--t2);margin-bottom:12px">Participants: <span id="grp-count">0</span></div>
    <div id="grp-chips" style="display:flex;flex-wrap:wrap;gap:8px"></div>
  </div>
  <div style="padding:16px"><button class="otp-btn" onclick="createGroup()">Create group</button></div>
</div>

<!-- DROPDOWN MENUS -->
<div class="ddm" id="mmenu">
  <div class="ddi" onclick="closeDDM();openSelContact('newgroup')">üë• New group</div>
  <div class="ddi" onclick="closeDDM();openModal('new-comm-modal')">üèòÔ∏è New community</div>
  <div class="ddi" onclick="closeDDM();showBroadcast()">üì¢ Broadcast lists</div>
  <div class="ddi" onclick="closeDDM();showLinkedDevices()">üîó Linked devices</div>
  <div class="ddi" onclick="closeDDM();showStarred()">‚≠ê Starred messages</div>
  <div class="ddi" onclick="closeDDM();openPinSetup()">üîí Locked chats</div>
  <div class="ddi" onclick="closeDDM();readAll()">‚úÖ Read all</div>
  <div class="ddi" onclick="closeDDM();openProfile()">‚öôÔ∏è Settings</div>
  <div class="ddi d" onclick="logout()">üö™ Log out</div>
</div>
<div class="ddm" id="cmenu">
  <div class="ddi" onclick="closeDDM();openContactInfo()">üë§ View contact</div>
  <div class="ddi" onclick="closeDDM();addToContacts()">‚ûï Add to contacts</div>
  <div class="ddi" onclick="closeDDM();muteChat()">üîá Mute notifications</div>
  <div class="ddi" onclick="closeDDM();lockActiveChat()">üîí Lock chat</div>
  <div class="ddi" onclick="closeDDM();clearChat()">üóëÔ∏è Clear chat</div>
  <div class="ddi d" onclick="closeDDM();blockUser()">üö´ Block</div>
</div>
<div class="ddm" id="sc-ddm">
  <div class="ddi" onclick="closeDDM();loadDeviceContacts()">üì± Sync phone contacts</div>
  <div class="ddi" onclick="closeDDM();openModal('new-contact-modal')">‚ûï Add contact manually</div>
  <div class="ddi" onclick="closeDDM();inviteLink()">üîó Invite via link</div>
</div>

<!-- CONTEXT MENU -->
<div class="ctx" id="ctx">
  <div class="ci-r"><span onclick="sendR('‚ù§Ô∏è')">‚ù§Ô∏è</span><span onclick="sendR('üëç')">üëç</span><span onclick="sendR('üòÇ')">üòÇ</span><span onclick="sendR('üòÆ')">üòÆ</span><span onclick="sendR('üò¢')">üò¢</span><span onclick="sendR('üôè')">üôè</span></div>
  <div class="cxi" onclick="ctxReply()">‚Ü©Ô∏è Reply</div>
  <div class="cxi" onclick="ctxCopy()">üìã Copy text</div>
  <div class="cxi" onclick="ctxForward()">‚û°Ô∏è Forward</div>
  <div class="cxi" onclick="ctxStar()">‚≠ê Star message</div>
  <div class="cxi" onclick="ctxInfo()">‚ÑπÔ∏è Message info</div>
  <div class="cxi d" onclick="ctxDel()">üóëÔ∏è Delete</div>
</div>

<!-- PROFILE MODAL -->
<div class="mbg" id="profile-modal"><div class="modal">
  <div class="mh"></div><button class="mcl" onclick="closeModal('profile-modal')">‚úï</button>
  <h2>Profile</h2>
  <div class="pav" onclick="document.getElementById('av-up').click()" id="pm-av"><div class="pav-ov">üì∑</div></div>
  <input type="file" id="av-up" accept="image/*" style="display:none" onchange="uploadAv(event)">
  <div class="isec"><div class="ilbl">Name</div><div class="ival"><span id="pm-name"></span><button class="ieb" onclick="editF('name')">‚úèÔ∏è</button></div></div>
  <div class="isec"><div class="ilbl">Phone</div><div class="ival" id="pm-phone"></div></div>
  <div class="isec" style="border:none"><div class="ilbl">About</div><div class="ival"><span id="pm-about"></span><button class="ieb" onclick="editF('about')">‚úèÔ∏è</button></div></div>
  <button class="mbtn" style="background:var(--p2);color:var(--t);margin-top:10px" onclick="openPinSetup()">üîí Locked chats</button>
  <button class="mbtn" style="background:var(--p2);color:var(--r);margin-top:6px" onclick="logout()">Log out</button>
</div></div>

<!-- CONTACT INFO MODAL -->
<div class="mbg" id="contact-modal"><div class="modal">
  <div class="mh"></div><button class="mcl" onclick="closeModal('contact-modal')">‚úï</button>
  <div class="pav" id="cm-av" style="pointer-events:none"></div>
  <div style="text-align:center;margin-bottom:16px"><div style="font-size:20px;font-weight:500;margin-bottom:4px" id="cm-name"></div><div style="color:var(--t2);font-size:14px" id="cm-phone"></div></div>
  <div class="isec"><div class="ilbl">About</div><div class="ival" id="cm-about"></div></div>
  <div class="isec" style="border:none"><div class="ilbl">Last seen</div><div class="ival" id="cm-ls"></div></div>
  <div style="display:flex;gap:10px;margin-top:16px">
    <button class="mbtn" style="flex:1" onclick="closeModal('contact-modal');makeCall('voice')">üìû Voice</button>
    <button class="mbtn" style="flex:1" onclick="closeModal('contact-modal');makeCall('video')">üìπ Video</button>
  </div>
</div></div>

<!-- NEW CONTACT MODAL -->
<div class="mbg" id="new-contact-modal"><div class="modal">
  <div class="mh"></div><button class="mcl" onclick="closeModal('new-contact-modal')">‚úï</button>
  <h2>New contact</h2>
  <div class="fg"><span class="fl">Name</span><input class="fi" id="nc-name" placeholder="Contact name"></div>
  <div class="fg"><span class="fl">Phone number</span><input class="fi" id="nc-phone" type="tel" placeholder="+91 9876543210"></div>
  <div class="merr" id="nc-err"></div>
  <button class="mbtn" onclick="addContact()">Add contact</button>
</div></div>

<!-- NEW COMMUNITY MODAL -->
<div class="mbg" id="new-comm-modal"><div class="modal">
  <div class="mh"></div><button class="mcl" onclick="closeModal('new-comm-modal')">‚úï</button>
  <h2>New community</h2>
  <div class="fg"><span class="fl">Community name</span><input class="fi" id="comm-name" placeholder="Enter community name"></div>
  <div class="fg"><span class="fl">Description</span><input class="fi" id="comm-desc" placeholder="Optional description"></div>
  <button class="mbtn" onclick="createCommunity()">Create community</button>
</div></div>

<!-- PIN MODAL -->
<div class="mbg" id="pin-modal"><div class="modal">
  <div class="mh"></div><button class="mcl" onclick="closeModal('pin-modal')">‚úï</button>
  <h2>üîí Locked chats</h2>
  <p style="font-size:14px;color:var(--t2);line-height:1.7;margin-bottom:18px">Type your secret PIN in the search bar to reveal locked chats. They won't appear in your chat list until you enter the PIN.</p>
  <div class="fg"><span class="fl">Set PIN (4-6 digits)</span><input class="fi" id="pin-inp" type="password" inputmode="numeric" placeholder="Enter PIN" maxlength="6"></div>
  <button class="mbtn" onclick="savePin()">Set PIN</button>
  <button class="mbtn" style="background:var(--p2);color:var(--r);margin-top:6px" onclick="removePin()">Remove PIN</button>
</div></div>

<!-- STATUS VIEWER -->
<div class="svo" id="svo">
  <div class="svpg" id="svpg"></div>
  <div class="svhd">
    <div class="cav" id="sv-av" style="width:38px;height:38px;flex-shrink:0"></div>
    <div><div style="font-size:14px;font-weight:500;color:#fff" id="sv-name"></div><div style="font-size:12px;color:rgba(255,255,255,0.7)" id="sv-time"></div></div>
    <button class="svcl" onclick="closeSVO()">‚úï</button>
  </div>
  <div class="svnl" onclick="svPrev()"></div>
  <div class="svnr" onclick="svNext()"></div>
  <div class="svcont" id="svcont"></div>
  <div class="svrep">
    <input class="svri" placeholder="Reply to status‚Ä¶" id="sv-rep">
    <button class="sndbtn" style="width:40px;height:40px" onclick="sendSVRep()"><svg viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg></button>
  </div>
</div>

<!-- STATUS CREATE -->
<div class="sco" id="sco">
  <div class="sch">
    <button onclick="closeSC()" style="background:none;border:none;color:var(--t2);font-size:22px;cursor:pointer">‚úï</button>
    <h2>Add status</h2>
    <button class="postbtn" onclick="postStatus()">Post</button>
  </div>
  <div class="sctabs">
    <div class="sctab on" id="sct-text" onclick="setSCT('text')">Text</div>
    <div class="sctab" id="sct-photo" onclick="setSCT('photo')">Photo/Video</div>
  </div>
  <div id="sc-tv" style="flex:1;display:flex;flex-direction:column">
    <div class="scprev"><div class="sctxt" id="sc-txt-prev" style="background:#00a884">Your text here‚Ä¶</div></div>
    <div class="cbr">
      <div class="csw on" style="background:#00a884" data-c="#00a884" onclick="pickSCC(this)"></div>
      <div class="csw" style="background:#7c3aed" data-c="#7c3aed" onclick="pickSCC(this)"></div>
      <div class="csw" style="background:#dc2626" data-c="#dc2626" onclick="pickSCC(this)"></div>
      <div class="csw" style="background:#0891b2" data-c="#0891b2" onclick="pickSCC(this)"></div>
      <div class="csw" style="background:#d97706" data-c="#d97706" onclick="pickSCC(this)"></div>
      <div class="csw" style="background:#059669" data-c="#059669" onclick="pickSCC(this)"></div>
      <div class="csw" style="background:#1d4ed8" data-c="#1d4ed8" onclick="pickSCC(this)"></div>
      <div class="csw" style="background:#000" data-c="#000" onclick="pickSCC(this)"></div>
    </div>
    <div class="scin"><textarea id="sc-txt-inp" rows="1" placeholder="Type a status‚Ä¶" oninput="onSCTxt(this)"></textarea></div>
  </div>
  <div id="sc-pv" style="flex:1;display:none;flex-direction:column">
    <div class="scprev" style="cursor:pointer" onclick="document.getElementById('sc-media-inp').click()" id="sc-ph-prev">
      <div style="text-align:center;color:var(--t2)"><div style="font-size:56px">üì∑</div><div style="margin-top:8px;font-size:15px">Tap to add photo or video</div></div>
    </div>
    <input type="file" id="sc-media-inp" accept="image/*,video/*" style="display:none" onchange="onSCMedia(event)">
    <div class="scin"><input id="sc-cap" placeholder="Add a caption‚Ä¶"></div>
  </div>
</div>

<!-- CALL OVERLAY -->
<div class="calo" id="calo">
  <video id="rvid" autoplay playsinline></video>
  <video id="lvid" autoplay playsinline muted></video>
  <div class="cal-av" id="cal-av">üë§</div>
  <div class="cal-n" id="cal-n">Name</div>
  <div class="cal-s" id="cal-s">Calling‚Ä¶</div>
  <div class="cal-acts">
    <div class="ca"><button class="cab-m" id="mute-b" onclick="toggleMute()">üéôÔ∏è</button><span class="cl">Mute</span></div>
    <div class="ca"><button class="cab-e" onclick="endCall()">üìµ</button><span class="cl">End</span></div>
    <div class="ca"><button class="cab-sp" onclick="toggleSpk()">üîà</button><span class="cl">Speaker</span></div>
  </div>
  <div class="inc-row hidden" id="inc-row">
    <div class="ca"><button style="background:var(--r);width:64px;height:64px;border-radius:50%;border:none;cursor:pointer;font-size:26px" onclick="rejectCall()">üìµ</button><span class="cl">Decline</span></div>
    <div class="ca"><button class="cab-a" style="width:64px;height:64px;border-radius:50%;border:none;cursor:pointer;font-size:26px" onclick="acceptCall()">üìû</button><span class="cl">Accept</span></div>
  </div>
</div>

<!-- NOTIFICATION TOAST -->
<div class="notif" id="notif" onclick="openNotif()">
  <div class="cav" id="notif-av" style="width:42px;height:42px;flex-shrink:0"></div>
  <div><div style="font-weight:600;font-size:14px;margin-bottom:2px" id="notif-name"></div><div style="font-size:13px;color:var(--t2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:230px" id="notif-msg"></div></div>
</div>

<!-- LIGHTBOX -->
<div class="lb" id="lb" onclick="closeLB()">
  <button style="position:absolute;top:14px;right:14px;background:none;border:none;color:#fff;font-size:30px;cursor:pointer" onclick="closeLB()">‚úï</button>
  <div class="lbc" id="lbc" onclick="event.stopPropagation()"></div>
</div>
<script>
const {Client,Databases,Account,Storage,ID,Query}=Appwrite;
const aw=new Client().setEndpoint('https://sgp.cloud.appwrite.io/v1').setProject('699b3d7d00390b3a9872');
const adb=new Databases(aw),aac=new Account(aw),ast=new Storage(aw);
const DID='699b3dd400282951055c';
const C={users:'users',messages:'messages',groups:'groups',status:'status_updates',contacts:'contacts',locked:'locked_chats',calls:'calls',communities:'communities'};

let me=null,myId=null,activeChat=null,replyMsg=null,ctxMsg=null;
let recorder=null,recChunks=[],recTimer=null,recSecs=0;
let pc=null,localStream=null,callInfo=null;
let scColor='#00a884',scType='text';
let svList=[],svIdx=0,svTimer=null;
let selMembers=[],scMode='newchat';
let activeFilter='all',lockedIds=[],pinUnlocked=false;
let allChats=[],allGroups=[],allContacts=[],appContacts=[];
let otpCode='',userPhone='',regAvatarFile=null,grpAvatarFile=null;
let fabOpen=false;

// ===== INIT =====
window.onload=async()=>{
  buildEmojis();
  if('Notification'in window)Notification.requestPermission();
  const saved=localStorage.getItem('ca_me');
  if(saved){me=JSON.parse(saved);myId=me.$id;showApp();}
  else goTo('welcome');
};
function goTo(id){document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));document.getElementById(id)?.classList.remove('hidden');}

// ===== OTP =====
function onPhInp(){const v=document.getElementById('ph-inp').value.trim();document.getElementById('ph-btn').disabled=v.length<6;}
async function sendOTP(){
  const phone=document.getElementById('ph-inp').value.trim();
  if(!phone)return;
  userPhone=phone.startsWith('+')?phone:'+91'+phone;
  otpCode=Math.floor(100000+Math.random()*900000).toString();
  localStorage.setItem('ca_otp',otpCode);localStorage.setItem('ca_otp_exp',Date.now()+300000);
  document.getElementById('otp-sub').textContent=`Enter the 6-digit code sent to ${userPhone}`;
  document.getElementById('demo-code').textContent=otpCode;
  document.getElementById('demo-box').style.display='block';
  goTo('otp-verify');setTimeout(()=>document.getElementById('ob0').focus(),300);
}
function obInp(i,el){if(el.value.length===1){if(i<5)document.getElementById('ob'+(i+1)).focus();checkOTP();}}
function obKey(i,e){if(e.key==='Backspace'&&!e.target.value&&i>0)document.getElementById('ob'+(i-1)).focus();}
function checkOTP(){const c=[0,1,2,3,4,5].map(i=>document.getElementById('ob'+i).value).join('');if(c.length===6)verifyOTP();}
async function verifyOTP(){
  const entered=[0,1,2,3,4,5].map(i=>document.getElementById('ob'+i)?.value||'').join('');
  const stored=localStorage.getItem('ca_otp'),exp=parseInt(localStorage.getItem('ca_otp_exp')||'0');
  if(Date.now()>exp){showErr('otp-err','OTP expired. Request a new one.');return;}
  if(entered!==stored){showErr('otp-err','Wrong code. Try again.');return;}
  try{
    const res=await adb.listDocuments(DID,C.users,[Query.equal('phone',[userPhone])]);
    if(res.documents.length>0){me=res.documents[0];myId=me.$id;localStorage.setItem('ca_me',JSON.stringify(me));showApp();}
    else goTo('otp-name');
  }catch(e){goTo('otp-name');}
}
function prevRegAv(e){const f=e.target.files[0];if(!f)return;regAvatarFile=f;const url=URL.createObjectURL(f);document.getElementById('reg-av').innerHTML=`<img src="${url}"><div class="name-av-edit">üì∑</div>`;}
async function finishSetup(){
  const name=v('name-inp');if(!name)return showErr('name-err','Please enter your name');
  const about=v('about-inp')||'Hey there! I am using ChatApp.';
  try{
    let avatar=null;
    if(regAvatarFile){try{const up=await ast.createFile('avatars',ID.unique(),regAvatarFile);avatar=`https://sgp.cloud.appwrite.io/v1/storage/buckets/avatars/files/${up.$id}/view?project=699b3d7d00390b3a9872`;}catch{}}
    const doc=await adb.createDocument(DID,C.users,ID.unique(),{phone:userPhone,name,about,avatar,is_online:true,last_seen:new Date().toISOString(),lock_pin:null});
    me=doc;myId=doc.$id;localStorage.setItem('ca_me',JSON.stringify(me));showApp();
  }catch(e){showErr('name-err','Setup failed: '+e.message+'\n\nNote: Create "users" collection in Appwrite Console first!');}
}

// ===== APP =====
function showApp(){
  goTo('app');document.getElementById('app').classList.remove('hidden');
  updateMyAv();loadChats();loadContacts();loadGroups();loadStatus();loadCalls();loadCommunities();loadLockedChats();
  subscribeRT();
  try{adb.updateDocument(DID,C.users,myId,{is_online:true,last_seen:new Date().toISOString()}).catch(()=>{});}catch{}
}
function logout(){
  try{adb.updateDocument(DID,C.users,myId,{is_online:false,last_seen:new Date().toISOString()}).catch(()=>{});}catch{}
  localStorage.removeItem('ca_me');me=null;myId=null;location.reload();
}

// ===== REALTIME =====
function subscribeRT(){
  try{
    aw.subscribe(`databases.${DID}.collections.${C.messages}.documents`,e=>{
      if(!e.payload)return;
      const msg=e.payload;
      if(activeChat&&((msg.sender_id===activeChat.id&&msg.receiver_id===myId)||(msg.sender_id===myId&&msg.receiver_id===activeChat.id)||(activeChat.type==='group'&&msg.group_id===activeChat.id))){
        if(!document.querySelector(`[data-mid="${msg.$id}"]`))appendMsg(msg);
      }
      if(msg.receiver_id===myId&&msg.sender_id!==myId){showNotif(msg);loadChats();}
    });
  }catch(e){console.warn('RT:',e.message);}
}

// ===== CONTACTS =====
async function loadContacts(){
  try{
    const res=await adb.listDocuments(DID,C.contacts,[Query.equal('user_id',[myId]),Query.limit(500)]);
    allContacts=res.documents;
    const details=await Promise.all(allContacts.map(c=>adb.getDocument(DID,C.users,c.contact_id).catch(()=>null)));
    appContacts=details.filter(Boolean);
    renderSCContacts();
  }catch(e){console.warn('Contacts:',e.message);appContacts=[];}
}
async function loadDeviceContacts(){
  if(!('contacts'in navigator&&'ContactsManager'in window)){alert('Contacts access requires Chrome on Android.\n\nYou can manually add contacts using "New contact".');return;}
  try{
    const dc=await navigator.contacts.select(['name','tel'],{multiple:true});
    let added=0;
    for(const c of dc){if(!c.tel?.length)continue;
      const phone=c.tel[0].replace(/[\s\-\(\)]/g,'');
      const fphone=phone.startsWith('+')?phone:'+91'+phone;
      try{
        const users=await adb.listDocuments(DID,C.users,[Query.equal('phone',[fphone])]);
        if(users.documents.length&&!allContacts.find(x=>x.contact_id===users.documents[0].$id)){
          await adb.createDocument(DID,C.contacts,ID.unique(),{user_id:myId,contact_id:users.documents[0].$id,nickname:c.name?.[0]||users.documents[0].name,is_favorite:false});
          added++;
        }
      }catch{}
    }
    await loadContacts();alert(`Synced! ${added} new contacts found on ChatApp.`);
  }catch(e){alert('Cannot access contacts: '+e.message);}
}
async function addContact(){
  const name=v('nc-name'),phone=v('nc-phone');
  if(!name||!phone)return;
  const fphone=phone.startsWith('+')?phone:'+91'+phone;
  try{
    const users=await adb.listDocuments(DID,C.users,[Query.equal('phone',[fphone])]);
    if(!users.documents.length)return showErr('nc-err','No ChatApp user with this number');
    const u=users.documents[0];
    if(allContacts.find(c=>c.contact_id===u.$id))return showErr('nc-err','Already in contacts');
    await adb.createDocument(DID,C.contacts,ID.unique(),{user_id:myId,contact_id:u.$id,nickname:name,is_favorite:false});
    closeModal('new-contact-modal');loadContacts();
  }catch(e){showErr('nc-err',e.message);}
}

// ===== SELECT CONTACT =====
function openSelContact(mode){
  scMode=mode;selMembers=[];
  document.getElementById('sc-title').textContent=mode==='newgroup'?'Add participants':'Select contact';
  document.getElementById('sc-s-inp').value='';
  document.getElementById('sc-actions').style.display=mode==='newgroup'?'none':'block';
  document.getElementById('sel-chips').className='sc-chips';
  document.getElementById('sc-next-btn').className='sc-next';
  renderSCContacts();
  closeDDM();closeFAB();
  goTo('sc-screen');
}
function closeSelContact(){if(me)goTo('app');else goTo('welcome');}
function renderSCContacts(filter=''){
  const total=appContacts.length;
  document.getElementById('sc-count').textContent=`${total} contact${total!==1?'s':''}`;
  const filtered=filter?appContacts.filter(u=>u.name?.toLowerCase().includes(filter.toLowerCase())||u.phone?.includes(filter)):appContacts;
  document.getElementById('sc-contacts').innerHTML=filtered.map(u=>{
    const isSel=selMembers.some(m=>m.id===u.$id);
    return `<div class="sc-c${isSel?' sel':''}" onclick="scClick('${u.$id}','${esc(u.name)}','${u.avatar||''}')">
      <div class="cav" style="width:48px;height:48px;flex-shrink:0">${avHTML(u.avatar,u.name,48)}</div>
      <div style="flex:1;min-width:0"><div style="font-size:15px;color:var(--t)">${esc(u.name)}</div><div style="font-size:13px;color:var(--t2)">${u.about||''}</div></div>
      ${scMode==='newgroup'?`<div class="sc-chk${isSel?' on':''}">‚úì</div>`:''}
    </div>`;
  }).join('')||'<div style="padding:24px;text-align:center;color:var(--t3);font-size:14px">No contacts on ChatApp yet.<br>Add contacts using "New contact"</div>';
}
async function filterSC(val){
  renderSCContacts(val);
  if(val.length>=7){
    const fp=val.startsWith('+')?val:'+91'+val;
    try{
      const users=await adb.listDocuments(DID,C.users,[Query.equal('phone',[fp])]);
      const pr=document.getElementById('sc-ph-res'),pl=document.getElementById('sc-ph-lbl');
      if(users.documents.length){
        pl.style.display='block';
        pr.innerHTML=users.documents.map(u=>`<div class="sc-c" onclick="scClick('${u.$id}','${esc(u.name)}','${u.avatar||''}')">
          <div class="cav" style="width:48px;height:48px;flex-shrink:0">${avHTML(u.avatar,u.name,48)}</div>
          <div><div style="font-size:15px;color:var(--t)">${esc(u.name)}</div><div style="font-size:13px;color:var(--t2)">${u.phone}</div></div>
        </div>`).join('');
      }else{pl.style.display='none';pr.innerHTML='';}
    }catch{document.getElementById('sc-ph-lbl').style.display='none';}
  }else{document.getElementById('sc-ph-lbl').style.display='none';document.getElementById('sc-ph-res').innerHTML='';}
}
function scClick(id,name,avatar){
  if(scMode==='newchat'){closeSelContact();openChat(id,name,avatar,'user');}
  else{
    const idx=selMembers.findIndex(m=>m.id===id);
    if(idx>=0)selMembers.splice(idx,1);else selMembers.push({id,name,avatar});
    renderSCContacts(document.getElementById('sc-s-inp').value);
    const chips=document.getElementById('sel-chips');
    chips.innerHTML=selMembers.map(m=>`<div class="mchip">${esc(m.name)}<span class="mcx" onclick="rmSel('${m.id}')">‚úï</span></div>`).join('');
    chips.className='sc-chips'+(selMembers.length?' show':'');
    document.getElementById('sc-next-btn').className='sc-next'+(selMembers.length?' show':'');
  }
}
function rmSel(id){selMembers=selMembers.filter(m=>m.id!==id);renderSCContacts();const chips=document.getElementById('sel-chips');chips.innerHTML=selMembers.map(m=>`<div class="mchip">${esc(m.name)}<span class="mcx" onclick="rmSel('${m.id}')">‚úï</span></div>`).join('');chips.className='sc-chips'+(selMembers.length?' show':'');document.getElementById('sc-next-btn').className='sc-next'+(selMembers.length?' show':'');}
function proceedSC(){
  if(scMode==='newgroup'&&selMembers.length>0){
    document.getElementById('grp-count').textContent=selMembers.length;
    document.getElementById('grp-chips').innerHTML=selMembers.map(m=>`<div class="mchip">${avHTML(m.avatar,m.name,28)}<span style="margin-left:6px">${esc(m.name)}</span></div>`).join('');
    goTo('grp-screen');
  }
}

// ===== GROUPS =====
async function loadGroups(){
  try{
    const res=await adb.listDocuments(DID,C.groups,[Query.contains('member_ids',[myId]),Query.limit(100)]);
    allGroups=res.documents;renderChatList();
  }catch(e){console.warn('Groups:',e.message);allGroups=[];}
}
function prevGrpAv(e){const f=e.target.files[0];if(!f)return;grpAvatarFile=f;const url=URL.createObjectURL(f);document.getElementById('grp-av-ph').outerHTML=`<img src="${url}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;}
async function createGroup(){
  const name=v('grp-name-inp');if(!name||!selMembers.length)return alert('Enter group name and select members');
  try{
    let avatar=null;
    if(grpAvatarFile){try{const up=await ast.createFile('avatars',ID.unique(),grpAvatarFile);avatar=`https://sgp.cloud.appwrite.io/v1/storage/buckets/avatars/files/${up.$id}/view?project=699b3d7d00390b3a9872`;}catch{}}
    const memberIds=[myId,...selMembers.map(m=>m.id)];
    const doc=await adb.createDocument(DID,C.groups,ID.unique(),{name,description:'',avatar,created_by:myId,member_ids:memberIds});
    goTo('app');selMembers=[];grpAvatarFile=null;
    openChat(doc.$id,name,avatar,'group');loadGroups();
  }catch(e){alert('Create group failed: '+e.message);}
}

// ===== LOCKED CHATS =====
async function loadLockedChats(){
  try{const res=await adb.listDocuments(DID,C.locked,[Query.equal('user_id',[myId])]);lockedIds=res.documents.map(r=>r.chat_id);}catch{lockedIds=[];}
}
async function lockActiveChat(){
  if(!activeChat)return;
  const u=await adb.getDocument(DID,C.users,myId).catch(()=>me);
  if(!u.lock_pin)return alert('Set a PIN first: Menu ‚Üí Locked chats');
  try{
    if(!lockedIds.includes(activeChat.id)){await adb.createDocument(DID,C.locked,ID.unique(),{user_id:myId,chat_id:activeChat.id,chat_type:activeChat.type});}
    await loadLockedChats();renderChatList();
    alert('Chat locked! Type your PIN in the search bar to reveal it.');
  }catch(e){alert(e.message);}
}
function openPinSetup(){closeModal('profile-modal');openModal('pin-modal');}
async function savePin(){
  const pin=v('pin-inp');if(!pin||pin.length<4)return alert('PIN must be at least 4 digits');
  try{await adb.updateDocument(DID,C.users,myId,{lock_pin:pin});me.lock_pin=pin;localStorage.setItem('ca_me',JSON.stringify(me));closeModal('pin-modal');alert('PIN set! Type it in search to reveal locked chats.');}catch(e){alert(e.message);}
}
async function removePin(){
  if(!confirm('Remove PIN? Locked chats will become visible again.'))return;
  try{await adb.updateDocument(DID,C.users,myId,{lock_pin:null});me.lock_pin=null;localStorage.setItem('ca_me',JSON.stringify(me));closeModal('pin-modal');}catch{}
}
async function openPinVerify(){
  const pin=prompt('Enter PIN to unlock hidden chats:');if(!pin)return;
  const u=await adb.getDocument(DID,C.users,myId).catch(()=>me);
  if(u.lock_pin&&pin===u.lock_pin){pinUnlocked=true;renderChatList();}else alert('Wrong PIN');
}

// ===== CHATS =====
async function loadChats(){
  try{
    const [sent,recv]=await Promise.all([
      adb.listDocuments(DID,C.messages,[Query.equal('sender_id',[myId]),Query.isNull('group_id'),Query.orderDesc('$createdAt'),Query.limit(300)]),
      adb.listDocuments(DID,C.messages,[Query.equal('receiver_id',[myId]),Query.isNull('group_id'),Query.orderDesc('$createdAt'),Query.limit(300)])
    ]);
    const all=[...sent.documents,...recv.documents].sort((a,b)=>new Date(b.$createdAt)-new Date(a.$createdAt));
    const seen=new Set();allChats=[];
    for(const m of all){const oid=m.sender_id===myId?m.receiver_id:m.sender_id;if(!seen.has(oid)){seen.add(oid);allChats.push({oid,lastMsg:m});}}
    renderChatList();
  }catch(e){console.warn('loadChats:',e.message);renderChatList();}
}
async function renderChatList(){
  const list=document.getElementById('tab-chats');
  const srch=document.getElementById('srch-inp')?.value.toLowerCase()||'';
  list.innerHTML='';
  if(!pinUnlocked&&lockedIds.length>0){
    const lh=document.createElement('div');lh.className='lk-hd';lh.onclick=openPinVerify;
    lh.innerHTML=`üîí <span>${lockedIds.length} locked chat${lockedIds.length>1?'s':''}</span><span style="margin-left:auto;font-size:12px;color:var(--g)">Tap to unlock</span>`;
    list.appendChild(lh);
  }
  let hasItems=false;
  for(const chat of allChats){
    if(lockedIds.includes(chat.oid)&&!pinUnlocked)continue;
    if(activeFilter==='grp')continue;
    try{
      const u=await adb.getDocument(DID,C.users,chat.oid).catch(()=>null);if(!u)continue;
      if(srch&&!u.name?.toLowerCase().includes(srch)&&!u.phone?.includes(srch))continue;
      if(activeFilter==='fav'){const c=allContacts.find(x=>x.contact_id===chat.oid);if(!c?.is_favorite)continue;}
      const m=chat.lastMsg,isMe=m.sender_id===myId;
      const lastTxt=m.type==='image'?'üì∑ Photo':m.type==='video'?'üìπ Video':m.type==='audio'?'üéµ Voice':m.type==='document'?'üìÑ Document':(m.content||'');
      const item=document.createElement('div');item.className='ci'+(activeChat?.id===chat.oid?' on':'');
      item.onclick=()=>openChat(chat.oid,u.name,u.avatar,'user');
      item.innerHTML=`<div class="cav">${avHTML(u.avatar,u.name,52)}${u.is_online?'<div class="od"></div>':''}</div>
        <div class="cbody"><div class="ctop"><div class="cname">${esc(u.name)}</div><div class="ctime">${fmtT(m.$createdAt)}</div></div>
        <div class="cbot">${lockedIds.includes(chat.oid)?'<span class="lkico">üîí</span>':''}<div class="clast">${isMe?'You: ':''}${esc(lastTxt)}</div></div></div>`;
      list.appendChild(item);hasItems=true;
    }catch{}
  }
  if(activeFilter!=='fav'){
    allGroups.filter(g=>!srch||g.name?.toLowerCase().includes(srch)).forEach(g=>{
      const item=document.createElement('div');item.className='ci'+(activeChat?.id===g.$id?' on':'');
      item.onclick=()=>openChat(g.$id,g.name,g.avatar,'group');
      item.innerHTML=`<div class="cav">${avHTML(g.avatar,g.name,52)}</div>
        <div class="cbody"><div class="ctop"><div class="cname">${esc(g.name)}</div><div class="ctime">${fmtT(g.$updatedAt||g.$createdAt)}</div></div>
        <div class="cbot"><div class="clast">üë• Group ¬∑ ${(g.member_ids||[]).length} members</div></div></div>`;
      list.appendChild(item);hasItems=true;
    });
  }
  if(!hasItems)list.innerHTML+='<div style="padding:40px;text-align:center;color:var(--t3);font-size:14px;line-height:1.8">No chats yet.<br>Tap the <strong style="color:var(--g)">+</strong> button to start!</div>';
}
async function onSrch(val){
  if(val.length>=4){
    const u=await adb.getDocument(DID,C.users,myId).catch(()=>me);
    if(u.lock_pin&&val===u.lock_pin){pinUnlocked=true;renderChatList();return;}
  }
  if(!val)pinUnlocked=false;
  renderChatList();
}
function setFilter(f,el){activeFilter=f;document.querySelectorAll('.pill').forEach(p=>p.classList.remove('on'));el.classList.add('on');renderChatList();}

// ===== OPEN CHAT =====
async function openChat(id,name,avatar,type='user'){
  activeChat={id,name,avatar,type};
  if(window.innerWidth<=768){document.getElementById('sidebar').classList.add('hide');document.getElementById('chat-panel').classList.add('show');}
  document.getElementById('chat-panel').innerHTML=buildChatUI(name,avatar,type);
  buildEmojis();
  if(type==='user'){
    try{const u=await adb.getDocument(DID,C.users,id);const st=document.getElementById('cp-st');st.textContent=u.is_online?'online':(u.last_seen?'last seen '+fmtT(u.last_seen):'last seen recently');if(u.is_online)st.style.color='var(--g)';}catch{}
  }else{document.getElementById('cp-st').textContent='Group';}
  await loadMsgs(id,type);
  renderChatList();
}
function buildChatUI(name,avatar,type){
  return `<div class="cp-hd">
    <button class="cp-back" onclick="goBackCP()">‚Üê</button>
    <div class="cp-av" onclick="openContactInfo()" id="cp-av">${avHTML(avatar,name,40)}</div>
    <div class="cp-info" onclick="openContactInfo()"><div class="cp-nm">${esc(name)}</div><div class="cp-st" id="cp-st">tap for info</div></div>
    <div class="cp-acts">
      <button class="hbt" onclick="makeCall('video')" title="Video call"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg></button>
      <button class="hbt" onclick="makeCall('voice')" title="Voice call"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 11.5 19.79 19.79 0 01.01 2.88 2 2 0 012 .71h3a2 2 0 012 1.72 19.79 19.79 0 00.7 2.81 2 2 0 01-.45 2.11L6.09 8.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 19.79 19.79 0 002.81.7A2 2 0 0122 16.92z"/></svg></button>
      <button class="hbt" onclick="openDDM('cmenu',event)"><svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="5" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="19" r="1.5"/></svg></button>
    </div>
  </div>
  <div class="msgs" id="msgs"></div>
  <div class="ti" id="ti"><div class="tb"><div class="td"></div><div class="td"></div><div class="td"></div></div></div>
  <div class="rstrip" id="rstrip"><div class="ri"><div class="ra" id="ra"></div><div class="rt" id="rt"></div></div><span style="cursor:pointer;font-size:20px;color:var(--t2)" onclick="cancelReply()">‚úï</span></div>
  <div class="iarea">
    <div class="iico" onclick="toggleEP()"><svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="1.8"/><path d="M8 14s1.5 2 4 2 4-2 4-2M9 9h.01M15 9h.01" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg></div>
    <div class="iico" onclick="toggleAM()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg></div>
    <div class="recs" id="recs"><div class="recdot"></div><div class="rect" id="rect">0:00</div><span class="recx" onclick="cancelRec()">‚úï</span></div>
    <div class="msgbox" id="msgbox"><textarea id="mi" rows="1" placeholder="Message" oninput="onMI()" onkeydown="onMK(event)"></textarea></div>
    <button class="sndbtn hidden" id="sndb" onclick="sendMsg()"><svg viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round"/></svg></button>
    <button class="vcbtn" id="vcb" onclick="toggleRec()"><svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round"/><path d="M19 10v2a7 7 0 01-14 0v-2M12 19v4M8 23h8" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg></button>
  </div>
  <div class="ep" id="ep"><div class="eg" id="eg"></div></div>
  <div class="am" id="am">
    <div class="ao" onclick="trigF('image/*')"><div class="ao-ic" style="background:#9c27b0">üñºÔ∏è</div><div class="ao-l">Photos</div></div>
    <div class="ao" onclick="trigF('video/*')"><div class="ao-ic" style="background:#f44336">üìπ</div><div class="ao-l">Video</div></div>
    <div class="ao" onclick="trigF('audio/*')"><div class="ao-ic" style="background:#2196f3">üéµ</div><div class="ao-l">Audio</div></div>
    <div class="ao" onclick="trigF('*/*')"><div class="ao-ic" style="background:#4caf50">üìÑ</div><div class="ao-l">Document</div></div>
    <div class="ao" onclick="document.getElementById('cam-in').click()"><div class="ao-ic" style="background:#ff9800">üì∑</div><div class="ao-l">Camera</div></div>
  </div>
  <input type="file" id="fi" style="display:none" onchange="onFSel(event)">
  <input type="file" id="cam-in" capture="environment" accept="image/*" style="display:none" onchange="onFSel(event)">`;
}

// ===== MESSAGES =====
async function loadMsgs(id,type){
  const area=document.getElementById('msgs');if(!area)return;
  try{
    let msgs=[];
    if(type==='group'){
      const r=await adb.listDocuments(DID,C.messages,[Query.equal('group_id',[id]),Query.orderAsc('$createdAt'),Query.limit(200)]);
      msgs=r.documents;
    }else{
      const[s,r]=await Promise.all([
        adb.listDocuments(DID,C.messages,[Query.equal('sender_id',[myId]),Query.equal('receiver_id',[id]),Query.orderAsc('$createdAt'),Query.limit(200)]),
        adb.listDocuments(DID,C.messages,[Query.equal('sender_id',[id]),Query.equal('receiver_id',[myId]),Query.orderAsc('$createdAt'),Query.limit(200)])
      ]);
      msgs=[...s.documents,...r.documents].sort((a,b)=>new Date(a.$createdAt)-new Date(b.$createdAt));
    }
    area.innerHTML='';let lastDate='';
    for(const m of msgs){const d=new Date(m.$createdAt).toLocaleDateString();if(d!==lastDate){area.appendChild(mkDSep(d));lastDate=d;}appendMsg(m,false);}
    scrollB();
  }catch(e){console.warn('loadMsgs:',e.message);}
}
function appendMsg(msg,scroll=true){
  const area=document.getElementById('msgs');if(!area||document.querySelector(`[data-mid="${msg.$id}"]`))return;
  const isOut=msg.sender_id===myId;
  const wrap=document.createElement('div');wrap.className=`mw ${isOut?'out':'in'}`;
  wrap.dataset.mid=msg.$id;wrap.dataset.c=msg.content||'';wrap.dataset.t=msg.type||'text';wrap.dataset.sid=msg.sender_id;
  let grav=isOut?'':`<div class="mgav">${avHTML(msg.sender_avatar||null,msg.sender_name||'U',28)}</div>`;
  let content='';
  if(msg.deleted){content='<span class="del-m">üö´ This message was deleted</span>';}
  else{
    if(msg.forwarded)content+='<div class="fwdbdg">‚Ü™Ô∏è Forwarded</div>';
    if(msg.reply_to&&msg.reply_content!==undefined)content+=`<div class="rqb"><div class="rqa">${esc(msg.reply_sender_name||'')}</div><div class="rqt">${esc(msg.reply_content||'')}</div></div>`;
    if(activeChat?.type==='group'&&!isOut)content+=`<div class="gsn" style="color:${nColor(msg.sender_name||'')}">${esc(msg.sender_name||'')}</div>`;
    if(msg.type==='image')content+=`<img class="m-img" src="${msg.media_url}" onclick="openLB('image','${msg.media_url}')" loading="lazy">`;
    else if(msg.type==='video')content+=`<video class="m-vid" src="${msg.media_url}" controls></video>`;
    else if(msg.type==='audio')content+=`<audio class="m-aud" src="${msg.media_url}" controls></audio>`;
    else if(msg.type==='document')content+=`<div class="m-doc" onclick="window.open('${msg.media_url}')"><span style="font-size:28px">üìÑ</span><div><div style="font-size:13px;font-weight:500">${esc(msg.media_url?.split('/').pop()||'File')}</div><div style="font-size:11px;color:var(--t2)">Tap to open</div></div></div>`;
    else content+=esc(msg.content||'').replace(/\n/g,'<br>');
  }
  const time=new Date(msg.$createdAt).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  const tck=isOut&&!msg.deleted?`<span class="tck${msg.read?' r':''}">‚úì‚úì</span>`:'';
  const star=msg.starred?'‚≠ê':'';
  wrap.innerHTML=`${grav}<div class="mb" oncontextmenu="openCtx(event,'${msg.$id}')" ontouchstart="onTS(event,'${msg.$id}')" ontouchend="onTE()">
    <div class="bi">${content}<div class="mt">${star}${time}${tck}</div></div>
  </div>`;
  area.appendChild(wrap);if(scroll)scrollB();
}
function mkDSep(d){const n=new Date().toLocaleDateString(),y=new Date(Date.now()-86400000).toLocaleDateString();const div=document.createElement('div');div.className='dsep';div.innerHTML=`<span>${d===n?'Today':d===y?'Yesterday':d}</span>`;return div;}
function scrollB(){const a=document.getElementById('msgs');if(a)a.scrollTop=a.scrollHeight;}

// ===== SEND =====
async function sendMsg(){
  const inp=document.getElementById('mi');if(!inp)return;
  const txt=inp.value.trim();if(!txt||!activeChat)return;
  inp.value='';autoR(inp);onMI();
  try{
    const data={sender_id:myId,content:txt,type:'text',deleted:false,starred:false,forwarded:false,read:false,sender_name:me.name,sender_avatar:me.avatar||null};
    if(activeChat.type==='group')data.group_id=activeChat.id;else data.receiver_id=activeChat.id;
    if(replyMsg){data.reply_to=replyMsg.id;data.reply_content=replyMsg.c;data.reply_sender_name=replyMsg.sn;cancelReply();}
    const doc=await adb.createDocument(DID,C.messages,ID.unique(),data);
    if(!document.querySelector(`[data-mid="${doc.$id}"]`))appendMsg(doc);
    loadChats();
  }catch(e){alert('Send failed: '+e.message);}
}
async function sendFile(file,type){
  if(!activeChat)return;
  try{
    let mediaUrl=null;
    try{const up=await ast.createFile('media',ID.unique(),file);mediaUrl=`https://sgp.cloud.appwrite.io/v1/storage/buckets/media/files/${up.$id}/view?project=699b3d7d00390b3a9872`;}
    catch{const fr=new FileReader();mediaUrl=await new Promise(r=>{fr.onload=e=>r(e.target.result);fr.readAsDataURL(file);});}
    const data={sender_id:myId,type,media_url:mediaUrl,deleted:false,starred:false,forwarded:false,read:false,sender_name:me.name,sender_avatar:me.avatar||null};
    if(activeChat.type==='group')data.group_id=activeChat.id;else data.receiver_id=activeChat.id;
    if(replyMsg){data.reply_to=replyMsg.id;cancelReply();}
    const doc=await adb.createDocument(DID,C.messages,ID.unique(),data);
    if(!document.querySelector(`[data-mid="${doc.$id}"]`))appendMsg(doc);
    loadChats();
  }catch(e){console.error(e);}
}
function onFSel(e){const f=e.target.files[0];if(!f)return;let t='document';if(f.type.startsWith('image/'))t='image';else if(f.type.startsWith('video/'))t='video';else if(f.type.startsWith('audio/'))t='audio';sendFile(f,t);e.target.value='';}
function trigF(acc){closeAll();const el=document.getElementById('fi');el.accept=acc;el.click();}
function onMI(){const inp=document.getElementById('mi');if(!inp)return;autoR(inp);const h=inp.value.trim().length>0;document.getElementById('sndb')?.classList.toggle('hidden',!h);document.getElementById('vcb')?.classList.toggle('hidden',h);}
function onMK(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}}
function autoR(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,130)+'px';}

// ===== VOICE REC =====
async function toggleRec(){
  if(recorder?.state==='recording'){stopRec();return;}
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    recorder=new MediaRecorder(stream);recChunks=[];
    recorder.ondataavailable=e=>recChunks.push(e.data);recorder.onstop=sendVoice;recorder.start();
    document.getElementById('recs').classList.add('on');document.getElementById('msgbox').style.display='none';document.getElementById('vcb').classList.add('rec');
    recSecs=0;recTimer=setInterval(()=>{recSecs++;const m=Math.floor(recSecs/60),s=recSecs%60;document.getElementById('rect').textContent=`${m}:${s.toString().padStart(2,'0')}`;},1000);
  }catch{alert('Microphone denied');}
}
function stopRec(){recorder?.stop();recorder?.stream?.getTracks().forEach(t=>t.stop());clearInterval(recTimer);document.getElementById('recs')?.classList.remove('on');document.getElementById('msgbox').style.display='';document.getElementById('vcb')?.classList.remove('rec');}
function cancelRec(){recChunks=[];stopRec();}
function sendVoice(){if(!recChunks.length)return;const blob=new Blob(recChunks,{type:'audio/webm'});sendFile(new File([blob],'voice.webm',{type:'audio/webm'}),'audio');}

// ===== EMOJI =====
const EMJIS='üòÄüòÉüòÑüòÅüòÜüòÖü§£üòÇüôÇüòâüòäüòáü•∞üòçü§©üòòüòöüòãüòõüòúü§™üòùü§ëü§óü§≠ü§´ü§îüòêüòëüò∂üòèüòíüôÑüò¨ü§•üòåüòîüò™üò¥üò∑ü§íü§¢ü§ßü•µü•∂üòµü§Øü§†ü•≥üòéü§ìüòïüòüüòÆüò≤üò≥ü•∫üò¶üòßüò®üò¢üò≠üò±üò§üò°üò†ü§¨üòàüëøüíÄ‚ò†Ô∏èüëãü§ö‚úãüëå‚úåÔ∏èü§ûüëçüëé‚ù§Ô∏èüß°üíõüíöüíôüíúüñ§üíîüíïüíØüéâüéäüéàüî•üíßüåäüçéüçïüçîüåÆüç∞üéÇ‚òïüç∫üéÆüéØüèÜüéµüé∂üé§üì±üíªüì∑üåà‚≠êüåô‚òÄÔ∏èüå∏ü¶ãüê∂üê±üêòü¶Åüåçüè†üöÄ‚úàÔ∏èüé∏‚ùì‚úÖüôè';
function buildEmojis(){const eg=document.getElementById('eg');if(!eg)return;eg.innerHTML=[...EMJIS].map(e=>`<div class="ei" onclick="insE('${e}')">${e}</div>`).join('');}
function insE(e){const inp=document.getElementById('mi');if(!inp)return;const p=inp.selectionStart;inp.value=inp.value.slice(0,p)+e+inp.value.slice(p);inp.selectionStart=inp.selectionEnd=p+e.length;inp.focus();onMI();}
function toggleEP(){const p=document.getElementById('ep');document.getElementById('am')?.classList.remove('on');p?.classList.toggle('on');}
function toggleAM(){const a=document.getElementById('am');document.getElementById('ep')?.classList.remove('on');a?.classList.toggle('on');}

// ===== CONTEXT =====
let touchTimer=null;
function onTS(e,id){touchTimer=setTimeout(()=>openCtx(e,id),600);}
function onTE(){clearTimeout(touchTimer);}
function openCtx(e,id){
  e.preventDefault();
  const el=document.querySelector(`[data-mid="${id}"]`);
  ctxMsg=el?{id,c:el.dataset.c,t:el.dataset.t,sid:el.dataset.sid,sn:el.dataset.sn||''}:null;
  const m=document.getElementById('ctx');
  m.style.left=Math.min((e.clientX||100),window.innerWidth-200)+'px';
  m.style.top=Math.min((e.clientY||200),window.innerHeight-280)+'px';
  m.classList.add('on');
}
function ctxReply(){closeAll();if(!ctxMsg)return;replyMsg=ctxMsg;const s=document.getElementById('rstrip');s.style.display='flex';document.getElementById('ra').textContent=ctxMsg.sid===myId?'You':(ctxMsg.sn||'User');document.getElementById('rt').textContent=ctxMsg.c||'[Media]';document.getElementById('mi')?.focus();}
function cancelReply(){replyMsg=null;const s=document.getElementById('rstrip');if(s)s.style.display='none';}
function ctxCopy(){closeAll();navigator.clipboard.writeText(ctxMsg?.c||'').catch(()=>{});}
function ctxForward(){closeAll();alert('Forward feature: Select a contact to forward to');}
async function ctxStar(){closeAll();if(!ctxMsg)return;try{await adb.updateDocument(DID,C.messages,ctxMsg.id,{starred:true});const el=document.querySelector(`[data-mid="${ctxMsg.id}"] .mt`);if(el)el.innerHTML='‚≠ê'+el.innerHTML;}catch{}}
function ctxInfo(){closeAll();if(ctxMsg)alert('Message info\nSent at: '+new Date().toLocaleString());}
async function ctxDel(){
  closeAll();if(!ctxMsg)return;
  const fe=ctxMsg.sid===myId&&confirm('Delete for everyone?');
  try{
    if(fe)await adb.updateDocument(DID,C.messages,ctxMsg.id,{deleted:true,content:null,media_url:null});
    const el=document.querySelector(`[data-mid="${ctxMsg.id}"]`);
    if(el){const bi=el.querySelector('.bi');if(bi)bi.innerHTML='<span class="del-m">üö´ This message was deleted</span><div class="mt">'+new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+'</div>';}
  }catch{}
}
async function sendR(emoji){closeAll();if(!ctxMsg)return;alert(`Reacted ${emoji} ‚Äî Reactions require a reactions collection in Appwrite`);}

// ===== PROFILE =====
function openProfile(){
  closeDDM();
  document.getElementById('pm-name').textContent=me.name;
  document.getElementById('pm-phone').textContent=me.phone||'';
  document.getElementById('pm-about').textContent=me.about||'';
  document.getElementById('pm-av').innerHTML=avHTML(me.avatar,me.name,84)+'<div class="pav-ov">üì∑</div>';
  openModal('profile-modal');
}
async function uploadAv(e){
  const f=e.target.files[0];if(!f)return;
  try{
    let url=null;
    try{const up=await ast.createFile('avatars',ID.unique(),f);url=`https://sgp.cloud.appwrite.io/v1/storage/buckets/avatars/files/${up.$id}/view?project=699b3d7d00390b3a9872`;}
    catch{const fr=new FileReader();url=await new Promise(r=>{fr.onload=ev=>r(ev.target.result);fr.readAsDataURL(f);});}
    await adb.updateDocument(DID,C.users,myId,{avatar:url});
    me.avatar=url;localStorage.setItem('ca_me',JSON.stringify(me));updateMyAv();openProfile();
  }catch(e){alert(e.message);}
}
async function editF(field){
  const val=prompt(`Edit ${field}:`,me[field]||'');if(val===null)return;
  try{
    await adb.updateDocument(DID,C.users,myId,{[field]:val});
    me[field]=val;localStorage.setItem('ca_me',JSON.stringify(me));openProfile();
  }catch(e){alert(e.message);}
}
function updateMyAv(){const el=document.getElementById('myav');if(el)el.innerHTML=avHTML(me?.avatar,me?.name,38);}

// ===== CONTACT INFO =====
async function openContactInfo(){
  if(!activeChat||activeChat.type!=='user')return;
  try{
    const u=await adb.getDocument(DID,C.users,activeChat.id);
    document.getElementById('cm-av').innerHTML=avHTML(u.avatar,u.name,84);
    document.getElementById('cm-name').textContent=u.name;
    document.getElementById('cm-phone').textContent=u.phone||'';
    document.getElementById('cm-about').textContent=u.about||'';
    document.getElementById('cm-ls').textContent=u.is_online?'Online':(u.last_seen?'last seen '+fmtT(u.last_seen):'Unknown');
    openModal('contact-modal');
  }catch{}
}
async function addToContacts(){
  if(!activeChat||activeChat.type!=='user')return;
  const name=prompt('Save contact as:',activeChat.name);if(!name)return;
  try{
    if(allContacts.find(c=>c.contact_id===activeChat.id))return alert('Already in contacts');
    await adb.createDocument(DID,C.contacts,ID.unique(),{user_id:myId,contact_id:activeChat.id,nickname:name,is_favorite:false});
    await loadContacts();alert('Contact saved!');
  }catch(e){alert(e.message);}
}
function muteChat(){alert('Chat muted (notifications off for this chat)');}
function clearChat(){const a=document.getElementById('msgs');if(a)a.innerHTML='';}
function blockUser(){if(confirm('Block this user? They cannot send you messages.'))alert('User blocked');}

// ===== STATUS =====
let myStatuses=[],othersStatuses=[];
async function loadStatus(){
  try{
    const now=new Date().toISOString();
    const all=await adb.listDocuments(DID,C.status,[Query.greaterThan('expires_at',[now]),Query.orderDesc('$createdAt'),Query.limit(200)]);
    myStatuses=all.documents.filter(s=>s.user_id===myId);
    const others=all.documents.filter(s=>s.user_id!==myId&&appContacts.some(c=>c.$id===s.user_id));
    const byUser={};others.forEach(s=>{if(!byUser[s.user_id])byUser[s.user_id]=[];byUser[s.user_id].push(s);});
    othersStatuses=Object.values(byUser);
    renderUpdates();
  }catch(e){console.warn('Status:',e.message);renderUpdates();}
}
async function renderUpdates(){
  const sc=document.getElementById('tab-updates');
  let html=`<div class="my-s" onclick="myStatuses.length?viewStatus(myStatuses,me.name,me.avatar):openSC()">
    <div class="sav-wrap"><div class="sav">${avHTML(me?.avatar,me?.name,52)}</div><div class="s-plus">+</div></div>
    <div><div style="font-size:15px;color:var(--t);margin-bottom:3px">My status</div><div style="font-size:13px;color:var(--t2)">${myStatuses.length?`${myStatuses.length} update${myStatuses.length>1?'s':''}`:' Tap to add status update'}</div></div>
  </div>`;
  if(othersStatuses.length){
    html+='<div class="sec-t">Recent updates</div>';
    othersStatuses.forEach(uStatuses=>{
      const s=uStatuses[0];const viewed=uStatuses.every(x=>(x.views||[]).includes(myId));
      html+=`<div class="scard" onclick="viewStatus(${JSON.stringify(uStatuses).replace(/"/g,'&quot;')},'${esc(s.name||'')}','${s.avatar||''}')">
        <div class="sring ${viewed?'seen':'new'}"><div class="sav" style="width:48px;height:48px">${avHTML(s.avatar,s.name,48)}</div></div>
        <div style="flex:1;min-width:0"><div style="font-size:15px;color:var(--t)">${esc(s.name||'')}</div><div style="font-size:13px;color:var(--t2)">${fmtT(s.$createdAt)}</div></div>
      </div>`;
    });
  }
  html+=`<div style="border-top:8px solid var(--p2);margin-top:4px"></div><div class="sec-t">Channels <button onclick="loadChannels()" style="float:right;margin-top:-4px;background:var(--p2);border:none;color:var(--g);border-radius:20px;padding:6px 16px;font-size:13px;cursor:pointer;font-family:'Roboto',sans-serif">Explore</button></div><div id="ch-list"></div>`;
  sc.innerHTML=html;loadChannels();
}
const DEFAULT_CHANNELS=[{id:'ch1',name:'ChatApp',desc:'Official ChatApp updates',verified:true,followers:500000000},{id:'ch2',name:'Tech Daily',desc:'Latest technology news',verified:true,followers:2500000},{id:'ch3',name:'Sports Hub',desc:'Scores & highlights',verified:false,followers:1200000},{id:'ch4',name:'Breaking News',desc:'24/7 news updates',verified:true,followers:5000000}];
async function loadChannels(){
  const list=document.getElementById('ch-list');if(!list)return;
  list.innerHTML=DEFAULT_CHANNELS.map(ch=>{
    const f=ch.followers>=1e6?(ch.followers/1e6).toFixed(1)+'M':ch.followers>=1e3?(ch.followers/1e3).toFixed(0)+'K':ch.followers;
    return`<div class="chcard"><div class="chav">${avHTML(null,ch.name,48)}</div>
      <div style="flex:1;min-width:0"><div style="display:flex;align-items:center;gap:5px;font-size:15px;color:var(--t)">${esc(ch.name)}${ch.verified?'<span class="vbdg">‚úì</span>':''}</div><div style="font-size:13px;color:var(--t2)">${f} followers</div></div>
      <button class="folbtn" onclick="this.textContent='Following';this.classList.add('on')">Follow</button>
    </div>`;
  }).join('');
}

// ===== STATUS VIEWER =====
function viewStatus(statuses,name,avatar){
  if(typeof statuses==='string')statuses=JSON.parse(statuses);
  svList=statuses;svIdx=0;
  document.getElementById('sv-name').textContent=name;
  document.getElementById('sv-av').innerHTML=avHTML(avatar,name,38);
  document.getElementById('svo').classList.add('on');
  showSVAt(0);
}
function showSVAt(idx){
  clearTimeout(svTimer);if(idx>=svList.length){closeSVO();return;}svIdx=idx;
  const s=svList[idx];
  document.getElementById('sv-time').textContent=fmtT(s.$createdAt||s.created_at);
  const prog=document.getElementById('svpg');
  prog.innerHTML=svList.map((_,i)=>`<div class="svseg"><div class="svfill" id="svf-${i}"></div></div>`).join('');
  for(let i=0;i<idx;i++){const f=document.getElementById('svf-'+i);if(f)f.style.width='100%';}
  const dur=s.type==='video'?10000:5000;
  const fill=document.getElementById('svf-'+idx);
  if(fill){fill.style.transition=`width ${dur}ms linear`;setTimeout(()=>fill.style.width='100%',50);}
  const cont=document.getElementById('svcont');
  if(s.type==='text'){cont.style.background=s.bg_color||'#00a884';cont.innerHTML=`<div class="svtxt">${esc(s.content||'')}</div>`;}
  else if(s.type==='image'){cont.style.background='#000';cont.innerHTML=`<img src="${s.media_url}">${s.content?`<div style="position:absolute;bottom:80px;left:16px;right:16px;background:rgba(0,0,0,0.5);padding:8px 12px;border-radius:8px;font-size:14px;color:#fff;text-align:center">${esc(s.content)}</div>`:''}`;} 
  else if(s.type==='video'){cont.style.background='#000';cont.innerHTML=`<video src="${s.media_url}" autoplay controls style="max-width:100%;max-height:80vh">${s.content?`<div style="position:absolute;bottom:80px;left:16px;right:16px;background:rgba(0,0,0,0.5);padding:8px;border-radius:8px;font-size:14px;color:#fff;text-align:center">${esc(s.content)}</div>`:''}</video>`;}
  try{adb.updateDocument(DID,C.status,s.$id,{views:[...(s.views||[]),myId].filter((v,i,a)=>a.indexOf(v)===i)}).catch(()=>{});}catch{}
  svTimer=setTimeout(()=>showSVAt(idx+1),dur);
}
function svPrev(){showSVAt(Math.max(0,svIdx-1));}
function svNext(){showSVAt(svIdx+1);}
function closeSVO(){clearTimeout(svTimer);document.getElementById('svo').classList.remove('on');}
function sendSVRep(){const v=document.getElementById('sv-rep').value.trim();if(v){alert('Replied: '+v);document.getElementById('sv-rep').value='';}}

// ===== STATUS CREATE =====
function openSC(){closeDDM();document.getElementById('sco').classList.add('on');}
function closeSC(){document.getElementById('sco').classList.remove('on');}
function setSCT(t){scType=t;document.getElementById('sct-text').className='sctab'+(t==='text'?' on':'');document.getElementById('sct-photo').className='sctab'+(t==='photo'?' on':'');document.getElementById('sc-tv').style.display=t==='text'?'flex':'none';document.getElementById('sc-pv').style.display=t==='photo'?'flex':'none';}
function pickSCC(el){document.querySelectorAll('.csw').forEach(c=>c.classList.remove('on'));el.classList.add('on');scColor=el.dataset.c;const p=document.getElementById('sc-txt-prev');if(p)p.style.background=scColor;}
function onSCTxt(el){const p=document.getElementById('sc-txt-prev');if(p)p.textContent=el.value||'Your text here‚Ä¶';}
function onSCMedia(e){const f=e.target.files[0];if(!f)return;const url=URL.createObjectURL(f);const p=document.getElementById('sc-ph-prev');p.innerHTML=f.type.startsWith('image/')?`<img src="${url}" style="max-width:100%;max-height:55vh;border-radius:8px;object-fit:contain">`:`<video src="${url}" controls style="max-width:100%;max-height:55vh;border-radius:8px"></video>`;}
async function postStatus(){
  const fd={user_id:myId,deleted:false,views:[]};
  const expires=new Date(Date.now()+86400000).toISOString();fd.expires_at=expires;
  if(scType==='text'){const txt=document.getElementById('sc-txt-inp')?.value.trim();if(!txt)return alert('Type something first');fd.content=txt;fd.type='text';fd.bg_color=scColor;}
  else{const f=document.getElementById('sc-media-inp')?.files[0];if(!f)return alert('Select a photo or video');
    try{const up=await ast.createFile('media',ID.unique(),f);fd.media_url=`https://sgp.cloud.appwrite.io/v1/storage/buckets/media/files/${up.$id}/view?project=699b3d7d00390b3a9872`;}
    catch{const fr=new FileReader();fd.media_url=await new Promise(r=>{fr.onload=ev=>r(ev.target.result);fr.readAsDataURL(f);});}
    fd.type=f.type.startsWith('video/')?'video':'image';
    const cap=document.getElementById('sc-cap')?.value.trim();if(cap)fd.content=cap;
  }
  try{await adb.createDocument(DID,C.status,ID.unique(),fd);closeSC();loadStatus();}catch(e){alert('Post failed: '+e.message);}
}

// ===== COMMUNITIES =====
async function loadCommunities(){
  try{
    const res=await adb.listDocuments(DID,C.communities,[Query.contains('member_ids',[myId]),Query.limit(100)]);
    const sc=document.getElementById('tab-communities');
    let html=`<div class="nc-item" onclick="openModal('new-comm-modal')"><div class="nc-ico">üèòÔ∏è<div class="nc-plus">+</div></div><div><div style="font-size:16px;color:var(--t);margin-bottom:3px">New community</div><div style="font-size:13px;color:var(--t2)">Create a community with groups</div></div></div>`;
    res.documents.forEach(c=>{html+=`<div class="comm-item"><div class="comm-av">${avHTML(c.avatar,c.name,52)}</div><div style="flex:1"><div style="font-size:15px;font-weight:500;color:var(--t);margin-bottom:4px">${esc(c.name)}</div><div style="font-size:13px;color:var(--t2);margin-bottom:6px">${esc(c.description||'Community')}</div></div></div>`;});
    if(!res.documents.length)html+='<div style="padding:24px;text-align:center;color:var(--t3);font-size:14px">No communities yet.<br>Create one to connect groups!</div>';
    sc.innerHTML=html;
  }catch(e){console.warn('Communities:',e.message);}
}
async function createCommunity(){
  const name=v('comm-name');if(!name)return;
  try{await adb.createDocument(DID,C.communities,ID.unique(),{name,description:v('comm-desc'),avatar:null,created_by:myId,member_ids:[myId]});closeModal('new-comm-modal');loadCommunities();}
  catch(e){alert('Failed: '+e.message);}
}

// ===== CALLS =====
async function loadCalls(){
  try{
    const[s,r]=await Promise.all([adb.listDocuments(DID,C.calls,[Query.equal('caller_id',[myId]),Query.orderDesc('$createdAt'),Query.limit(50)]),adb.listDocuments(DID,C.calls,[Query.equal('receiver_id',[myId]),Query.orderDesc('$createdAt'),Query.limit(50)])]);
    const calls=[...s.documents,...r.documents].sort((a,b)=>new Date(b.$createdAt)-new Date(a.$createdAt));
    const sc=document.getElementById('tab-calls');
    if(appContacts.length){
      let fh=`<div style="padding:14px 16px 8px;font-size:13px;color:var(--t2);font-weight:500">Favorites</div><div style="display:flex;gap:16px;padding:0 16px 14px;overflow-x:auto;scrollbar-width:none;border-bottom:1px solid var(--bd)">`;
      appContacts.slice(0,6).forEach(c=>{fh+=`<div style="display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;min-width:60px" onclick="openChat('${c.$id}','${esc(c.name)}','${c.avatar||''}','user')"><div class="cav" style="width:52px;height:52px">${avHTML(c.avatar,c.name,52)}</div><div style="font-size:12px;color:var(--t2);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60px">${esc(c.name.split(' ')[0])}</div></div>`;});
      fh+='</div>';sc.innerHTML=fh;
    }else sc.innerHTML='';
    sc.innerHTML+=`<div style="padding:10px 16px 5px;font-size:13px;color:var(--t2);font-weight:500">Recent</div>`;
    if(!calls.length){sc.innerHTML+='<div style="padding:32px;text-align:center;color:var(--t3);font-size:14px">No recent calls</div>';return;}
    const uCache={};
    for(const c of calls){
      const isOut=c.caller_id===myId;const oid=isOut?c.receiver_id:c.caller_id;
      if(!uCache[oid]){try{uCache[oid]=await adb.getDocument(DID,C.users,oid);}catch{uCache[oid]={name:'Unknown',avatar:null};}}
      const u=uCache[oid];const isMissed=c.status==='missed'&&!isOut;
      const arrow=isMissed?'‚ÜôÔ∏è':isOut?'‚ÜóÔ∏è':'‚ÜôÔ∏è';const arrowColor=isMissed?'var(--r)':'var(--g)';
      sc.innerHTML+=`<div class="call-item">
        <div class="cav" style="width:48px;height:48px">${avHTML(u.avatar,u.name,48)}</div>
        <div style="flex:1;min-width:0"><div style="font-size:15px;color:${isMissed?'var(--r)':'var(--t)'};margin-bottom:3px">${esc(u.name)}</div>
        <div style="font-size:13px;color:var(--t2);display:flex;align-items:center;gap:5px"><span style="color:${arrowColor}">${arrow}</span>${c.type==='video'?'üìπ Video':'üìû Voice'} ¬∑ ${fmtT(c.$createdAt)}</div></div>
        <div style="font-size:22px;cursor:pointer;color:var(--t2);padding:6px" onclick="makeCallTo('${oid}','${esc(u.name)}','${u.avatar||''}','${c.type}')">${c.type==='video'?'üìπ':'üìû'}</div>
      </div>`;
    }
  }catch(e){console.warn('Calls:',e.message);}
}

// ===== WebRTC CALLS =====
async function makeCall(type){if(!activeChat)return;makeCallTo(activeChat.id,activeChat.name,activeChat.avatar,type);}
async function makeCallTo(id,name,avatar,type){
  callInfo={to:id,type,out:true};showCallUI(name,avatar,'Calling‚Ä¶',type,false);
  try{
    localStream=await navigator.mediaDevices.getUserMedia(type==='video'?{video:true,audio:true}:{audio:true});
    if(type==='video'){const lv=document.getElementById('lvid');lv.srcObject=localStream;lv.style.display='block';}
    pc=mkPC();localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
    const offer=await pc.createOffer();await pc.setLocalDescription(offer);
    try{await adb.createDocument(DID,C.calls,ID.unique(),{caller_id:myId,receiver_id:id,type,status:'outgoing'}).catch(()=>{});}catch{}
  }catch{alert('Cannot access camera/microphone');endCall(true);}
}
function mkPC(){
  const p=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  p.ontrack=e=>{const rv=document.getElementById('rvid');rv.srcObject=e.streams[0];rv.style.display='block';document.getElementById('cal-av').style.display='none';};
  return p;
}
async function acceptCall(){document.getElementById('inc-row').classList.add('hidden');document.getElementById('cal-s').textContent='Connected';}
function rejectCall(){endCall(true);}
function endCall(silent=false){pc?.close();pc=null;localStream?.getTracks().forEach(t=>t.stop());localStream=null;document.getElementById('calo').classList.remove('on');document.getElementById('lvid').style.display='none';document.getElementById('rvid').style.display='none';document.getElementById('cal-av').style.display='flex';callInfo=null;}
function toggleMute(){if(localStream){const e=localStream.getAudioTracks()[0]?.enabled;localStream.getAudioTracks().forEach(t=>t.enabled=!e);document.getElementById('mute-b').textContent=e?'üîá':'üéôÔ∏è';}}
function toggleSpk(){document.getElementById('cab-sp').textContent='üîä';}
function showCallUI(name,avatar,status,type,incoming){
  const o=document.getElementById('calo');o.classList.add('on');
  document.getElementById('cal-n').textContent=name;document.getElementById('cal-s').textContent=status;
  document.getElementById('cal-av').innerHTML=avHTML(avatar,name,110);
  document.getElementById('inc-row').classList.toggle('hidden',!incoming);
}

// ===== TABS =====
function switchTab(tab){
  ['chats','updates','communities','calls'].forEach(t=>{document.getElementById('tab-'+t)?.classList.toggle('hidden',t!==tab);document.getElementById('bn-'+t)?.classList.toggle('on',t===tab);});
  document.getElementById('pills-bar').style.display=tab==='chats'?'flex':'none';
  document.getElementById('fab').style.display=tab==='chats'?'flex':'none';
  if(tab==='updates')loadStatus();
  if(tab==='calls')loadCalls();
  if(tab==='communities')loadCommunities();
}

// ===== NOTIFICATIONS =====
function showNotif(msg){
  const n=document.getElementById('notif');
  document.getElementById('notif-name').textContent=msg.sender_name||'New message';
  document.getElementById('notif-msg').textContent=msg.type==='text'?(msg.content||''):'üì∑ Media';
  document.getElementById('notif-av').innerHTML=avHTML(msg.sender_avatar,msg.sender_name,42);
  n.dataset.sid=msg.sender_id;n.dataset.sname=msg.sender_name||'';n.dataset.sav=msg.sender_avatar||'';
  n.classList.add('on');setTimeout(()=>n.classList.remove('on'),4000);
  if('Notification'in window&&Notification.permission==='granted')new Notification(msg.sender_name||'ChatApp',{body:msg.content||'Sent media',icon:'/icon.png'}).catch(()=>{});
}
function openNotif(){const n=document.getElementById('notif');n.classList.remove('on');const id=n.dataset.sid,name=n.dataset.sname,av=n.dataset.sav;if(id)openChat(id,name,av,'user');}

// ===== LIGHTBOX =====
function openLB(type,url){document.getElementById('lb').classList.add('on');document.getElementById('lbc').innerHTML=type==='image'?`<img src="${url}">`:`<video src="${url}" controls autoplay style="max-width:98vw;max-height:88vh">`;}
function closeLB(){document.getElementById('lb').classList.remove('on');document.getElementById('lbc').innerHTML='';}

// ===== MISC FEATURES =====
function showStarred(){alert('‚≠ê Starred messages\n\nStar a message by long-pressing it and selecting "Star".');}
function showBroadcast(){alert('üì¢ Broadcast lists\n\nSend a message to multiple contacts at once. Coming soon!');}
function showLinkedDevices(){alert('üîó Linked devices\n\nTo use ChatApp on Android:\n1. Open ChatApp in Chrome\n2. Tap ‚ãÆ menu ‚Üí "Add to Home Screen"\n3. It installs like an app!');}
function readAll(){document.querySelectorAll('.cbadge').forEach(b=>b.remove());}
function inviteLink(){navigator.clipboard.writeText(window.location.href).then(()=>alert('Link copied! Share it so others can join ChatApp.')).catch(()=>alert('Invite link: '+window.location.href));}

// ===== FAB =====
function toggleFAB(){fabOpen=!fabOpen;document.getElementById('fab-menu').className='fab-menu'+(fabOpen?' open':'');}
function closeFAB(){fabOpen=false;document.getElementById('fab-menu').className='fab-menu';}

// ===== BACK NAVIGATION =====
function goBackCP(){
  if(window.innerWidth<=768){document.getElementById('sidebar').classList.remove('hide');document.getElementById('chat-panel').classList.remove('show');}
  activeChat=null;renderChatList();
}

// ===== DROPDOWN MENUS =====
function openDDM(id,e){
  closeDDM();const m=document.getElementById(id);
  const rect=e?.target?.getBoundingClientRect?.();
  if(rect){m.style.top=(rect.bottom+4)+'px';m.style.right=(window.innerWidth-rect.right)+'px';m.style.left='auto';}
  else{m.style.top='58px';m.style.right='14px';m.style.left='auto';}
  m.classList.add('on');
}
function closeDDM(){document.querySelectorAll('.ddm').forEach(m=>m.classList.remove('on'));}

// ===== MODALS =====
function openModal(id){document.getElementById(id)?.classList.add('on');}
function closeModal(id){document.getElementById(id)?.classList.remove('on');}
document.addEventListener('click',e=>{
  if(!e.target.closest('.ctx'))document.getElementById('ctx')?.classList.remove('on');
  if(!e.target.closest('.ddm')&&!e.target.closest('[onclick*="openDDM"]'))closeDDM();
  if(!e.target.closest('.ep')&&!e.target.closest('.iico:first-child'))document.getElementById('ep')?.classList.remove('on');
  if(!e.target.closest('.am')&&!e.target.closest('.iico:nth-child(2)'))document.getElementById('am')?.classList.remove('on');
  if(!e.target.closest('.fab-menu')&&!e.target.closest('.fab'))closeFAB();
  if(e.target.classList.contains('mbg'))e.target.classList.remove('on');
});
function closeAll(){document.getElementById('ctx')?.classList.remove('on');closeDDM();document.getElementById('ep')?.classList.remove('on');document.getElementById('am')?.classList.remove('on');}

// ===== HELPERS =====
const COLORS=['#c0392b','#8e44ad','#2980b9','#16a085','#d35400','#27ae60','#2c3e50','#f39c12'];
function nColor(n){return COLORS[((n||'?').charCodeAt(0))%COLORS.length];}
function avHTML(url,name,size){
  const color=COLORS[((name||'?').charCodeAt(0))%COLORS.length],letter=(name||'?')[0].toUpperCase(),fs=Math.floor(size*0.4);
  if(url&&!url.startsWith('null'))return`<img src="${url}" style="width:${size}px;height:${size}px;border-radius:50%;object-fit:cover" onerror="this.outerHTML='<div class=\\'avph\\' style=\\'background:${color};width:${size}px;height:${size}px;border-radius:50%;font-size:${fs}px\\'>${letter}</div>'">`;
  return`<div class="avph" style="background:${color};width:${size}px;height:${size}px;border-radius:50%;font-size:${fs}px">${letter}</div>`;
}
function esc(t){if(!t)return'';return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function v(id){return document.getElementById(id)?.value?.trim()||'';}
function showErr(id,msg){const el=document.getElementById(id);if(el){el.textContent=msg;el.style.display='block';}}
function showMerr(id,msg){showErr(id,msg);}
function fmtT(ds){
  if(!ds)return'';const d=new Date(ds),now=new Date(),diff=now-d;
  if(diff<60000)return'just now';if(diff<3600000)return Math.floor(diff/60000)+'m ago';
  if(d.toDateString()===now.toDateString())return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  const y=new Date(now);y.setDate(y.getDate()-1);if(d.toDateString()===y.toDateString())return'Yesterday';
  return d.toLocaleDateString();
}
</script>
</body>
</html>
