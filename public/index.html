<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>WhatsApp</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#111b21;--sidebar:#111b21;--chat-bg:#0b141a;--panel:#202c33;--panel2:#2a3942;--panel3:#3b4a54;
  --green:#00a884;--green-dark:#025c4b;--teal:#128C7E;
  --text:#e9edef;--text2:#8696a0;--text3:#667781;--border:#2a3942;
  --bubble-out:#005c4b;--bubble-in:#202c33;--hover:#2a3942;
  --blue:#53bdeb;--red:#f15c6d;--font:'Roboto',sans-serif;
}
body{font-family:var(--font);background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column}

/* ===== AUTH ===== */
#auth-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:var(--bg);padding:20px;gap:0}
.auth-top{width:100%;max-width:400px;background:var(--green);padding:32px 24px 24px;border-radius:16px 16px 0 0;display:flex;flex-direction:column;align-items:center;gap:12px}
.auth-wa-logo{width:64px;height:64px}
.auth-top h1{font-size:22px;font-weight:500;color:#fff;letter-spacing:0.3px}
.auth-top p{font-size:13px;color:rgba(255,255,255,0.85);text-align:center}
.auth-body{width:100%;max-width:400px;background:var(--panel);padding:24px;border-radius:0 0 16px 16px;display:flex;flex-direction:column;gap:16px}
.inp{background:var(--panel2);border:none;border-bottom:2px solid var(--border);border-radius:0;padding:10px 0;color:var(--text);font-size:15px;font-family:var(--font);outline:none;width:100%;transition:border-color 0.2s}
.inp:focus{border-bottom-color:var(--green)}
.inp-wrap{position:relative;margin-bottom:4px}
.inp-label{font-size:11px;color:var(--green);font-weight:500;margin-bottom:4px;display:block}
.auth-btn{background:var(--green);color:#fff;border:none;border-radius:24px;padding:12px 40px;font-size:15px;font-weight:500;font-family:var(--font);cursor:pointer;align-self:center;margin-top:8px;transition:background 0.2s}
.auth-btn:hover{background:#00b894}
.auth-link{text-align:center;font-size:13px;color:var(--text2)}
.auth-link button{background:none;border:none;color:var(--green);cursor:pointer;font-size:13px;font-family:var(--font)}
.auth-err{color:var(--red);font-size:12px;text-align:center;display:none}

/* ===== MAIN APP ===== */
#app{display:none;height:100vh;flex-direction:column}
.app-container{display:flex;flex:1;overflow:hidden;height:100vh}

/* ===== SIDEBAR ===== */
.sidebar{width:100%;max-width:420px;display:flex;flex-direction:column;background:var(--sidebar);border-right:1px solid var(--border);position:relative;flex-shrink:0}
@media(max-width:768px){
  .sidebar{max-width:100%;position:absolute;inset:0;z-index:10;transition:transform 0.25s ease}
  .sidebar.slide-out{transform:translateX(-100%)}
  .chat-area{width:100%}
}

/* SIDEBAR HEADER */
.s-header{background:var(--panel);height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;flex-shrink:0}
.s-header-left{display:flex;align-items:center;gap:10px;cursor:pointer}
.s-title{font-size:20px;font-weight:600;color:var(--text)}
.s-icons{display:flex;gap:2px}
.ibt{width:40px;height:40px;border-radius:50%;background:none;border:none;color:var(--text2);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s}
.ibt:hover{background:var(--hover)}
.ibt svg{width:22px;height:22px;fill:currentColor}

/* FILTER TABS */
.filter-pills{padding:8px 12px;display:flex;gap:8px;overflow-x:auto;scrollbar-width:none;border-bottom:1px solid var(--border);flex-shrink:0}
.filter-pills::-webkit-scrollbar{display:none}
.pill{padding:6px 14px;border-radius:20px;background:var(--panel2);color:var(--text2);font-size:13px;font-weight:500;cursor:pointer;white-space:nowrap;border:none;font-family:var(--font);transition:all 0.2s;flex-shrink:0}
.pill.active{background:var(--green-dark);color:var(--green)}

/* SEARCH */
.s-search{padding:6px 12px;background:var(--sidebar);border-bottom:1px solid var(--border);flex-shrink:0}
.s-search-inner{background:var(--panel);border-radius:10px;display:flex;align-items:center;padding:8px 12px;gap:8px}
.s-search-inner svg{width:18px;height:18px;fill:var(--text3);flex-shrink:0}
.s-search-inner input{background:none;border:none;color:var(--text);font-size:14px;outline:none;width:100%;font-family:var(--font)}
.s-search-inner input::placeholder{color:var(--text3)}

/* CHAT LIST */
.chat-list{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--panel3) transparent}
.ci{display:flex;align-items:center;padding:10px 16px;gap:12px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.03);transition:background 0.1s;position:relative;min-height:72px}
.ci:hover,.ci.active{background:var(--hover)}
.ci-av{width:52px;height:52px;border-radius:50%;background:var(--panel2);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;overflow:hidden;position:relative}
.ci-av img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.ci-av .od{position:absolute;bottom:2px;right:2px;width:13px;height:13px;border-radius:50%;background:var(--green);border:2px solid var(--sidebar)}
.ci-body{flex:1;min-width:0}
.ci-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.ci-name{font-size:16px;font-weight:400;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
.ci-time{font-size:12px;color:var(--text3);white-space:nowrap;margin-left:8px}
.ci-bottom{display:flex;align-items:center;gap:4px}
.ci-last{font-size:14px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
.ci-badge{background:var(--green);color:#fff;border-radius:50%;width:20px;height:20px;font-size:11px;font-weight:600;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.ci-badge.muted{background:var(--panel3)}
.ci-lock{font-size:14px;color:var(--text3)}
.locked-chats-header{padding:12px 16px;background:var(--panel);display:flex;align-items:center;gap:10px;cursor:pointer;font-size:14px;color:var(--text2);border-bottom:1px solid var(--border)}

/* BOTTOM NAV */
.bottom-nav{display:flex;background:var(--panel);border-top:1px solid var(--border);flex-shrink:0}
.bn-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px 0 8px;cursor:pointer;gap:4px;transition:color 0.2s;color:var(--text2);position:relative}
.bn-item.active{color:var(--green)}
.bn-item svg{width:24px;height:24px;fill:currentColor}
.bn-label{font-size:11px;font-weight:500}
.bn-badge{position:absolute;top:6px;right:calc(50% - 18px);background:var(--green);color:#fff;border-radius:50%;width:18px;height:18px;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;display:none}
.bn-badge.show{display:flex}

/* ===== CHAT AREA ===== */
.chat-area{flex:1;display:flex;flex-direction:column;background:var(--chat-bg);overflow:hidden}
.chat-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:16px;padding:20px}
.chat-empty .wa-logo-big{font-size:80px;opacity:0.15}
.chat-empty h2{font-size:22px;font-weight:300;color:var(--text3)}
.chat-empty p{font-size:14px;color:var(--text3);text-align:center;max-width:300px;line-height:1.6}
.chat-empty .e2e{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--text3);margin-top:8px}

/* CHAT HEADER */
.ch{background:var(--panel);height:60px;display:flex;align-items:center;padding:0 8px 0 0;gap:8px;border-bottom:1px solid var(--border);flex-shrink:0}
.ch-back{width:40px;height:40px;display:none;align-items:center;justify-content:center;border:none;background:none;color:var(--text2);cursor:pointer;font-size:22px;flex-shrink:0}
@media(max-width:768px){.ch-back{display:flex}}
.ch-av{width:40px;height:40px;border-radius:50%;background:var(--panel2);overflow:hidden;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center}
.ch-av img{width:100%;height:100%;object-fit:cover}
.ch-info{flex:1;cursor:pointer;min-width:0}
.ch-name{font-size:16px;font-weight:500;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ch-status{font-size:13px;color:var(--text2)}
.ch-actions{display:flex;gap:2px}

/* MESSAGES */
.msgs-area{flex:1;overflow-y:auto;padding:8px 3%;scrollbar-width:thin;scrollbar-color:var(--panel3) transparent;background-color:var(--chat-bg);background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Crect width='400' height='400' fill='%230b141a'/%3E%3Cpath d='M50 100c-27.6 0-50 22.4-50 50s22.4 50 50 50 50-22.4 50-50-22.4-50-50-50zm0 88c-20.9 0-38-17.1-38-38s17.1-38 38-38 38 17.1 38 38-17.1 38-38 38z' fill='%23182028' fill-opacity='0.4'/%3E%3C/svg%3E")}
.date-sep{text-align:center;margin:10px 0}
.date-sep span{background:var(--panel);color:var(--text2);font-size:12px;padding:5px 12px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.3)}
.mw{display:flex;margin-bottom:2px;position:relative}
.mw.out{justify-content:flex-end}
.mw.in{justify-content:flex-start}
.mw.in .m-grav{width:28px;flex-shrink:0}
.mw.in .m-grav img,.mw.in .m-grav .av-ph{width:28px;height:28px;border-radius:50%;object-fit:cover}
.mw.out .m-grav{display:none}
.bubble{max-width:72%;position:relative}
.bi{padding:6px 10px 18px 10px;border-radius:8px;word-break:break-word;font-size:14.5px;line-height:1.5;position:relative;box-shadow:0 1px 2px rgba(0,0,0,0.2)}
.out .bi{background:var(--bubble-out);border-radius:8px 0 8px 8px}
.in .bi{background:var(--bubble-in);border-radius:0 8px 8px 8px}
.del-msg{font-style:italic;color:var(--text3);font-size:13px;display:flex;align-items:center;gap:6px}
.m-time{position:absolute;bottom:4px;right:8px;font-size:11px;color:rgba(255,255,255,0.5);display:flex;align-items:center;gap:3px;white-space:nowrap}
.ticks{font-size:13px}
.ticks.sent{color:rgba(255,255,255,0.4)}
.ticks.delivered{color:rgba(255,255,255,0.4)}
.ticks.read{color:var(--blue)}
.fwd-badge{font-size:11px;color:var(--text3);display:flex;align-items:center;gap:3px;margin-bottom:4px}
.reply-q{background:rgba(0,0,0,0.25);border-left:4px solid var(--green);padding:6px 8px;border-radius:3px;margin-bottom:6px;cursor:pointer}
.reply-q .rq-auth{color:var(--green);font-size:12px;font-weight:500;margin-bottom:2px}
.reply-q .rq-txt{color:var(--text2);font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:220px}
.m-img{max-width:260px;border-radius:6px;cursor:pointer;display:block;margin-bottom:2px}
.m-vid{max-width:260px;border-radius:6px;display:block;margin-bottom:2px}
.m-aud{width:230px;margin-bottom:2px}
.m-doc{display:flex;align-items:center;gap:10px;background:rgba(0,0,0,0.2);padding:10px 12px;border-radius:8px;cursor:pointer;margin-bottom:2px}
.m-doc-ico{font-size:30px}
.m-doc-info .dn{font-size:13px;font-weight:500}
.m-doc-info .ds{font-size:11px;color:var(--text2)}
.grp-sender{font-size:12px;color:var(--green);font-weight:500;margin-bottom:3px}
.reactions-row{display:flex;flex-wrap:wrap;gap:3px;margin-top:3px}
.react-chip{background:var(--panel2);border:1px solid var(--border);border-radius:20px;padding:2px 8px;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:3px}
.react-chip .rc{font-size:11px;color:var(--text2)}
.star-ico{font-size:11px;margin-left:2px}
.typing-ind{padding:4px 16px;min-height:28px}
.typing-bubble{display:flex;align-items:center;gap:4px;background:var(--bubble-in);padding:10px 14px;border-radius:0 8px 8px 8px;width:fit-content}
.td{width:8px;height:8px;border-radius:50%;background:var(--text2);animation:td 1.2s infinite}
.td:nth-child(2){animation-delay:0.15s}.td:nth-child(3){animation-delay:0.3s}
@keyframes td{0%,80%,100%{transform:scale(0.8);opacity:0.5}40%{transform:scale(1.2);opacity:1}}

/* INPUT AREA */
.reply-strip{background:var(--panel2);padding:10px 16px;display:flex;align-items:center;gap:10px;border-left:4px solid var(--green);display:none}
.reply-strip .rs-info{flex:1}
.reply-strip .rs-auth{color:var(--green);font-size:12px;font-weight:600;margin-bottom:2px}
.reply-strip .rs-txt{font-size:13px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:250px}
.reply-strip .rs-close{font-size:20px;color:var(--text2);cursor:pointer}
.inp-area{background:var(--panel);padding:8px 10px;display:flex;align-items:flex-end;gap:8px;border-top:1px solid var(--border);flex-shrink:0;position:relative}
.rec-strip{background:var(--panel2);border-radius:24px;padding:8px 16px;flex:1;display:none;align-items:center;gap:10px}
.rec-strip.show{display:flex}
.rec-dot{width:12px;height:12px;border-radius:50%;background:var(--red);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
.rec-t{color:var(--text);font-size:14px;font-weight:500}
.rec-x{color:var(--text2);font-size:20px;cursor:pointer}
.ia-ico{color:var(--text2);font-size:22px;cursor:pointer;padding:6px;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.ia-ico svg{width:24px;height:24px;fill:currentColor}
.msg-box{flex:1;background:var(--panel2);border-radius:24px;padding:9px 16px;display:flex;align-items:flex-end;gap:8px}
#minput{background:none;border:none;color:var(--text);font-size:15px;outline:none;resize:none;max-height:130px;font-family:var(--font);width:100%;line-height:1.4}
#minput::placeholder{color:var(--text3)}
.send-b{width:48px;height:48px;border-radius:50%;background:var(--green);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background 0.2s}
.send-b:hover{background:#00b894}
.send-b svg{width:22px;height:22px;fill:#fff}
.voice-b{width:48px;height:48px;border-radius:50%;background:var(--green);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background 0.2s}
.voice-b.rec{background:var(--red);animation:pulse 1s infinite}
.voice-b svg{width:22px;height:22px;fill:#fff}

/* EMOJI PICKER */
.emoji-picker{position:absolute;bottom:68px;left:0;background:var(--panel);border-radius:12px;padding:12px;width:min(340px,95vw);max-height:280px;overflow-y:auto;z-index:100;display:none;box-shadow:0 4px 24px rgba(0,0,0,0.5);scrollbar-width:thin}
.emoji-picker.open{display:block}
.eg{display:grid;grid-template-columns:repeat(8,1fr);gap:4px}
.ei{font-size:22px;cursor:pointer;text-align:center;padding:4px;border-radius:6px;transition:background 0.15s;line-height:1.3}
.ei:hover{background:var(--hover)}

/* ATTACH MENU */
.attach-menu{position:absolute;bottom:68px;left:0;background:var(--panel);border-radius:16px;padding:16px;display:none;z-index:100;box-shadow:0 4px 24px rgba(0,0,0,0.5);gap:0;flex-wrap:wrap;width:220px}
.attach-menu.open{display:flex;gap:4px}
.ao{display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;padding:10px;border-radius:10px;width:80px;transition:background 0.15s}
.ao:hover{background:var(--hover)}
.ao-ico{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px}
.ao-lbl{font-size:12px;color:var(--text2);text-align:center}

/* CONTEXT MENU */
.ctx{position:fixed;background:var(--panel);border-radius:10px;padding:6px 0;min-width:180px;z-index:1000;display:none;box-shadow:0 4px 24px rgba(0,0,0,0.6)}
.ctx.open{display:block}
.ctx-item{padding:13px 18px;font-size:14px;cursor:pointer;display:flex;align-items:center;gap:10px;transition:background 0.1s;color:var(--text)}
.ctx-item:hover{background:var(--hover)}
.ctx-item.danger{color:var(--red)}
.react-row{display:flex;padding:10px 12px;gap:6px;font-size:26px}
.react-row span{cursor:pointer;padding:2px;border-radius:6px;transition:transform 0.15s}
.react-row span:hover{transform:scale(1.3)}

/* ===== STATUS (UPDATES) ===== */
.updates-screen{flex:1;overflow-y:auto;scrollbar-width:thin}
.status-my-card{display:flex;align-items:center;gap:14px;padding:14px 16px;cursor:pointer;border-bottom:1px solid var(--border);transition:background 0.1s}
.status-my-card:hover{background:var(--hover)}
.status-av-wrap{position:relative;flex-shrink:0}
.status-av{width:52px;height:52px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;background:var(--panel2)}
.status-av img{width:100%;height:100%;object-fit:cover}
.status-add-badge{position:absolute;bottom:0;right:0;width:20px;height:20px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff;border:2px solid var(--sidebar);font-weight:700;line-height:1}
.status-ring{border-radius:50%;padding:2px;background:linear-gradient(45deg,var(--green),#00e5b0);display:inline-block}
.status-ring.viewed{background:var(--panel3)}
.status-card{display:flex;align-items:center;gap:14px;padding:12px 16px;cursor:pointer;transition:background 0.1s;border-bottom:1px solid rgba(255,255,255,0.03)}
.status-card:hover{background:var(--hover)}
.status-info{flex:1;min-width:0}
.status-info .sn{font-size:15px;color:var(--text);font-weight:400}
.status-info .st{font-size:13px;color:var(--text2)}
.updates-section-title{padding:12px 16px 6px;font-size:13px;color:var(--text2);font-weight:500}
.channels-section{padding:0}
.channel-card{display:flex;align-items:center;gap:14px;padding:12px 16px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.03);transition:background 0.1s}
.channel-card:hover{background:var(--hover)}
.channel-av{width:48px;height:48px;border-radius:50%;background:var(--panel2);display:flex;align-items:center;justify-content:center;font-size:20px;overflow:hidden;flex-shrink:0}
.channel-av img{width:100%;height:100%;object-fit:cover}
.channel-info{flex:1;min-width:0}
.channel-info .cn{display:flex;align-items:center;gap:5px;font-size:15px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.verified-badge{color:var(--blue);font-size:16px}
.channel-info .cf{font-size:13px;color:var(--text2)}
.follow-btn{background:none;border:1px solid var(--green);color:var(--green);border-radius:20px;padding:6px 16px;font-size:13px;cursor:pointer;font-family:var(--font);white-space:nowrap;transition:all 0.2s}
.follow-btn:hover,.follow-btn.following{background:var(--green);color:#fff}
.explore-btn{background:var(--panel2);border:none;color:var(--green);border-radius:20px;padding:8px 20px;font-size:14px;cursor:pointer;font-family:var(--font)}

/* STATUS VIEWER */
.sv-overlay{position:fixed;inset:0;background:#000;z-index:800;display:none;flex-direction:column}
.sv-overlay.open{display:flex}
.sv-progress{display:flex;gap:3px;padding:12px 10px 0}
.sv-seg{flex:1;height:3px;background:rgba(255,255,255,0.3);border-radius:2px;overflow:hidden}
.sv-seg .sf{height:100%;background:#fff;width:0;transition:width linear}
.sv-header{display:flex;align-items:center;gap:10px;padding:10px 12px;position:absolute;top:30px;left:0;right:0;z-index:2}
.sv-av{width:38px;height:38px;border-radius:50%;overflow:hidden;background:var(--panel2);flex-shrink:0;display:flex;align-items:center;justify-content:center}
.sv-av img{width:100%;height:100%;object-fit:cover}
.sv-info .sv-name{font-size:14px;font-weight:500;color:#fff}
.sv-info .sv-time{font-size:12px;color:rgba(255,255,255,0.7)}
.sv-close{margin-left:auto;background:none;border:none;color:#fff;font-size:26px;cursor:pointer}
.sv-content{flex:1;display:flex;align-items:center;justify-content:center;padding:20px;text-align:center;position:relative}
.sv-content img,.sv-content video{max-width:100%;max-height:80vh;object-fit:contain;border-radius:4px}
.sv-text-content{font-size:26px;font-weight:500;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,0.4);padding:20px;white-space:pre-wrap;word-break:break-word}
.sv-caption{position:absolute;bottom:16px;left:16px;right:16px;background:rgba(0,0,0,0.5);padding:8px 12px;border-radius:8px;font-size:14px;color:#fff;text-align:center}
.sv-nav-left{position:absolute;left:0;top:0;width:40%;height:100%;cursor:pointer;z-index:3}
.sv-nav-right{position:absolute;right:0;top:0;width:40%;height:100%;cursor:pointer;z-index:3}
.sv-reply{padding:12px 16px;display:flex;gap:10px}
.sv-reply-input{flex:1;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);border-radius:24px;padding:10px 16px;color:#fff;font-size:14px;outline:none;font-family:var(--font)}
.sv-reply-input::placeholder{color:rgba(255,255,255,0.6)}
.sv-views{font-size:14px;color:#fff;padding:8px 16px;display:flex;align-items:center;gap:6px;cursor:pointer}

/* STATUS CREATE */
.sc-overlay{position:fixed;inset:0;background:var(--bg);z-index:900;display:none;flex-direction:column}
.sc-overlay.open{display:flex}
.sc-header{background:var(--panel);height:60px;display:flex;align-items:center;padding:0 16px;gap:14px;border-bottom:1px solid var(--border)}
.sc-header button{background:none;border:none;color:var(--text2);font-size:24px;cursor:pointer}
.sc-header h2{font-size:18px;font-weight:500;color:var(--text);flex:1}
.sc-header .post-btn{background:var(--green);border:none;color:#fff;border-radius:20px;padding:8px 20px;font-size:14px;cursor:pointer;font-family:var(--font)}
.sc-body{flex:1;display:flex;flex-direction:column}
.sc-preview{flex:1;display:flex;align-items:center;justify-content:center;padding:20px;position:relative}
.sc-preview img,.sc-preview video{max-width:100%;max-height:60vh;border-radius:8px;object-fit:contain}
.sc-text-prev{font-size:24px;font-weight:500;padding:40px;text-align:center;word-break:break-word;width:100%;min-height:200px;display:flex;align-items:center;justify-content:center;border-radius:12px}
.sc-tools{background:var(--panel);padding:12px 16px;display:flex;gap:12px;border-top:1px solid var(--border)}
.sc-tool-btn{width:44px;height:44px;border-radius:50%;background:var(--panel2);border:none;color:var(--text2);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s}
.sc-tool-btn:hover{background:var(--panel3)}
.sc-input-area{padding:10px 16px;display:flex;align-items:center;gap:12px;background:var(--panel);border-top:1px solid var(--border)}
.sc-input{flex:1;background:var(--panel2);border:none;border-radius:24px;padding:10px 16px;color:var(--text);font-size:15px;outline:none;font-family:var(--font)}
.sc-input::placeholder{color:var(--text3)}
.color-bar{display:flex;gap:8px;padding:12px 16px;overflow-x:auto;scrollbar-width:none}
.color-bar::-webkit-scrollbar{display:none}
.cb{width:32px;height:32px;border-radius:50%;cursor:pointer;border:3px solid transparent;flex-shrink:0;transition:border-color 0.2s}
.cb.sel{border-color:#fff}

/* CALLS SCREEN */
.calls-screen{flex:1;overflow-y:auto;scrollbar-width:thin}
.calls-fav{padding:16px;border-bottom:1px solid var(--border)}
.calls-fav-title{font-size:13px;color:var(--text2);font-weight:500;margin-bottom:12px}
.calls-fav-row{display:flex;gap:16px;overflow-x:auto;scrollbar-width:none}
.calls-fav-row::-webkit-scrollbar{display:none}
.fav-item{display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;min-width:60px}
.fav-item .fav-av{width:52px;height:52px;border-radius:50%;background:var(--panel2);overflow:hidden;display:flex;align-items:center;justify-content:center}
.fav-item .fav-av img{width:100%;height:100%;object-fit:cover}
.fav-item .fav-name{font-size:12px;color:var(--text2);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60px}
.calls-list-title{padding:12px 16px 6px;font-size:13px;color:var(--text2);font-weight:500}
.call-item{display:flex;align-items:center;padding:12px 16px;gap:12px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.03);transition:background 0.1s}
.call-item:hover{background:var(--hover)}
.call-item .call-av{width:48px;height:48px;border-radius:50%;background:var(--panel2);overflow:hidden;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.call-item .call-av img{width:100%;height:100%;object-fit:cover}
.call-info{flex:1;min-width:0}
.call-name{font-size:15px;color:var(--text);margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.call-detail{font-size:13px;display:flex;align-items:center;gap:5px}
.call-detail .in-call{color:var(--green)}
.call-detail .out-call{color:var(--green)}
.call-detail .miss-call{color:var(--red)}
.call-time{font-size:12px;color:var(--text3)}
.call-type-btn{font-size:22px;color:var(--text2);cursor:pointer;padding:6px}

/* COMMUNITIES SCREEN */
.communities-screen{flex:1;overflow-y:auto;scrollbar-width:thin}
.new-comm{display:flex;align-items:center;gap:14px;padding:16px;cursor:pointer;border-bottom:1px solid var(--border);transition:background 0.1s}
.new-comm:hover{background:var(--hover)}
.new-comm-ico{width:52px;height:52px;border-radius:50%;background:var(--panel2);display:flex;align-items:center;justify-content:center;font-size:26px;position:relative}
.new-comm-plus{position:absolute;bottom:0;right:0;width:18px;height:18px;border-radius:50%;background:var(--green);color:#fff;font-size:12px;display:flex;align-items:center;justify-content:center;border:2px solid var(--sidebar)}
.comm-item{display:flex;align-items:flex-start;gap:14px;padding:14px 16px;cursor:pointer;border-bottom:1px solid var(--border);transition:background 0.1s}
.comm-item:hover{background:var(--hover)}
.comm-av{width:52px;height:52px;border-radius:12px;background:var(--panel2);overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.comm-av img{width:100%;height:100%;object-fit:cover}
.comm-info{flex:1}
.comm-name{font-size:15px;font-weight:500;color:var(--text);margin-bottom:4px}
.comm-desc{font-size:13px;color:var(--text2);margin-bottom:8px}
.comm-groups{display:flex;gap:6px;flex-wrap:wrap}
.cg-chip{background:var(--panel2);border-radius:16px;padding:3px 10px;font-size:12px;color:var(--text2);display:flex;align-items:center;gap:4px}

/* MODALS */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:500;display:none;align-items:flex-end;justify-content:center}
.modal-bg.open{display:flex}
@media(min-width:481px){.modal-bg{align-items:center}}
.modal{background:var(--panel);border-radius:16px 16px 0 0;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;padding:20px;position:relative}
@media(min-width:481px){.modal{border-radius:16px}}
.modal-handle{width:40px;height:4px;background:var(--panel3);border-radius:2px;margin:0 auto 16px;display:block}
.modal h2{font-size:18px;font-weight:500;margin-bottom:18px;color:var(--text)}
.m-close{position:absolute;top:16px;right:16px;background:none;border:none;color:var(--text2);font-size:24px;cursor:pointer}
.mf-group{margin-bottom:14px}
.mf-label{font-size:12px;color:var(--green);font-weight:500;margin-bottom:6px;display:block}
.mf-inp{width:100%;background:transparent;border:none;border-bottom:2px solid var(--border);padding:8px 0;color:var(--text);font-size:15px;outline:none;font-family:var(--font);transition:border-color 0.2s}
.mf-inp:focus{border-bottom-color:var(--green)}
.m-btn{width:100%;background:var(--green);color:#fff;border:none;border-radius:10px;padding:13px;font-size:15px;font-weight:500;cursor:pointer;font-family:var(--font);margin-top:8px;transition:background 0.2s}
.m-btn:hover{background:#00b894}
.m-err{color:var(--red);font-size:12px;text-align:center;margin:4px 0;display:none}
.profile-av-lg{width:96px;height:96px;border-radius:50%;background:var(--panel2);overflow:hidden;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;cursor:pointer;position:relative}
.profile-av-lg img{width:100%;height:100%;object-fit:cover}
.profile-av-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;font-size:22px;color:#fff}
.profile-av-lg:hover .profile-av-overlay{display:flex}
.info-sec{border-bottom:1px solid var(--border);padding:10px 0}
.info-lbl{font-size:12px;color:var(--green);font-weight:500;margin-bottom:4px}
.info-val{font-size:15px;color:var(--text);display:flex;align-items:center;justify-content:space-between}
.info-edit{font-size:17px;color:var(--text2);cursor:pointer;background:none;border:none;color:var(--green)}
.search-res{max-height:280px;overflow-y:auto}
.sr-item{display:flex;align-items:center;gap:12px;padding:10px 12px;cursor:pointer;border-radius:10px;transition:background 0.1s}
.sr-item:hover{background:var(--hover)}
.member-chips{display:flex;flex-wrap:wrap;gap:6px;padding:8px;background:var(--panel2);border-radius:10px;min-height:38px;margin-bottom:8px}
.mchip{display:flex;align-items:center;gap:5px;background:var(--panel3);border-radius:20px;padding:4px 10px;font-size:13px}
.mchip .mcx{cursor:pointer;color:var(--text2);font-size:16px}
.locked-pin-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:32px}
.pin-dots{display:flex;gap:14px;margin:16px 0}
.pin-dot{width:14px;height:14px;border-radius:50%;background:var(--panel3);transition:background 0.2s}
.pin-dot.filled{background:var(--green)}
.pin-pad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;width:260px}
.pin-key{background:var(--panel2);border:none;border-radius:50%;width:72px;height:72px;font-size:22px;color:var(--text);cursor:pointer;font-family:var(--font);transition:background 0.2s;display:flex;align-items:center;justify-content:center;flex-direction:column}
.pin-key:hover{background:var(--panel3)}
.pin-key .pk-sub{font-size:9px;color:var(--text2);letter-spacing:1px}

/* CALL OVERLAY */
.call-overlay{position:fixed;inset:0;background:var(--bg);z-index:900;display:none;flex-direction:column;align-items:center;justify-content:center;gap:12px}
.call-overlay.open{display:flex}
.call-bg-av{width:110px;height:110px;border-radius:50%;background:var(--panel2);overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:48px}
.call-bg-av img{width:100%;height:100%;object-fit:cover}
.call-name-big{font-size:26px;font-weight:400;color:var(--text)}
.call-status-txt{color:var(--text2);font-size:15px}
.call-actions-row{display:flex;gap:24px;margin-top:24px}
.ca-btn{display:flex;flex-direction:column;align-items:center;gap:8px}
.ca-btn button{width:64px;height:64px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:26px;transition:transform 0.15s}
.ca-btn button:active{transform:scale(0.9)}
.ca-btn .ca-lbl{font-size:12px;color:var(--text2)}
.cab-end{background:var(--red)}
.cab-accept{background:#00b894}
.cab-mute,.cab-speaker,.cab-vid{background:var(--panel2)}
.incoming-row{display:flex;gap:48px;margin-top:12px}
#remote-video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none}
#local-video{position:absolute;bottom:100px;right:16px;width:100px;height:140px;border-radius:12px;object-fit:cover;display:none;z-index:10}

/* NOTIFICATION */
.notif{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:var(--panel);border-radius:12px;padding:10px 14px;z-index:9999;display:none;align-items:center;gap:10px;min-width:280px;max-width:340px;box-shadow:0 4px 24px rgba(0,0,0,0.5);cursor:pointer;animation:slideIn 0.3s ease}
@keyframes slideIn{from{transform:translateX(-50%) translateY(-60px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
.notif.show{display:flex}
.notif-av{width:40px;height:40px;border-radius:50%;background:var(--panel2);overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.notif-av img{width:100%;height:100%;object-fit:cover}
.notif-body .nb-name{font-weight:600;font-size:14px;margin-bottom:2px}
.notif-body .nb-msg{font-size:13px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:220px}

/* LIGHTBOX */
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,0.97);z-index:1000;display:none;align-items:center;justify-content:center;flex-direction:column}
.lightbox.open{display:flex}
.lb-close{position:absolute;top:14px;right:14px;background:none;border:none;color:#fff;font-size:30px;cursor:pointer}
.lb-content img,.lb-content video{max-width:98vw;max-height:88vh;object-fit:contain;border-radius:6px}

/* LOCK PIN SETUP */
.pin-setup-info{text-align:center;color:var(--text2);font-size:14px;max-width:280px;line-height:1.6}

/* UTIL */
.hidden{display:none!important}
.avph{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:500;color:#fff;font-size:inherit}
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth-screen">
  <div class="auth-top">
    <svg class="auth-wa-logo" viewBox="0 0 55 55" fill="none"><circle cx="27.5" cy="27.5" r="27.5" fill="white"/><path d="M27.5 8C16.73 8 8 16.73 8 27.5c0 3.56.97 6.9 2.65 9.76L8.13 47l9.93-2.5A19.38 19.38 0 0027.5 47c10.77 0 19.5-8.73 19.5-19.5S38.27 8 27.5 8zm0 35.62a16.03 16.03 0 01-8.19-2.26l-.58-.35-6.07 1.53 1.56-5.87-.38-.6A16.12 16.12 0 0111.38 27.5c0-8.89 7.23-16.12 16.12-16.12 8.89 0 16.12 7.23 16.12 16.12S36.39 43.62 27.5 43.62z" fill="#00a884"/><path d="M22.04 18.62c-.43-1.07-.88-1.1-1.3-1.12-.34-.02-.72-.02-1.1-.02-.38 0-1 .14-1.53.7-.52.56-2 1.96-2 4.77s2.04 5.54 2.32 5.92c.29.38 3.93 6.3 9.7 8.58 4.8 1.89 5.77 1.52 6.82 1.42 1.04-.1 3.36-1.37 3.84-2.7.48-1.32.48-2.45.33-2.68-.14-.24-.52-.38-1.1-.67-.58-.29-3.42-1.69-3.95-1.88-.52-.19-.9-.29-1.28.29-.38.57-1.47 1.88-1.8 2.27-.33.38-.67.43-1.24.14-.58-.29-2.43-.9-4.63-2.86-1.72-1.52-2.87-3.4-3.2-3.98-.34-.57-.04-.88.25-1.17.26-.26.58-.67.86-1.01.29-.33.38-.57.57-.95.19-.38.1-.72-.05-1.01-.14-.29-1.25-3.15-1.75-4.32z" fill="#00a884"/></svg>
    <h1>WhatsApp</h1>
    <p>Fast, simple, secure messaging</p>
  </div>
  <div class="auth-body" id="login-form">
    <div class="inp-wrap"><span class="inp-label">Phone Number</span><input class="inp" id="lp" type="tel" placeholder="+91 9876543210"></div>
    <div class="inp-wrap"><span class="inp-label">Password</span><input class="inp" id="lpw" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
    <div class="auth-err" id="lerr"></div>
    <button class="auth-btn" onclick="login()">NEXT</button>
    <div class="auth-link">New to WhatsApp? <button onclick="showReg()">Register</button></div>
  </div>
  <div class="auth-body hidden" id="reg-form">
    <div class="inp-wrap"><span class="inp-label">Your Name</span><input class="inp" id="rn" placeholder="Enter your name"></div>
    <div class="inp-wrap"><span class="inp-label">Phone Number</span><input class="inp" id="rp" type="tel" placeholder="+91 9876543210"></div>
    <div class="inp-wrap"><span class="inp-label">Password</span><input class="inp" id="rpw" type="password" placeholder="Min 6 characters"></div>
    <div class="auth-err" id="rerr"></div>
    <button class="auth-btn" onclick="register()">REGISTER</button>
    <div class="auth-link">Already have an account? <button onclick="showLogin()">Login</button></div>
  </div>
</div>

<!-- APP -->
<div id="app">
<div class="app-container">
  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="s-header">
      <div class="s-header-left" onclick="openProfile()">
        <div class="ci-av" id="my-av" style="width:38px;height:38px;flex-shrink:0"></div>
        <span class="s-title">WhatsApp</span>
      </div>
      <div class="s-icons">
        <button class="ibt" onclick="openStatusCreate()" title="Status">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 8v4l3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
        <button class="ibt" onclick="openNewChat()" title="New Chat">
          <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12zM7 9h10M7 12h7" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
        </button>
        <button class="ibt" id="main-menu-btn" onclick="toggleMainMenu()" title="Menu">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="5" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="19" r="1.5"/></svg>
        </button>
      </div>
    </div>

    <!-- Search -->
    <div class="s-search">
      <div class="s-search-inner">
        <svg viewBox="0 0 24 24"><path d="M21 21l-4.35-4.35M17 11A6 6 0 115 11a6 6 0 0112 0z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="search-inp" placeholder="Search or start new chat" oninput="onSearchInput(this.value)">
      </div>
    </div>

    <!-- Filter Pills (Chats tab only) -->
    <div class="filter-pills" id="filter-pills">
      <button class="pill active" onclick="setFilter('all',this)">All</button>
      <button class="pill" onclick="setFilter('unread',this)">Unread</button>
      <button class="pill" onclick="setFilter('favorites',this)">Favorites</button>
      <button class="pill" onclick="setFilter('groups',this)">Groups</button>
    </div>

    <!-- TAB CONTENT -->
    <div id="tab-chats" class="chat-list"></div>
    <div id="tab-updates" class="updates-screen hidden"></div>
    <div id="tab-communities" class="communities-screen hidden"></div>
    <div id="tab-calls" class="calls-screen hidden"></div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav">
      <div class="bn-item active" id="bn-chats" onclick="switchTab('chats')">
        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
        <span class="bn-label">Chats</span>
      </div>
      <div class="bn-item" id="bn-updates" onclick="switchTab('updates')">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="4"/></svg>
        <span class="bn-label">Updates</span>
      </div>
      <div class="bn-item" id="bn-communities" onclick="switchTab('communities')">
        <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
        <span class="bn-label">Communities</span>
      </div>
      <div class="bn-item" id="bn-calls" onclick="switchTab('calls')">
        <svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 11.5 19.79 19.79 0 01.01 2.88 2 2 0 012 .71h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L6.09 8.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
        <span class="bn-label">Calls</span>
      </div>
    </div>
  </div>

  <!-- CHAT AREA -->
  <div class="chat-area" id="chat-area">
    <div style="display:flex;flex-direction:column;flex:1;align-items:center;justify-content:center" id="chat-empty">
      <div class="chat-empty">
        <svg width="80" height="80" viewBox="0 0 55 55" style="opacity:0.12"><circle cx="27.5" cy="27.5" r="27.5" fill="#00a884"/><path d="M27.5 8C16.73 8 8 16.73 8 27.5c0 3.56.97 6.9 2.65 9.76L8.13 47l9.93-2.5A19.38 19.38 0 0027.5 47c10.77 0 19.5-8.73 19.5-19.5S38.27 8 27.5 8z" fill="#00a884"/></svg>
        <h2>WhatsApp for Web</h2>
        <p>Send and receive messages without keeping your phone online. Use WhatsApp on up to 4 linked devices and 1 phone at the same time.</p>
        <div class="e2e">üîí Your personal messages are end-to-end encrypted</div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- CONTEXT MENU -->
<div class="ctx" id="ctx-menu">
  <div class="react-row"><span onclick="sendReact('‚ù§Ô∏è')">‚ù§Ô∏è</span><span onclick="sendReact('üëç')">üëç</span><span onclick="sendReact('üòÇ')">üòÇ</span><span onclick="sendReact('üòÆ')">üòÆ</span><span onclick="sendReact('üò¢')">üò¢</span><span onclick="sendReact('üôè')">üôè</span></div>
  <div class="ctx-item" onclick="ctxReply()">‚Ü©Ô∏è Reply</div>
  <div class="ctx-item" onclick="ctxCopy()">üìã Copy</div>
  <div class="ctx-item" onclick="ctxForward()">‚û°Ô∏è Forward</div>
  <div class="ctx-item" onclick="ctxStar()">‚≠ê Star message</div>
  <div class="ctx-item" onclick="ctxInfo()">‚ÑπÔ∏è Message info</div>
  <div class="ctx-item danger" onclick="ctxDelete()">üóëÔ∏è Delete message</div>
</div>

<!-- MAIN MENU -->
<div class="ctx" id="main-menu" style="top:60px;right:12px;left:auto">
  <div class="ctx-item" onclick="closeMenus();openNewGroupModal()">üë• New group</div>
  <div class="ctx-item" onclick="closeMenus();openNewCommModal()">üèòÔ∏è New community</div>
  <div class="ctx-item" onclick="closeMenus();openPinSetup()">üîí Locked chats</div>
  <div class="ctx-item" onclick="closeMenus();showStarred()">‚≠ê Starred messages</div>
  <div class="ctx-item" onclick="closeMenus();openProfile()">üë§ Settings</div>
  <div class="ctx-item danger" onclick="logout()">üö™ Logout</div>
</div>

<!-- CHAT MENU -->
<div class="ctx" id="chat-menu" style="top:60px;right:12px;left:auto">
  <div class="ctx-item" onclick="closeMenus();openContactInfo()">üë§ View contact</div>
  <div class="ctx-item" onclick="closeMenus();lockChat()">üîí Lock chat</div>
  <div class="ctx-item" onclick="closeMenus();clearChatMsgs()">üóëÔ∏è Clear chat</div>
</div>

<!-- PROFILE MODAL -->
<div class="modal-bg" id="profile-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <button class="m-close" onclick="closeModal('profile-modal')">‚úï</button>
    <h2>Profile</h2>
    <div class="profile-av-lg" id="pal" onclick="document.getElementById('av-up').click()">
      <div class="profile-av-overlay">üì∑</div>
    </div>
    <input type="file" id="av-up" accept="image/*" style="display:none" onchange="uploadAvatar(event)">
    <div class="info-sec"><div class="info-lbl">Your name</div><div class="info-val"><span id="p-name"></span><button class="info-edit" onclick="editField('name')">‚úèÔ∏è</button></div></div>
    <div class="info-sec"><div class="info-lbl">Phone</div><div class="info-val"><span id="p-phone"></span></div></div>
    <div class="info-sec" style="border:none"><div class="info-lbl">About</div><div class="info-val"><span id="p-about"></span><button class="info-edit" onclick="editField('about')">‚úèÔ∏è</button></div></div>
    <button class="m-btn" style="background:var(--panel2);color:var(--red);margin-top:16px" onclick="logout()">Log out</button>
  </div>
</div>

<!-- CONTACT INFO MODAL -->
<div class="modal-bg" id="contact-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <button class="m-close" onclick="closeModal('contact-modal')">‚úï</button>
    <div class="profile-av-lg" id="cpal" style="pointer-events:none"></div>
    <div style="text-align:center;margin-bottom:16px">
      <div style="font-size:20px;font-weight:500" id="c-name"></div>
      <div style="color:var(--text2);font-size:14px" id="c-phone"></div>
    </div>
    <div class="info-sec"><div class="info-lbl">About</div><div class="info-val" id="c-about"></div></div>
    <div class="info-sec" style="border:none"><div class="info-lbl">Last seen</div><div class="info-val" id="c-lastseen"></div></div>
    <div style="display:flex;gap:10px;margin-top:16px">
      <button class="m-btn" style="flex:1" onclick="closeModal('contact-modal');makeCall('voice')">üìû Voice call</button>
      <button class="m-btn" style="flex:1" onclick="closeModal('contact-modal');makeCall('video')">üìπ Video call</button>
    </div>
  </div>
</div>

<!-- NEW CHAT MODAL -->
<div class="modal-bg" id="new-chat-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <button class="m-close" onclick="closeModal('new-chat-modal')">‚úï</button>
    <h2>New chat</h2>
    <div class="mf-group"><input class="mf-inp" id="nc-search" placeholder="Search by name or number" oninput="searchPeople(this.value)"></div>
    <div class="search-res" id="nc-results"></div>
  </div>
</div>

<!-- NEW GROUP MODAL -->
<div class="modal-bg" id="new-group-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <button class="m-close" onclick="closeModal('new-group-modal')">‚úï</button>
    <h2>New group</h2>
    <div class="mf-group"><span class="mf-label">Group name</span><input class="mf-inp" id="gname" placeholder="Enter group name"></div>
    <div class="mf-group"><span class="mf-label">Add participants</span><input class="mf-inp" id="gmem-search" placeholder="Search contacts" oninput="searchGrpMembers(this.value)"></div>
    <div class="member-chips" id="sel-members"></div>
    <div class="search-res" id="gmem-results"></div>
    <button class="m-btn" onclick="createGroup()">Create group</button>
  </div>
</div>

<!-- NEW COMMUNITY MODAL -->
<div class="modal-bg" id="new-comm-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <button class="m-close" onclick="closeModal('new-comm-modal')">‚úï</button>
    <h2>New community</h2>
    <div class="mf-group"><span class="mf-label">Community name</span><input class="mf-inp" id="cname" placeholder="Enter community name"></div>
    <div class="mf-group"><span class="mf-label">Description</span><input class="mf-inp" id="cdesc" placeholder="Optional description"></div>
    <button class="m-btn" onclick="createCommunity()">Create community</button>
  </div>
</div>

<!-- PIN SETUP MODAL -->
<div class="modal-bg" id="pin-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <button class="m-close" onclick="closeModal('pin-modal')">‚úï</button>
    <h2>Locked Chats</h2>
    <div id="pin-setup-view">
      <p class="pin-setup-info">Set a secret code to lock your private chats. Type this code in the search bar to reveal them.</p>
      <div class="mf-group" style="margin-top:16px"><span class="mf-label">Set PIN code (4-6 digits)</span><input class="mf-inp" id="pin-inp" type="password" inputmode="numeric" placeholder="e.g. 1234" maxlength="6"></div>
      <button class="m-btn" onclick="savePin()">Set PIN</button>
      <button class="m-btn" style="background:var(--panel2);color:var(--red);margin-top:8px" onclick="removePin()">Remove PIN</button>
    </div>
  </div>
</div>

<!-- STATUS VIEWER -->
<div class="sv-overlay" id="sv-overlay">
  <div class="sv-progress" id="sv-prog"></div>
  <div class="sv-header">
    <div class="sv-av" id="sv-av"></div>
    <div class="sv-info"><div class="sv-name" id="sv-name"></div><div class="sv-time" id="sv-time"></div></div>
    <button class="sv-close" onclick="closeSV()">‚úï</button>
  </div>
  <div class="sv-nav-left" onclick="svPrev()"></div>
  <div class="sv-nav-right" onclick="svNext()"></div>
  <div class="sv-content" id="sv-content"></div>
  <div class="sv-reply">
    <input class="sv-reply-input" placeholder="Reply to status‚Ä¶" id="sv-reply-inp">
    <button class="send-b" style="width:40px;height:40px" onclick="sendSVReply()">
      <svg viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
  </div>
</div>

<!-- STATUS CREATE -->
<div class="sc-overlay" id="sc-overlay">
  <div class="sc-header">
    <button onclick="closeSC()">‚úï</button>
    <h2>Add status</h2>
    <button class="post-btn" onclick="postStatus()">Post</button>
  </div>
  <div class="sc-body">
    <div id="sc-type-tabs" style="display:flex;border-bottom:1px solid var(--border)">
      <div class="tab" id="sct-text" style="flex:1;padding:12px;text-align:center;font-size:14px;font-weight:500;cursor:pointer;border-bottom:2px solid var(--green);color:var(--green)" onclick="setSCType('text')">Text</div>
      <div class="tab" id="sct-photo" style="flex:1;padding:12px;text-align:center;font-size:14px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;color:var(--text2)" onclick="setSCType('photo')">Photo/Video</div>
    </div>
    <div id="sc-text-view" style="flex:1;display:flex;flex-direction:column">
      <div class="sc-preview" id="sc-text-preview-area" style="flex:1">
        <div class="sc-text-prev" id="sc-text-prev" style="background:#00a884;color:#fff;min-width:280px">Your text here‚Ä¶</div>
      </div>
      <div class="color-bar">
        <div class="cb sel" style="background:#00a884" data-c="#00a884" onclick="pickSCColor(this)"></div>
        <div class="cb" style="background:#7c3aed" data-c="#7c3aed" onclick="pickSCColor(this)"></div>
        <div class="cb" style="background:#dc2626" data-c="#dc2626" onclick="pickSCColor(this)"></div>
        <div class="cb" style="background:#0891b2" data-c="#0891b2" onclick="pickSCColor(this)"></div>
        <div class="cb" style="background:#d97706" data-c="#d97706" onclick="pickSCColor(this)"></div>
        <div class="cb" style="background:#1d4ed8" data-c="#1d4ed8" onclick="pickSCColor(this)"></div>
        <div class="cb" style="background:#059669" data-c="#059669" onclick="pickSCColor(this)"></div>
        <div class="cb" style="background:#c026d3" data-c="#c026d3" onclick="pickSCColor(this)"></div>
        <div class="cb" style="background:#000000" data-c="#000000" onclick="pickSCColor(this)"></div>
      </div>
      <div class="sc-input-area">
        <textarea class="sc-input" id="sc-text-inp" placeholder="Type a status‚Ä¶" rows="1" oninput="onSCTextInput(this)"></textarea>
      </div>
    </div>
    <div id="sc-photo-view" style="flex:1;display:none;flex-direction:column">
      <div class="sc-preview" id="sc-photo-preview" style="flex:1;cursor:pointer" onclick="document.getElementById('sc-photo-inp').click()">
        <div style="text-align:center;color:var(--text2)"><div style="font-size:60px">üì∑</div><div>Tap to add photo or video</div></div>
      </div>
      <input type="file" id="sc-photo-inp" accept="image/*,video/*" style="display:none" onchange="onSCMediaSelect(event)">
      <div class="sc-input-area">
        <input class="sc-input" id="sc-caption-inp" placeholder="Add a caption‚Ä¶" style="height:auto;padding:10px 16px">
      </div>
    </div>
  </div>
</div>

<!-- CALL OVERLAY -->
<div class="call-overlay" id="call-overlay">
  <video id="remote-video" autoplay playsinline></video>
  <video id="local-video" autoplay playsinline muted></video>
  <div class="call-bg-av" id="call-av">üë§</div>
  <div class="call-name-big" id="call-name">Name</div>
  <div class="call-status-txt" id="call-st">Calling‚Ä¶</div>
  <div class="call-actions-row">
    <div class="ca-btn"><button class="cab-mute" id="cab-mute" onclick="toggleMute()">üéôÔ∏è</button><span class="ca-lbl">Mute</span></div>
    <div class="ca-btn"><button class="cab-end" onclick="endCall()">üìµ</button><span class="ca-lbl">End</span></div>
    <div class="ca-btn"><button class="cab-speaker" id="cab-spk" onclick="toggleSpeaker()">üîà</button><span class="ca-lbl">Speaker</span></div>
  </div>
  <div class="incoming-row hidden" id="incoming-row">
    <div class="ca-btn"><button style="background:var(--red);width:64px;height:64px;border-radius:50%;border:none;cursor:pointer;font-size:26px" onclick="rejectCall()">üìµ</button><span class="ca-lbl" style="color:var(--text2)">Decline</span></div>
    <div class="ca-btn"><button class="cab-accept" style="width:64px;height:64px;border-radius:50%;border:none;cursor:pointer;font-size:26px" onclick="acceptCall()">üìû</button><span class="ca-lbl" style="color:var(--text2)">Accept</span></div>
  </div>
</div>

<!-- NOTIFICATION -->
<div class="notif" id="notif" onclick="openNotif()">
  <div class="notif-av" id="notif-av"></div>
  <div class="notif-body"><div class="nb-name" id="notif-name"></div><div class="nb-msg" id="notif-msg"></div></div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox" onclick="closeLB()">
  <button class="lb-close">‚úï</button>
  <div class="lb-content" id="lb-content" onclick="event.stopPropagation()"></div>
</div>

<!-- FILE INPUTS -->
<input type="file" id="file-inp" style="display:none" onchange="onFileSelect(event)">
<input type="file" id="cam-inp" capture="environment" accept="image/*" style="display:none" onchange="onFileSelect(event)">

<script>
const BASE = location.origin;
let token = localStorage.getItem('wa_token');
let me = JSON.parse(localStorage.getItem('wa_user') || 'null');
let socket = null;
let activeChat = null;
let replyMsg = null;
let ctxMsg = null;
let recorder = null, recChunks = [], recTimer = null, recSecs = 0;
let pc = null, localStream = null, callInfo = null;
let scColor = '#00a884', scType = 'text';
let svStatuses = [], svIdx = 0, svTimer = null;
let selGrpMembers = [];
let activeFilter = 'all';
let lockedChatIds = [];
let pinUnlocked = false;
let allChats = [], allGroups = [];
let typingTimer = null;
let isTyping = false;

// ===== INIT =====
window.onload = () => {
  if (token && me) showApp();
  buildEmojis();
  if ('Notification' in window) Notification.requestPermission();
};

function showApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  updateMyAv();
  initSocket();
  loadAll();
}

async function loadAll() {
  await Promise.all([loadChats(), loadContacts(), loadGroups()]);
  loadStatus();
  loadCalls();
  loadCommunities();
  loadChannels();
  loadLockedChats();
}

function logout() {
  token = null; me = null;
  localStorage.removeItem('wa_token'); localStorage.removeItem('wa_user');
  socket?.disconnect();
  document.getElementById('app').style.display = 'none';
  document.getElementById('auth-screen').style.display = 'flex';
  closeAllModals();
}

// ===== AUTH =====
function showReg() { document.getElementById('login-form').classList.add('hidden'); document.getElementById('reg-form').classList.remove('hidden'); }
function showLogin() { document.getElementById('reg-form').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden'); }

async function login() {
  const phone = v('lp'), password = v('lpw');
  try {
    const r = await api('/api/auth/login', 'POST', { phone, password }, false);
    setAuth(r);
  } catch(e) { showErr('lerr', e.message); }
}

async function register() {
  const name = v('rn'), phone = v('rp'), password = v('rpw');
  if (!name || !phone || !password) return showErr('rerr', 'All fields required');
  if (password.length < 6) return showErr('rerr', 'Password min 6 characters');
  try {
    const r = await api('/api/auth/register', 'POST', { name, phone, password }, false);
    setAuth(r);
  } catch(e) { showErr('rerr', e.message); }
}

function setAuth(r) {
  token = r.token; me = r.user;
  localStorage.setItem('wa_token', token);
  localStorage.setItem('wa_user', JSON.stringify(me));
  showApp();
}

// ===== API =====
async function api(url, method = 'GET', body = null, auth = true) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (auth) opts.headers['Authorization'] = 'Bearer ' + token;
  if (body) opts.body = JSON.stringify(body);
  const r = await fetch(BASE + url, opts);
  const d = await r.json();
  if (!r.ok) throw new Error(d.error || 'Error');
  return d;
}

async function apiForm(url, fd) {
  const r = await fetch(BASE + url, { method: 'POST', headers: { 'Authorization': 'Bearer ' + token }, body: fd });
  return r.json();
}

// ===== SOCKET =====
function initSocket() {
  socket = io(BASE, { auth: { token } });
  socket.on('new_message', msg => {
    if (activeChat && ((msg.sender_id === activeChat.id && msg.receiver_id === me.id) || (msg.sender_id === me.id && msg.receiver_id === activeChat.id))) {
      appendMsg(msg); socket.emit('messages_read', { senderId: msg.sender_id });
    }
    loadChats();
    if (msg.sender_id !== me.id) showNotif(msg);
  });
  socket.on('message_sent', msg => { if (activeChat && msg.receiver_id === activeChat.id && !document.querySelector(`[data-mid="${msg.id}"]`)) appendMsg(msg); loadChats(); });
  socket.on('new_group_message', msg => { if (activeChat?.type === 'group' && msg.group_id === activeChat.id) appendMsg(msg); loadChats(); });
  socket.on('user_status', ({ userId, is_online, last_seen }) => { if (activeChat?.id === userId) updateCHStatus(is_online, last_seen); });
  socket.on('user_typing', ({ userId }) => { if (activeChat?.id === userId) { const ti = document.getElementById('typing-ind'); if (ti) ti.style.display = 'block'; } });
  socket.on('user_stop_typing', ({ userId }) => { if (activeChat?.id === userId) { const ti = document.getElementById('typing-ind'); if (ti) ti.style.display = 'none'; } });
  socket.on('messages_read', ({ by }) => { if (activeChat?.id === by) document.querySelectorAll('.ticks').forEach(t => { t.classList.remove('sent','delivered'); t.classList.add('read'); t.textContent = '‚úì‚úì'; }); });
  socket.on('message_deleted', ({ id }) => { const el = document.querySelector(`[data-mid="${id}"]`); if (el) el.querySelector('.bi').innerHTML = '<span class="del-msg">üö´ This message was deleted</span>'; });
  socket.on('reaction_updated', () => { if (activeChat) loadMsgs(activeChat.id, activeChat.type); });
  socket.on('call_offer', handleInCall);
  socket.on('call_answer', async ({ answer }) => { await pc?.setRemoteDescription(new RTCSessionDescription(answer)); document.getElementById('call-st').textContent = 'Connected'; });
  socket.on('call_ice', async ({ candidate }) => { try { await pc?.addIceCandidate(new RTCIceCandidate(candidate)); } catch {} });
  socket.on('call_ended', () => endCall(true));
  socket.on('call_rejected', () => { alert('Call rejected'); endCall(true); });
}

// ===== CHATS =====
let contacts = [];
async function loadContacts() {
  try { contacts = await api('/api/contacts'); } catch {}
}

async function loadGroups() {
  try { allGroups = await api('/api/groups'); } catch {}
}

async function loadLockedChats() {
  try { const lc = await api('/api/locked-chats'); lockedChatIds = lc.map(l => l.chat_id); } catch {}
}

async function loadChats() {
  try {
    allChats = await api('/api/chats');
    renderChats();
  } catch {}
}

function renderChats() {
  const list = document.getElementById('tab-chats');
  const search = document.getElementById('search-inp').value.toLowerCase();
  const showLocked = pinUnlocked || !search;

  // Filter logic
  let chats = allChats.filter(c => {
    const isLocked = lockedChatIds.includes(c.other_user_id);
    if (isLocked && !pinUnlocked) return false; // hide locked if not unlocked
    if (search && !c.name?.toLowerCase().includes(search)) return false;
    if (activeFilter === 'unread' && !c.unread_count) return false;
    if (activeFilter === 'favorites') {
      const contact = contacts.find(ct => ct.id === c.other_user_id);
      if (!contact?.is_favorite) return false;
    }
    if (activeFilter === 'groups') return false;
    return true;
  });

  let groups = [];
  if (activeFilter === 'groups' || activeFilter === 'all') {
    groups = allGroups.filter(g => !search || g.name?.toLowerCase().includes(search));
  }

  list.innerHTML = '';

  // Locked chats section
  if (!pinUnlocked && lockedChatIds.length > 0) {
    const lh = document.createElement('div');
    lh.className = 'locked-chats-header';
    lh.innerHTML = `üîí <span>${lockedChatIds.length} locked chat${lockedChatIds.length > 1 ? 's' : ''}</span>`;
    lh.onclick = () => openPinVerify();
    list.appendChild(lh);
  }

  chats.forEach(c => {
    const item = mkChatItem(c.other_user_id, c.name, c.avatar, 'user', c);
    list.appendChild(item);
  });

  if (activeFilter === 'all' || activeFilter === 'groups') {
    groups.forEach(g => {
      const item = mkChatItem(g.id, g.name, g.avatar, 'group', null);
      list.appendChild(item);
    });
  }

  if (!chats.length && !groups.length) {
    list.innerHTML += '<div style="padding:32px;text-align:center;color:var(--text3);font-size:14px">No chats yet. Start a conversation!</div>';
  }
}

function mkChatItem(id, name, avatar, type, data) {
  const div = document.createElement('div');
  div.className = 'ci' + (activeChat?.id === id ? ' active' : '');
  div.onclick = () => openChat(id, name, avatar, type);

  const isLocked = lockedChatIds.includes(id);
  const time = data?.last_message_time ? fmtTime(data.last_message_time) : '';
  let last = '';
  if (data) {
    const isMe = data.last_sender_id === me.id;
    if (data.last_type === 'image') last = 'üì∑ Photo';
    else if (data.last_type === 'video') last = 'üìπ Video';
    else if (data.last_type === 'audio') last = 'üéµ Audio';
    else if (data.last_type === 'document') last = 'üìÑ Document';
    else last = (isMe ? 'You: ' : '') + (data.last_content || '');
  }

  div.innerHTML = `
    <div class="ci-av">${avHTML(avatar, name, 52)}${data?.is_online ? '<div class="od"></div>' : ''}</div>
    <div class="ci-body">
      <div class="ci-top">
        <div class="ci-name">${esc(name)}</div>
        <div class="ci-time" style="color:${data?.unread_count ? 'var(--green)' : ''}">${time}</div>
      </div>
      <div class="ci-bottom">
        ${isLocked ? '<span class="ci-lock">üîí</span>' : ''}
        <div class="ci-last">${esc(last)}</div>
        ${data?.unread_count ? `<div class="ci-badge">${data.unread_count}</div>` : ''}
      </div>
    </div>`;
  return div;
}

function setFilter(f, el) {
  activeFilter = f;
  document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  renderChats();
}

async function onSearchInput(val) {
  // Check if val matches the PIN for locked chats
  if (val && val.length >= 4) {
    try {
      const r = await api('/api/users/verify-pin', 'POST', { pin: val });
      if (r.valid) { pinUnlocked = true; renderChats(); return; }
    } catch {}
  }
  if (!val) pinUnlocked = false;
  renderChats();
}

// ===== OPEN CHAT =====
async function openChat(id, name, avatar, type = 'user') {
  activeChat = { id, name, avatar, type };
  if (window.innerWidth <= 768) document.getElementById('sidebar').classList.add('slide-out');

  const area = document.getElementById('chat-area');
  area.innerHTML = buildChatHTML(name, avatar, type);

  buildEmojis();

  if (type === 'user') {
    try { const u = await api('/api/users/' + id); updateCHStatus(u.is_online, u.last_seen); } catch {}
  } else {
    document.getElementById('ch-status').textContent = 'Group';
  }

  await loadMsgs(id, type);
  renderChats();
}

function buildChatHTML(name, avatar, type) {
  return `
  <div class="ch" id="chat-header">
    <button class="ch-back" onclick="goBack()">‚Üê</button>
    <div class="ch-av" onclick="openContactInfo()" id="ch-av">${avHTML(avatar, name, 40)}</div>
    <div class="ch-info" onclick="openContactInfo()">
      <div class="ch-name" id="ch-name">${esc(name)}</div>
      <div class="ch-status" id="ch-status">tap for info</div>
    </div>
    <div class="ch-actions">
      <button class="ibt" onclick="makeCall('video')" title="Video call"><svg viewBox="0 0 24 24"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg></button>
      <button class="ibt" onclick="makeCall('voice')" title="Voice call"><svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 11.5 19.79 19.79 0 01.01 2.88 2 2 0 012 .71h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L6.09 8.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg></button>
      <button class="ibt" onclick="toggleChatMenu()" title="More"><svg viewBox="0 0 24 24"><circle cx="12" cy="5" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="19" r="1.5"/></svg></button>
    </div>
  </div>
  <div class="msgs-area" id="msgs-area"></div>
  <div class="typing-ind" id="typing-ind" style="display:none">
    <div class="typing-bubble"><div class="td"></div><div class="td"></div><div class="td"></div></div>
  </div>
  <div class="reply-strip" id="reply-strip">
    <div class="rs-info"><div class="rs-auth" id="rs-auth"></div><div class="rs-txt" id="rs-txt"></div></div>
    <span class="rs-close" onclick="cancelReply()">‚úï</span>
  </div>
  <div class="inp-area">
    <div class="ia-ico" onclick="toggleEmoji()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="1.8"/><path d="M8 14s1.5 2 4 2 4-2 4-2M9 9h.01M15 9h.01" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg></div>
    <div class="ia-ico" onclick="toggleAttach()"><svg viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    <div class="rec-strip" id="rec-strip">
      <div class="rec-dot"></div>
      <div class="rec-t" id="rec-t">0:00</div>
      <span class="rec-x" onclick="cancelRec()">‚úï</span>
    </div>
    <div class="msg-box" id="msg-box">
      <textarea id="minput" rows="1" placeholder="Message" oninput="onMsgInput()" onkeydown="onMsgKey(event)"></textarea>
    </div>
    <button class="voice-b hidden" id="send-b" onclick="sendMsg()">
      <svg viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <button class="voice-b" id="voice-b" onclick="toggleRec()">
      <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2M12 19v4M8 23h8" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
  </div>
  <div class="emoji-picker" id="emoji-picker"><div class="eg" id="eg"></div></div>
  <div class="attach-menu" id="attach-menu">
    <div class="ao" onclick="trigFile('image/*')"><div class="ao-ico" style="background:#9c27b0">üñºÔ∏è</div><div class="ao-lbl">Photos</div></div>
    <div class="ao" onclick="trigFile('video/*')"><div class="ao-ico" style="background:#f44336">üìπ</div><div class="ao-lbl">Video</div></div>
    <div class="ao" onclick="trigFile('audio/*')"><div class="ao-ico" style="background:#2196f3">üéµ</div><div class="ao-lbl">Audio</div></div>
    <div class="ao" onclick="trigFile('*/*')"><div class="ao-ico" style="background:#4caf50">üìÑ</div><div class="ao-lbl">Document</div></div>
    <div class="ao" onclick="document.getElementById('cam-inp').click()"><div class="ao-ico" style="background:#ff9800">üì∑</div><div class="ao-lbl">Camera</div></div>
  </div>
  <input type="file" id="file-inp" style="display:none" onchange="onFileSelect(event)">`;
}

async function loadMsgs(id, type) {
  const area = document.getElementById('msgs-area');
  if (!area) return;
  try {
    const msgs = type === 'group' ? await api('/api/messages/group/' + id) : await api('/api/messages/' + id);
    area.innerHTML = '';
    let lastDate = '';
    msgs.forEach(m => {
      const d = new Date(m.created_at).toLocaleDateString();
      if (d !== lastDate) { area.appendChild(mkDateSep(d)); lastDate = d; }
      appendMsg(m, false);
    });
    scrollBottom();
  } catch(e) { console.error(e); }
}

function appendMsg(msg, scroll = true) {
  const area = document.getElementById('msgs-area');
  if (!area || document.querySelector(`[data-mid="${msg.id}"]`)) return;

  const isOut = msg.sender_id === me.id;
  const wrap = document.createElement('div');
  wrap.className = `mw ${isOut ? 'out' : 'in'}`;
  wrap.dataset.mid = msg.id;
  wrap.dataset.content = msg.content || '';
  wrap.dataset.type = msg.type || 'text';
  wrap.dataset.sender = msg.sender_id;
  wrap.dataset.sname = msg.sender_name || '';

  let html = '';
  if (!isOut) html += `<div class="m-grav">${avHTML(msg.sender_avatar, msg.sender_name, 28)}</div>`;

  let content = '';
  if (msg.deleted_for_everyone) {
    content = '<span class="del-msg">üö´ This message was deleted</span>';
  } else {
    if (msg.forwarded) content += '<div class="fwd-badge">‚Ü™Ô∏è Forwarded</div>';
    if (msg.reply_to && msg.reply_content !== undefined) content += `<div class="reply-q"><div class="rq-auth">${esc(msg.reply_sender_name||'')}</div><div class="rq-txt">${esc(msg.reply_content||'')}</div></div>`;
    if (activeChat?.type === 'group' && !isOut) content += `<div class="grp-sender" style="color:${nameColor(msg.sender_name)}">${esc(msg.sender_name||'')}</div>`;

    if (msg.type === 'image') content += `<img class="m-img" src="${msg.media_url}" onclick="openLB('image','${msg.media_url}')" loading="lazy">`;
    else if (msg.type === 'video') content += `<video class="m-vid" src="${msg.media_url}" controls onclick="openLB('video','${msg.media_url}')"></video>`;
    else if (msg.type === 'audio') content += `<audio class="m-aud" src="${msg.media_url}" controls></audio>`;
    else if (msg.type === 'document') { const fn = msg.media_url?.split('/').pop() || 'Document'; content += `<div class="m-doc" onclick="window.open('${msg.media_url}')"><div class="m-doc-ico">üìÑ</div><div class="m-doc-info"><div class="dn">${esc(fn)}</div><div class="ds">Tap to open</div></div></div>`; }
    else content += esc(msg.content||'').replace(/\n/g,'<br>');
  }

  const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const ticks = isOut && !msg.deleted_for_everyone ? `<span class="ticks sent">‚úì‚úì</span>` : '';
  const star = msg.starred ? '<span class="star-ico">‚≠ê</span>' : '';

  let reactions = '';
  if (msg.reactions?.length) {
    const grouped = {};
    msg.reactions.forEach(r => { grouped[r.emoji] = (grouped[r.emoji] || 0) + 1; });
    reactions = `<div class="reactions-row">${Object.entries(grouped).map(([e,c]) => `<div class="react-chip" onclick="openCtx(event,'${msg.id}')">${e}${c>1?`<span class="rc">${c}</span>`:''}</div>`).join('')}</div>`;
  }

  html += `<div class="bubble" oncontextmenu="openCtx(event,'${msg.id}')" ontouchstart="onTouchS(event,'${msg.id}')" ontouchend="onTouchE()">
    <div class="bi">${content}<div class="m-time">${star}${time}${ticks}</div></div>
    ${reactions}
  </div>`;

  wrap.innerHTML = html;
  area.appendChild(wrap);
  if (scroll) scrollBottom();
}

function mkDateSep(d) {
  const now = new Date().toLocaleDateString();
  const yest = new Date(Date.now()-86400000).toLocaleDateString();
  const div = document.createElement('div');
  div.className = 'date-sep';
  div.innerHTML = `<span>${d===now?'Today':d===yest?'Yesterday':d}</span>`;
  return div;
}

function scrollBottom() { const a = document.getElementById('msgs-area'); if (a) a.scrollTop = a.scrollHeight; }

// ===== SEND =====
async function sendMsg() {
  const inp = document.getElementById('minput');
  const txt = inp?.value.trim();
  if (!txt || !activeChat) return;
  inp.value = ''; autoResize(inp); onMsgInput();
  const body = { content: txt, type: 'text' };
  if (activeChat.type === 'group') body.group_id = activeChat.id; else body.receiver_id = activeChat.id;
  if (replyMsg) { body.reply_to = replyMsg.id; cancelReply(); }
  try { await api('/api/messages', 'POST', body); } catch(e) { console.error(e); }
}

async function sendFile(file, type) {
  if (!activeChat) return;
  const fd = new FormData();
  fd.append('media', file);
  fd.append('type', type);
  if (activeChat.type === 'group') fd.append('group_id', activeChat.id); else fd.append('receiver_id', activeChat.id);
  if (replyMsg) { fd.append('reply_to', replyMsg.id); cancelReply(); }
  try { await apiForm('/api/messages', fd); } catch(e) { console.error(e); }
}

function onFileSelect(e) {
  const file = e.target.files[0]; if (!file) return;
  let type = 'document';
  if (file.type.startsWith('image/')) type = 'image';
  else if (file.type.startsWith('video/')) type = 'video';
  else if (file.type.startsWith('audio/')) type = 'audio';
  sendFile(file, type);
  e.target.value = '';
}

function trigFile(acc) { closeMenus(); const el = document.getElementById('file-inp'); el.accept = acc; el.click(); }

// ===== INPUT =====
function onMsgInput() {
  const inp = document.getElementById('minput'); if (!inp) return;
  autoResize(inp);
  const has = inp.value.trim().length > 0;
  document.getElementById('send-b')?.classList.toggle('hidden', !has);
  document.getElementById('voice-b')?.classList.toggle('hidden', has);
  if (!isTyping && has) { isTyping = true; socket?.emit('typing', { to: activeChat?.id, isGroup: activeChat?.type==='group' }); }
  clearTimeout(typingTimer);
  typingTimer = setTimeout(() => { isTyping = false; socket?.emit('stop_typing', { to: activeChat?.id }); }, 2000);
}
function onMsgKey(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); } }
function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 130) + 'px'; }

// ===== CONTEXT MENU =====
let touchTimer = null;
function onTouchS(e, id) { touchTimer = setTimeout(() => openCtx(e, id), 600); }
function onTouchE() { clearTimeout(touchTimer); }

function openCtx(e, msgId) {
  e.preventDefault();
  ctxMsg = null;
  // Find msg in DOM
  const el = document.querySelector(`[data-mid="${msgId}"]`);
  if (el) {
    ctxMsg = { id: msgId, content: el.dataset.content, type: el.dataset.type, sender_id: el.dataset.sender, sender_name: el.dataset.sname };
  }
  const menu = document.getElementById('ctx-menu');
  menu.style.left = Math.min(e.clientX||100, window.innerWidth-200) + 'px';
  menu.style.top = Math.min(e.clientY||200, window.innerHeight-280) + 'px';
  menu.classList.add('open');
}

function ctxReply() {
  closeMenus();
  if (!ctxMsg) return;
  replyMsg = ctxMsg;
  const strip = document.getElementById('reply-strip');
  strip.style.display = 'flex';
  document.getElementById('rs-auth').textContent = ctxMsg.sender_id === me.id ? 'You' : ctxMsg.sender_name || 'User';
  document.getElementById('rs-txt').textContent = ctxMsg.content || '[Media]';
  document.getElementById('minput')?.focus();
}
function cancelReply() { replyMsg = null; const s = document.getElementById('reply-strip'); if (s) s.style.display = 'none'; }
function ctxCopy() { closeMenus(); navigator.clipboard.writeText(ctxMsg?.content || '').catch(()=>{}); }
function ctxForward() { closeMenus(); alert('Select a contact to forward to'); }
async function ctxStar() { closeMenus(); if (!ctxMsg) return; try { await api('/api/messages/'+ctxMsg.id+'/star','POST',{}); loadMsgs(activeChat.id,activeChat.type); } catch {} }
async function ctxDelete() {
  closeMenus();
  if (!ctxMsg) return;
  const fe = ctxMsg.sender_id === me.id && confirm('Delete for everyone?');
  try { await api('/api/messages/'+ctxMsg.id,'DELETE',{for_everyone:fe}); if (!fe) { document.querySelector(`[data-mid="${ctxMsg.id}"]`)?.remove(); } } catch {}
}
function ctxInfo() { closeMenus(); if (ctxMsg) alert('Sent at: ' + new Date().toLocaleString()); }

async function sendReact(emoji) {
  closeMenus();
  if (!ctxMsg) return;
  try { await api('/api/messages/'+ctxMsg.id+'/reaction','POST',{emoji}); } catch {}
}

// ===== VOICE RECORDING =====
async function toggleRec() {
  if (recorder?.state === 'recording') { stopRec(); return; }
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recorder = new MediaRecorder(stream); recChunks = [];
    recorder.ondataavailable = e => recChunks.push(e.data);
    recorder.onstop = sendVoice;
    recorder.start();
    document.getElementById('rec-strip').classList.add('show');
    document.getElementById('msg-box').style.display = 'none';
    document.getElementById('voice-b').classList.add('rec');
    recSecs = 0;
    recTimer = setInterval(() => { recSecs++; const m=Math.floor(recSecs/60),s=recSecs%60; document.getElementById('rec-t').textContent=`${m}:${s.toString().padStart(2,'0')}`; }, 1000);
  } catch { alert('Microphone access denied'); }
}
function stopRec() {
  recorder?.stop(); recorder?.stream?.getTracks().forEach(t=>t.stop());
  clearInterval(recTimer);
  document.getElementById('rec-strip').classList.remove('show');
  document.getElementById('msg-box').style.display = '';
  document.getElementById('voice-b').classList.remove('rec');
}
function cancelRec() { recChunks = []; stopRec(); }
function sendVoice() {
  if (!recChunks.length) return;
  const blob = new Blob(recChunks, { type: 'audio/webm' });
  sendFile(new File([blob], 'voice.webm', { type: 'audio/webm' }), 'audio');
}

// ===== EMOJI =====
const EMOJIS = 'üòÄüòÉüòÑüòÅüòÜüòÖü§£üòÇüôÇüôÉüòâüòäüòáü•∞üòçü§©üòòüòóüòöüòôüòãüòõüòúü§™üòùü§ëü§óü§≠ü§´ü§îüòêüòëüò∂üòèüòíüôÑüò¨ü§•üòåüòîüò™ü§§üò¥üò∑ü§íü§ïü§¢ü§Æü§ßü•µü•∂üòµü§Øü§†ü•≥üòéü§ìüßêüòïüòüüôÅ‚òπÔ∏èüòÆüòØüò≤üò≥ü•∫üò¶üòßüò®üò∞üò•üò¢üò≠üò±üòñüò£üòûüòìüò©üò´ü•±üò§üò°üò†ü§¨üòàüëøüíÄ‚ò†Ô∏èüëãü§ö‚úãüëå‚úåÔ∏èü§ûüëçüëé‚ù§Ô∏èüß°üíõüíöüíôüíúüñ§üíîüíïüíØüéâüéäüéàüî•üíßüåäüçéüçïüçîüçüüåÆüç∞üéÇ‚òïüç∫üéÆüéØüèÜü•áüéµüé∂üé§üì±üíªüì∑üî•üí°üåà‚≠êüåô‚òÄÔ∏èüå∏üå∫ü¶ãüê∂üê±üêòü¶Åüåçüè†üöÄ‚úàÔ∏èüöóüé∏üéπ‚ùì‚úÖüôè';

function buildEmojis() {
  const eg = document.getElementById('eg'); if (!eg) return;
  eg.innerHTML = [...EMOJIS].map(e => `<div class="ei" onclick="insertEmoji('${e}')">${e}</div>`).join('');
}
function insertEmoji(e) {
  const inp = document.getElementById('minput'); if (!inp) return;
  const p = inp.selectionStart; inp.value = inp.value.slice(0,p)+e+inp.value.slice(p);
  inp.selectionStart = inp.selectionEnd = p+e.length; inp.focus(); onMsgInput();
}
function toggleEmoji() { const p = document.getElementById('emoji-picker'); document.getElementById('attach-menu')?.classList.remove('open'); p?.classList.toggle('open'); }
function toggleAttach() { const a = document.getElementById('attach-menu'); document.getElementById('emoji-picker')?.classList.remove('open'); a?.classList.toggle('open'); }

document.addEventListener('click', e => {
  if (!e.target.closest('.ctx')) { document.getElementById('ctx-menu')?.classList.remove('open'); document.getElementById('main-menu')?.classList.remove('open'); document.getElementById('chat-menu')?.classList.remove('open'); }
  if (!e.target.closest('.emoji-picker') && !e.target.closest('.ia-ico:first-child')) document.getElementById('emoji-picker')?.classList.remove('open');
  if (!e.target.closest('.attach-menu') && !e.target.closest('.ia-ico:nth-child(2)')) document.getElementById('attach-menu')?.classList.remove('open');
});

// ===== STATUS =====
let myStatuses = [], othersStatuses = [];

async function loadStatus() {
  try {
    const all = await api('/api/status');
    myStatuses = all.filter(s => s.user_id === me.id);
    const others = all.filter(s => s.user_id !== me.id);
    const byUser = {};
    others.forEach(s => { if (!byUser[s.user_id]) byUser[s.user_id] = []; byUser[s.user_id].push(s); });
    othersStatuses = Object.values(byUser);
    renderUpdates();
  } catch {}
}

function renderUpdates() {
  const screen = document.getElementById('tab-updates');
  const now = Date.now();

  let html = `<div class="status-my-card" onclick="myStatuses.length?viewStatus([...myStatuses],'${esc(me.name)}','${me.avatar||''}'):openStatusCreate()">
    <div class="status-av-wrap">
      <div class="status-av">${avHTML(me.avatar, me.name, 52)}</div>
      <div class="status-add-badge">+</div>
    </div>
    <div>
      <div style="font-size:15px;color:var(--text);margin-bottom:3px">My status</div>
      <div style="font-size:13px;color:var(--text2)">${myStatuses.length ? `${myStatuses.length} update${myStatuses.length>1?'s':''}` : 'Tap to add status update'}</div>
    </div>
  </div>`;

  if (othersStatuses.length) {
    html += '<div class="updates-section-title">Recent updates</div>';
    othersStatuses.forEach(userStatuses => {
      const s = userStatuses[0];
      const viewed = userStatuses.every(st => JSON.parse(st.views||'[]').includes(me.id));
      html += `<div class="status-card" onclick="viewStatus(${JSON.stringify(userStatuses).replace(/"/g,'&quot;')}, '${esc(s.name)}', '${s.avatar||''}')">
        <div class="status-ring ${viewed?'viewed':''}">
          <div class="status-av" style="width:48px;height:48px">${avHTML(s.avatar, s.name, 48)}</div>
        </div>
        <div class="status-info">
          <div class="sn">${esc(s.name)}</div>
          <div class="st">${fmtTime(s.created_at)}</div>
        </div>
      </div>`;
    });
  }

  // Channels section
  html += `<div style="border-top:8px solid var(--panel2);margin-top:4px"></div>`;
  html += '<div class="updates-section-title">Channels <button class="explore-btn" style="float:right;margin-top:-4px" onclick="loadChannels()">Explore</button></div>';
  html += '<div id="channels-list"></div>';

  screen.innerHTML = html;
  loadChannels();
}

async function loadChannels() {
  try {
    const { following, suggested } = await api('/api/channels');
    const list = document.getElementById('channels-list');
    if (!list) return;
    let html = '';
    [...following, ...suggested].forEach(ch => {
      const isFollowing = following.some(f => f.id === ch.id);
      const fCount = ch.followers_count >= 1000000 ? (ch.followers_count/1000000).toFixed(1)+'M' : ch.followers_count >= 1000 ? (ch.followers_count/1000).toFixed(0)+'K' : ch.followers_count;
      html += `<div class="channel-card">
        <div class="channel-av">${avHTML(ch.avatar, ch.name, 48)}</div>
        <div class="channel-info">
          <div class="cn">${esc(ch.name)}${ch.verified?'<span class="verified-badge">‚úì</span>':''}</div>
          <div class="cf">${fCount} followers</div>
        </div>
        <button class="follow-btn ${isFollowing?'following':''}" onclick="followChannel('${ch.id}',this)">${isFollowing?'Following':'Follow'}</button>
      </div>`;
    });
    list.innerHTML = html || '<div style="padding:16px;text-align:center;color:var(--text3)">No channels yet</div>';
  } catch {}
}

async function followChannel(id, btn) {
  try { await api('/api/channels/'+id+'/follow','POST',{}); btn.textContent='Following'; btn.classList.add('following'); } catch {}
}

// ===== STATUS VIEWER =====
function viewStatus(statuses, name, avatar) {
  if (typeof statuses === 'string') statuses = JSON.parse(statuses);
  svStatuses = statuses; svIdx = 0;
  document.getElementById('sv-name').textContent = name;
  document.getElementById('sv-av').innerHTML = avHTML(avatar, name, 38);
  document.getElementById('sv-overlay').classList.add('open');
  showSVAt(0);
}

function showSVAt(idx) {
  clearTimeout(svTimer);
  if (idx >= svStatuses.length) { closeSV(); return; }
  svIdx = idx;
  const s = svStatuses[idx];
  api('/api/status/'+s.id+'/view','POST',{}).catch(()=>{});
  document.getElementById('sv-time').textContent = fmtTime(s.created_at);

  const prog = document.getElementById('sv-prog');
  prog.innerHTML = svStatuses.map((_,i) => `<div class="sv-seg"><div class="sf" id="sf-${i}"></div></div>`).join('');
  for (let i=0;i<idx;i++) { const f=document.getElementById('sf-'+i); if(f) f.style.width='100%'; }

  const dur = s.type==='video'?10000:5000;
  const fill = document.getElementById('sf-'+idx);
  if (fill) { fill.style.transition=`width ${dur}ms linear`; setTimeout(()=>fill.style.width='100%',50); }

  const content = document.getElementById('sv-content');
  if (s.type === 'text') {
    content.style.background = s.bg_color || '#00a884';
    content.innerHTML = `<div class="sv-text-content">${esc(s.content||'')}</div>`;
  } else if (s.type === 'image') {
    content.style.background = '#000';
    content.innerHTML = `<img src="${s.media_url}">${s.content?`<div class="sv-caption">${esc(s.content)}</div>`:''}`;
  } else if (s.type === 'video') {
    content.style.background = '#000';
    content.innerHTML = `<video src="${s.media_url}" autoplay controls style="max-width:100%;max-height:80vh">${s.content?`<div class="sv-caption">${esc(s.content)}</div>`:''}</video>`;
  }

  svTimer = setTimeout(() => showSVAt(idx+1), dur);
}

function svPrev() { showSVAt(Math.max(0, svIdx-1)); }
function svNext() { showSVAt(svIdx+1); }
function closeSV() { clearTimeout(svTimer); document.getElementById('sv-overlay').classList.remove('open'); }
function sendSVReply() { const v = document.getElementById('sv-reply-inp').value.trim(); if (v) { alert('Replied: ' + v); document.getElementById('sv-reply-inp').value=''; } }

// ===== STATUS CREATE =====
function openStatusCreate() { closeMenus(); document.getElementById('sc-overlay').classList.add('open'); }
function closeSC() { document.getElementById('sc-overlay').classList.remove('open'); }

function setSCType(t) {
  scType = t;
  document.getElementById('sct-text').style.cssText = t==='text' ? 'flex:1;padding:12px;text-align:center;font-size:14px;font-weight:500;cursor:pointer;border-bottom:2px solid var(--green);color:var(--green)' : 'flex:1;padding:12px;text-align:center;font-size:14px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;color:var(--text2)';
  document.getElementById('sct-photo').style.cssText = t==='photo' ? 'flex:1;padding:12px;text-align:center;font-size:14px;font-weight:500;cursor:pointer;border-bottom:2px solid var(--green);color:var(--green)' : 'flex:1;padding:12px;text-align:center;font-size:14px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;color:var(--text2)';
  document.getElementById('sc-text-view').style.display = t==='text'?'flex':'none';
  document.getElementById('sc-photo-view').style.display = t==='photo'?'flex':'none';
}

function pickSCColor(el) {
  document.querySelectorAll('.cb').forEach(c=>c.classList.remove('sel'));
  el.classList.add('sel'); scColor = el.dataset.c;
  const prev = document.getElementById('sc-text-prev');
  if (prev) prev.style.background = scColor;
}

function onSCTextInput(el) {
  const prev = document.getElementById('sc-text-prev');
  if (prev) prev.textContent = el.value || 'Your text here‚Ä¶';
}

function onSCMediaSelect(e) {
  const file = e.target.files[0]; if (!file) return;
  const url = URL.createObjectURL(file);
  const prev = document.getElementById('sc-photo-preview');
  if (file.type.startsWith('image/')) prev.innerHTML = `<img src="${url}" style="max-width:100%;max-height:55vh;border-radius:8px;object-fit:contain">`;
  else prev.innerHTML = `<video src="${url}" controls style="max-width:100%;max-height:55vh;border-radius:8px"></video>`;
}

async function postStatus() {
  const fd = new FormData();
  if (scType === 'text') {
    const txt = document.getElementById('sc-text-inp')?.value.trim();
    if (!txt) return alert('Please type something');
    fd.append('content', txt); fd.append('type', 'text'); fd.append('bg_color', scColor);
  } else {
    const file = document.getElementById('sc-photo-inp')?.files[0];
    if (!file) return alert('Please select a photo or video');
    fd.append('media', file); fd.append('type', file.type.startsWith('video')?'video':'image');
    const cap = document.getElementById('sc-caption-inp')?.value.trim();
    if (cap) fd.append('content', cap);
  }
  try { await apiForm('/api/status', fd); closeSC(); loadStatus(); document.getElementById('sc-text-inp').value=''; document.getElementById('sc-photo-inp').value=''; document.getElementById('sc-photo-preview').innerHTML='<div style="text-align:center;color:var(--text2)"><div style="font-size:60px">üì∑</div><div>Tap to add photo or video</div></div>'; } catch(e) { alert(e.message); }
}

// ===== COMMUNITIES =====
async function loadCommunities() {
  try {
    const comms = await api('/api/communities');
    const screen = document.getElementById('tab-communities');
    let html = `<div class="new-comm" onclick="openNewCommModal()">
      <div class="new-comm-ico">üèòÔ∏è<div class="new-comm-plus">+</div></div>
      <div><div style="font-size:16px;color:var(--text);margin-bottom:3px">New community</div><div style="font-size:13px;color:var(--text2)">Create a community with groups</div></div>
    </div>`;
    comms.forEach(c => {
      html += `<div class="comm-item">
        <div class="comm-av">${avHTML(c.avatar, c.name, 52)}</div>
        <div class="comm-info">
          <div class="comm-name">${esc(c.name)}</div>
          <div class="comm-desc">${esc(c.description)||'Community'}</div>
          <div class="comm-groups"><div class="cg-chip">üë• Announcements</div></div>
        </div>
      </div>`;
    });
    if (!comms.length) html += '<div style="padding:24px;text-align:center;color:var(--text3);font-size:14px">No communities yet. Create one to connect groups!</div>';
    screen.innerHTML = html;
  } catch {}
}

async function createCommunity() {
  const name = v('cname');
  if (!name) return alert('Enter community name');
  try {
    const fd = new FormData(); fd.append('name', name); fd.append('description', v('cdesc'));
    await apiForm('/api/communities', fd);
    closeModal('new-comm-modal'); loadCommunities();
  } catch(e) { alert(e.message); }
}

// ===== CALLS =====
async function loadCalls() {
  try {
    const calls = await api('/api/calls');
    const screen = document.getElementById('tab-calls');
    const favs = contacts.slice(0, 5);
    let html = '';
    if (favs.length) {
      html += `<div class="calls-fav"><div class="calls-fav-title">Favorites</div><div class="calls-fav-row">`;
      favs.forEach(c => { html += `<div class="fav-item" onclick="openChat('${c.id}','${esc(c.name)}','${c.avatar||''}','user')"><div class="fav-av">${avHTML(c.avatar,c.name,52)}</div><div class="fav-name">${esc(c.name?.split(' ')[0])}</div></div>`; });
      html += '</div></div>';
    }
    html += '<div class="calls-list-title">Recent</div>';
    calls.forEach(c => {
      const isOut = c.caller_id === me.id;
      const isMissed = c.status === 'missed' && !isOut;
      const arrow = isMissed ? '‚ÜôÔ∏è' : isOut ? '‚ÜóÔ∏è' : '‚ÜôÔ∏è';
      const clr = isMissed ? 'var(--red)' : 'var(--green)';
      html += `<div class="call-item">
        <div class="call-av">${avHTML(c.other_avatar,c.other_name,48)}</div>
        <div class="call-info">
          <div class="call-name" style="color:${isMissed?'var(--red)':'var(--text)'}">${esc(c.other_name)}</div>
          <div class="call-detail"><span style="color:${clr}">${arrow}</span><span style="color:var(--text2)">${c.type==='video'?'üìπ Video':'üìû Voice'} ¬∑ ${fmtTime(c.created_at)}</span></div>
        </div>
        <div class="call-type-btn" onclick="makeCallTo('${c.receiver_id===me.id?c.caller_id:c.receiver_id}','${esc(c.other_name)}','${c.other_avatar||''}','${c.type}')">${c.type==='video'?'üìπ':'üìû'}</div>
      </div>`;
    });
    if (!calls.length) html += '<div style="padding:32px;text-align:center;color:var(--text3);font-size:14px">No recent calls</div>';
    screen.innerHTML = html;
  } catch {}
}

// ===== CALLS (WebRTC) =====
async function makeCall(type) { if (!activeChat) return; makeCallTo(activeChat.id, activeChat.name, activeChat.avatar, type); }

async function makeCallTo(id, name, avatar, type) {
  callInfo = { to: id, type, outgoing: true };
  showCallScreen(name, avatar, 'Calling‚Ä¶', type, false);
  try {
    localStream = await navigator.mediaDevices.getUserMedia(type==='video' ? {video:true,audio:true} : {audio:true});
    if (type==='video') { const lv=document.getElementById('local-video'); lv.srcObject=localStream; lv.style.display='block'; }
    pc = mkPC();
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit('call_offer', { to: id, offer, type });
    await api('/api/calls','POST',{receiver_id:id,type,status:'outgoing'}).catch(()=>{});
  } catch { alert('Cannot access camera/microphone'); endCall(true); }
}

function mkPC() {
  const p = new RTCPeerConnection({ iceServers: [{urls:'stun:stun.l.google.com:19302'}] });
  p.onicecandidate = e => { if (e.candidate) socket.emit('call_ice', { to: callInfo?.to||callInfo?.from, candidate: e.candidate }); };
  p.ontrack = e => { const rv=document.getElementById('remote-video'); rv.srcObject=e.streams[0]; rv.style.display='block'; document.getElementById('call-av').style.display='none'; };
  return p;
}

async function handleInCall({ from, offer, type }) {
  callInfo = { from, type, offer, outgoing: false };
  try { const u = await api('/api/users/'+from); showCallScreen(u.name, u.avatar, `Incoming ${type} call`, type, true); }
  catch { showCallScreen('Unknown', null, `Incoming ${type} call`, type, true); }
}

async function acceptCall() {
  document.getElementById('incoming-row').classList.add('hidden');
  document.getElementById('call-st').textContent = 'Connected';
  try {
    localStream = await navigator.mediaDevices.getUserMedia(callInfo.type==='video'?{video:true,audio:true}:{audio:true});
    if (callInfo.type==='video') { const lv=document.getElementById('local-video'); lv.srcObject=localStream; lv.style.display='block'; }
    pc = mkPC();
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
    await pc.setRemoteDescription(new RTCSessionDescription(callInfo.offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit('call_answer', { to: callInfo.from, answer });
  } catch { endCall(true); }
}

function rejectCall() { socket.emit('call_reject', { to: callInfo?.from }); endCall(true); }
function endCall(silent=false) {
  if (!silent && callInfo) socket.emit('call_end', { to: callInfo.to||callInfo.from });
  pc?.close(); pc = null;
  localStream?.getTracks().forEach(t=>t.stop()); localStream = null;
  document.getElementById('call-overlay').classList.remove('open');
  document.getElementById('local-video').style.display='none';
  document.getElementById('remote-video').style.display='none';
  document.getElementById('call-av').style.display='flex';
  callInfo = null;
}

function toggleMute() { if (localStream) { const e=localStream.getAudioTracks()[0]?.enabled; localStream.getAudioTracks().forEach(t=>t.enabled=!e); document.getElementById('cab-mute').textContent=e?'üîá':'üéôÔ∏è'; } }
function toggleSpeaker() { document.getElementById('cab-spk').textContent='üîä'; }

function showCallScreen(name, avatar, status, type, incoming) {
  const o = document.getElementById('call-overlay'); o.classList.add('open');
  document.getElementById('call-name').textContent = name;
  document.getElementById('call-st').textContent = status;
  document.getElementById('call-av').innerHTML = avHTML(avatar, name, 110);
  document.getElementById('incoming-row').classList.toggle('hidden', !incoming);
}

// ===== PROFILE =====
function openProfile() {
  closeMenus();
  document.getElementById('p-name').textContent = me.name;
  document.getElementById('p-phone').textContent = me.phone;
  document.getElementById('p-about').textContent = me.about || '';
  document.getElementById('pal').innerHTML = avHTML(me.avatar, me.name, 96) + '<div class="profile-av-overlay">üì∑</div>';
  openModal('profile-modal');
}

async function uploadAvatar(e) {
  const file = e.target.files[0]; if (!file) return;
  const fd = new FormData(); fd.append('avatar', file);
  try { const r = await apiForm('/api/users/avatar', fd); me.avatar = r.avatar; localStorage.setItem('wa_user', JSON.stringify(me)); updateMyAv(); openProfile(); } catch {}
}

function updateMyAv() { const el = document.getElementById('my-av'); if (el) el.innerHTML = avHTML(me?.avatar, me?.name, 38); }

async function editField(field) {
  const val = prompt(`Edit ${field}:`, me[field] || '');
  if (val === null) return;
  try { await api('/api/users/me','PUT',{name:field==='name'?val:me.name,about:field==='about'?val:me.about}); me[field]=val; localStorage.setItem('wa_user',JSON.stringify(me)); openProfile(); } catch {}
}

// ===== CONTACT INFO =====
async function openContactInfo() {
  if (!activeChat || activeChat.type !== 'user') return;
  try {
    const u = await api('/api/users/'+activeChat.id);
    document.getElementById('cpal').innerHTML = avHTML(u.avatar, u.name, 96);
    document.getElementById('c-name').textContent = u.name;
    document.getElementById('c-phone').textContent = u.phone;
    document.getElementById('c-about').textContent = u.about || '';
    document.getElementById('c-lastseen').textContent = u.is_online ? 'Online' : fmtTime(u.last_seen);
    openModal('contact-modal');
  } catch {}
}

// ===== NEW CHAT =====
function openNewChat() { closeMenus(); document.getElementById('nc-search').value=''; document.getElementById('nc-results').innerHTML=''; openModal('new-chat-modal'); }

let searchTimer = null;
async function searchPeople(q) {
  clearTimeout(searchTimer);
  if (!q || q.length < 2) { document.getElementById('nc-results').innerHTML=''; return; }
  searchTimer = setTimeout(async () => {
    try {
      const users = await api('/api/users/search?q='+encodeURIComponent(q));
      const res = document.getElementById('nc-results');
      res.innerHTML = users.map(u => `<div class="sr-item" onclick="startChat('${u.id}','${esc(u.name)}','${u.avatar||''}')">
        <div class="ci-av" style="width:44px;height:44px;flex-shrink:0">${avHTML(u.avatar,u.name,44)}</div>
        <div><div style="font-weight:500">${esc(u.name)}</div><div style="font-size:13px;color:var(--text2)">${u.phone}</div></div>
      </div>`).join('') || '<div style="padding:12px;text-align:center;color:var(--text3)">No users found</div>';
    } catch {}
  }, 300);
}

async function startChat(id, name, avatar) {
  try { await api('/api/contacts','POST',{contact_id:id}).catch(()=>{}); } catch {}
  closeModal('new-chat-modal');
  openChat(id, name, avatar, 'user');
  loadContacts();
}

// ===== GROUPS =====
function openNewGroupModal() { closeMenus(); selGrpMembers=[]; document.getElementById('sel-members').innerHTML=''; document.getElementById('gname').value=''; document.getElementById('gmem-search').value=''; openModal('new-group-modal'); }
function openNewCommModal() { closeMenus(); openModal('new-comm-modal'); }

async function searchGrpMembers(q) {
  if (!q||q.length<2) { document.getElementById('gmem-results').innerHTML=''; return; }
  try {
    const users = await api('/api/users/search?q='+encodeURIComponent(q));
    document.getElementById('gmem-results').innerHTML = users.map(u => `<div class="sr-item" onclick="addGrpMember({id:'${u.id}',name:'${esc(u.name)}',avatar:'${u.avatar||''}'})">${avHTML(u.avatar,u.name,40)}<div style="margin-left:12px"><div style="font-weight:500">${esc(u.name)}</div></div></div>`).join('');
  } catch {}
}

function addGrpMember(user) {
  if (selGrpMembers.find(m=>m.id===user.id)) return;
  selGrpMembers.push(user);
  const c = document.getElementById('sel-members');
  const chip = document.createElement('div');
  chip.className='mchip'; chip.dataset.id=user.id;
  chip.innerHTML=`${esc(user.name)}<span class="mcx" onclick="rmGrpMember('${user.id}')">‚úï</span>`;
  c.appendChild(chip);
  document.getElementById('gmem-search').value='';
  document.getElementById('gmem-results').innerHTML='';
}

function rmGrpMember(id) { selGrpMembers=selGrpMembers.filter(m=>m.id!==id); document.querySelector(`#sel-members [data-id="${id}"]`)?.remove(); }

async function createGroup() {
  const name = v('gname'); if (!name) return alert('Enter group name');
  try {
    const fd = new FormData(); fd.append('name',name); fd.append('members',JSON.stringify(selGrpMembers.map(m=>m.id)));
    await apiForm('/api/groups', fd);
    closeModal('new-group-modal'); selGrpMembers=[]; loadGroups(); loadChats();
  } catch(e) { alert(e.message); }
}

// ===== LOCK/PIN =====
function openPinSetup() { closeMenus(); openModal('pin-modal'); }

async function savePin() {
  const pin = v('pin-inp'); if (!pin || pin.length < 4) return alert('PIN must be at least 4 digits');
  try { await api('/api/users/set-pin','POST',{pin}); alert('PIN set! Type it in the search bar to unlock hidden chats.'); closeModal('pin-modal'); } catch(e) { alert(e.message); }
}

async function removePin() {
  if (!confirm('Remove PIN?')) return;
  try { await api('/api/users/set-pin','POST',{pin:null}); alert('PIN removed'); closeModal('pin-modal'); } catch {}
}

async function openPinVerify() {
  const pin = prompt('Enter your PIN to unlock hidden chats:');
  if (!pin) return;
  try {
    const r = await api('/api/users/verify-pin','POST',{pin});
    if (r.valid) { pinUnlocked = true; renderChats(); }
    else alert('Incorrect PIN');
  } catch {}
}

async function lockChat() {
  if (!activeChat) return;
  try {
    await api('/api/locked-chats','POST',{chat_id:activeChat.id,chat_type:activeChat.type});
    await loadLockedChats(); renderChats();
    alert('Chat locked! Type your PIN in search to reveal it.');
  } catch(e) { alert(e.message || 'Set a PIN first in menu ‚Üí Locked chats'); }
}

// ===== TABS =====
function switchTab(tab) {
  ['chats','updates','communities','calls'].forEach(t => {
    document.getElementById(`tab-${t}`)?.classList.toggle('hidden', t!==tab);
    document.getElementById(`bn-${t}`)?.classList.toggle('active', t===tab);
  });
  const fp = document.getElementById('filter-pills');
  if (fp) fp.style.display = tab==='chats'?'flex':'none';

  if (tab==='updates') loadStatus();
  if (tab==='calls') loadCalls();
  if (tab==='communities') loadCommunities();
}

// ===== NOTIFICATIONS =====
function showNotif(msg) {
  const n = document.getElementById('notif');
  document.getElementById('notif-name').textContent = msg.sender_name || 'New message';
  document.getElementById('notif-msg').textContent = msg.type==='text' ? (msg.content||'') : 'üì∑ Media';
  document.getElementById('notif-av').innerHTML = avHTML(msg.sender_avatar, msg.sender_name, 40);
  n.dataset.sid = msg.sender_id; n.dataset.sname = msg.sender_name; n.dataset.sav = msg.sender_avatar||'';
  n.classList.add('show');
  setTimeout(()=>n.classList.remove('show'), 4000);
  if ('Notification' in window && Notification.permission==='granted') new Notification(msg.sender_name||'New message',{body:msg.content||'Sent media'}).catch(()=>{});
}

function openNotif() {
  const n = document.getElementById('notif'); n.classList.remove('show');
  const id=n.dataset.sid, name=n.dataset.sname, av=n.dataset.sav;
  if (id) openChat(id, name, av, 'user');
}

// ===== LIGHTBOX =====
function openLB(type, url) {
  const lb = document.getElementById('lightbox'); lb.classList.add('open');
  document.getElementById('lb-content').innerHTML = type==='image' ? `<img src="${url}">` : `<video src="${url}" controls autoplay></video>`;
}
function closeLB() { document.getElementById('lightbox').classList.remove('open'); document.getElementById('lb-content').innerHTML=''; }

// ===== STARRED =====
async function showStarred() { try { const msgs = await api('/api/messages/starred').catch(()=>[]); alert(msgs.length ? 'Starred:\n'+msgs.map(m=>m.content||'[Media]').join('\n') : 'No starred messages'); } catch {} }

// ===== MISC =====
function goBack() { document.getElementById('sidebar').classList.remove('slide-out'); activeChat=null; }
function clearChatMsgs() { const a=document.getElementById('msgs-area'); if(a)a.innerHTML=''; }
function updateCHStatus(online, ls) { const el=document.getElementById('ch-status'); if(!el)return; el.textContent=online?'online':ls?'last seen '+fmtTime(ls):'last seen recently'; el.style.color=online?'var(--green)':''; }

function toggleMainMenu() { const m=document.getElementById('main-menu'); m.classList.toggle('open'); }
function toggleChatMenu() { const m=document.getElementById('chat-menu'); m.classList.toggle('open'); }
function closeMenus() { document.querySelectorAll('.ctx').forEach(m=>{m.classList.remove('open');m.style.display='';}); }
function closeAllModals() { document.querySelectorAll('.modal-bg').forEach(m=>m.classList.remove('open')); }

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-bg').forEach(bg => bg.addEventListener('click', e => { if(e.target===bg) bg.classList.remove('open'); }));

// ===== HELPERS =====
const COLORS = ['#c0392b','#8e44ad','#2980b9','#16a085','#d35400','#27ae60','#2c3e50','#f39c12'];
function nameColor(name) { return COLORS[(name?.charCodeAt(0)||0)%COLORS.length]; }

function avHTML(url, name, size) {
  const color = COLORS[((name||'?').charCodeAt(0))%COLORS.length];
  const letter = (name||'?')[0].toUpperCase();
  const fs = Math.floor(size*0.4);
  if (url) return `<img src="${url}" style="width:${size}px;height:${size}px;border-radius:50%;object-fit:cover" onerror="this.outerHTML='<div class=\\'avph\\' style=\\'background:${color};width:${size}px;height:${size}px;border-radius:50%;font-size:${fs}px\\'>${letter}</div>'">`;
  return `<div class="avph" style="background:${color};width:${size}px;height:${size}px;border-radius:50%;font-size:${fs}px">${letter}</div>`;
}

function esc(t) { if(!t)return''; return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function v(id) { return document.getElementById(id)?.value?.trim()||''; }
function showErr(id, msg) { const el=document.getElementById(id); if(el){el.textContent=msg;el.style.display='block';} }

function fmtTime(ds) {
  if (!ds) return '';
  const d = new Date(ds), now = new Date(), diff = now-d;
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff/60000)+'m ago';
  if (d.toDateString()===now.toDateString()) return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  const y = new Date(now); y.setDate(y.getDate()-1);
  if (d.toDateString()===y.toDateString()) return 'Yesterday';
  return d.toLocaleDateString();
}
</script>
</body>
</html>
